<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EatlyHub | All-in-One Food Platform</title>
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/3075/3075977.png">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>

    <style>
        :root {
            --primary: #ff4757; /* EatlyHub Red */
            --secondary: #2f3542;
            --green: #2ed573;
            --yellow: #ffa502;
            --bg: #f1f2f6;
            --white: #ffffff;
            --font: 'Segoe UI', sans-serif;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; font-family: var(--font); background: var(--bg); color: var(--secondary); font-size: 14px; }

        /* UTILITIES */
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .center { align-items: center; justify-content: center; }
        .justify-between { justify-content: space-between; }
        .w-100 { width: 100%; }
        .hidden { display: none !important; }
        .mt-1 { margin-top: 0.5rem; }
        .mt-2 { margin-top: 1rem; }
        .p-1 { padding: 0.5rem; }
        .p-2 { padding: 1rem; }
        .text-center { text-align: center; }
        .text-red { color: var(--primary); }
        .text-green { color: var(--green); }
        .bold { font-weight: bold; }
        
        /* RESPONSIVE 300px adjustments */
        @media (max-width: 320px) {
            body { font-size: 12px; }
            h1 { font-size: 1.5rem; }
            .btn { padding: 8px 10px !important; }
        }

        /* BUTTONS */
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.2s; width: 100%; text-align: center; margin-bottom: 5px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: var(--secondary); color: white; }
        .btn-green { background: var(--green); color: white; }
        .btn-yellow { background: var(--yellow); color: white; }
        .btn-outline { border: 1px solid var(--primary); color: var(--primary); background: transparent; }

        /* CARDS & INPUTS */
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 15px; border-left: 5px solid transparent; }
        .input-group { margin-bottom: 15px; text-align: left; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9rem; }
        .input-group input, .input-group select, .input-group textarea { width: 100%; padding: 12px; border: 1px solid #dfe4ea; border-radius: 8px; font-size: 1rem; }
        
        /* HEADER & NAV */
        nav { background: white; padding: 10px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .nav-brand { display: flex; align-items: center; gap: 10px; font-size: 1.2rem; font-weight: bold; color: var(--primary); }
        .nav-logo { width: 40px; height: 40px; }
        
        /* DASHBOARD TABS */
        .tabs-container { overflow-x: auto; white-space: nowrap; background: white; padding: 0 10px; border-bottom: 1px solid #eee; -ms-overflow-style: none; scrollbar-width: none; }
        .tabs-container::-webkit-scrollbar { display: none; }
        .tab-btn { display: inline-block; padding: 15px; cursor: pointer; color: #747d8c; border-bottom: 3px solid transparent; }
        .tab-btn.active { color: var(--primary); border-bottom: 3px solid var(--primary); font-weight: bold; }

        /* HERO SECTION */
        .hero { background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('https://images.unsplash.com/photo-1555396273-367ea4eb4db5?auto=format&fit=crop&w=1000&q=80'); background-size: cover; background-position: center; color: white; padding: 60px 20px; text-align: center; border-radius: 0 0 20px 20px; }
        
        /* VERIFICATION BADGE */
        .verified-badge { display: inline-flex; align-items: center; gap: 5px; color: var(--green); border: 1px solid var(--green); padding: 2px 8px; border-radius: 20px; font-size: 0.8rem; background: #eafff3; }
        .not-verified { color: var(--primary); font-size: 0.8rem; }

        /* BILL & WATERMARK */
        .bill-wrapper { position: relative; border: 1px dashed #ccc; padding: 20px; background: #fffbe7; overflow: hidden; }
        .watermark { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-45deg); font-size: 3rem; font-weight: bold; color: rgba(255, 71, 87, 0.15); border: 4px solid rgba(255, 71, 87, 0.15); padding: 10px; white-space: nowrap; pointer-events: none; }

        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; display: flex; justify-content: center; align-items: center; }
        .modal-box { background: white; width: 90%; max-width: 400px; padding: 20px; border-radius: 12px; max-height: 90vh; overflow-y: auto; }

        /* STATUS COLORS */
        .status-new { border-left-color: var(--green); }
        .status-confirm { border-left-color: var(--yellow); }
        .status-active { border-left-color: #70a1ff; }
        .status-ready { border-left-color: #ff6b81; }
        .status-completed { border-left-color: #2f3542; }
        .status-unpaid { border-left-color: #eccc68; }

    </style>
</head>
<body>

<div id="app"></div>

<!-- TEMPLATES -->

<!-- 1. LANDING PAGE -->
<template id="tpl-landing">
    <div class="hero">
        <svg class="nav-logo" viewBox="0 0 512 512" fill="white" style="width:80px;height:80px;margin-bottom:10px;">
            <path d="M256 32C132.3 32 32 132.3 32 256s100.3 224 224 224 224-100.3 224-224S379.7 32 256 32zm0 416c-105.9 0-192-86.1-192-192S150.1 64 256 64s192 86.1 192 192-86.1 192-192 192z"/><path d="M368 240H144c-8.8 0-16 7.2-16 16v32c0 8.8 7.2 16 16 16h224c8.8 0 16-7.2 16-16v-32c0-8.8-7.2-16-16-16z" fill="white"/>
        </svg>
        <h1>EatlyHub</h1>
        <p>The All-in-One Platform for Hotels, Restaurants & Home-Based Kitchens</p>
        <button class="btn btn-primary mt-2" onclick="authLogin()">Login / Create Account (Gmail)</button>
    </div>
    
    <div class="p-2">
        <h2 class="text-center">Start Your Food Business</h2>
        
        <div class="card">
            <h3>üè® Hotels & Restaurants</h3>
            <p>Digitalize your room service and table ordering. Manage orders efficiently.</p>
        </div>

        <div class="card">
            <h3>üè† Home Based Kitchens</h3>
            <p>Turn your kitchen into a business! Create a menu, share your link, and get orders directly to WhatsApp.</p>
            <p class="text-green bold">Start small, Grow Big.</p>
        </div>

        <div class="card" style="background: #dfe4ea;">
            <h3>For Customers</h3>
            <p>Login to track your orders or order as a guest.</p>
        </div>
    </div>
</template>

<!-- 2. DASHBOARD SHELL -->
<template id="tpl-dashboard">
    <nav class="flex justify-between center">
        <div class="nav-brand">
            <svg class="nav-logo" viewBox="0 0 24 24" fill="var(--primary)"><circle cx="12" cy="12" r="10"/></svg>
            EatlyHub
        </div>
        <button class="btn btn-outline" style="width:auto; padding:5px 10px;" onclick="authLogout()">Logout</button>
    </nav>
    
    <div class="tabs-container" id="dash-tabs">
        <!-- JS will populate tabs -->
    </div>

    <div id="dash-content" class="p-2" style="padding-bottom: 80px;">
        <!-- Content Area -->
    </div>
</template>

<!-- 3. PUBLIC PAGE TEMPLATE -->
<template id="tpl-public">
    <div id="public-status" class="p-1 text-center bold text-white"></div>
    
    <div class="text-center p-2 bg-white">
        <img id="pub-logo" src="" style="width:100px; height:100px; border-radius:50%; object-fit:cover; border:3px solid var(--primary);">
        <h2 id="pub-name" class="mt-1"></h2>
        <div id="pub-verified-badge" class="hidden center" style="justify-content:center; margin-bottom:10px;">
            <span class="verified-badge">‚úî Verified Business</span>
        </div>
        <p id="pub-address" style="color:#777"></p>
        <div class="flex center mt-1">
            <a id="pub-hotline" class="btn btn-green" style="width:auto; margin-right:5px;">Call</a>
            <a id="pub-wa" class="btn btn-green" style="width:auto;">WhatsApp</a>
        </div>
    </div>

    <div class="hero mt-2" style="border-radius:0;">
        <h2 id="pub-hero-text"></h2>
        <button class="btn btn-primary" onclick="document.getElementById('pub-menu').scrollIntoView()">ORDER NOW</button>
    </div>

    <div id="pub-menu" class="p-2"></div>

    <footer class="text-center p-2 mt-2" style="background:var(--secondary); color:white;">
        <h4 id="footer-biz-name"></h4>
        <p id="footer-contact"></p>
        <div id="footer-verified" class="hidden verified-badge" style="background:transparent; border-color:white; color:white; margin: 10px auto; width:fit-content; cursor:pointer;">‚úî Verified (Click to view proof)</div>
        <small>Powered by RestoFlow</small>
    </footer>
</template>

<script>
    // --- FIREBASE CONFIGURATION ---
    const firebaseConfig = {
        apiKey: "AIzaSyA4mlpgLA8l1N8VHqwpVLbPXvDvPxGPcSI",
        authDomain: "eatlyhub.firebaseapp.com",
        projectId: "eatlyhub",
        storageBucket: "eatlyhub.firebasestorage.app",
        messagingSenderId: "1094045089044",
        appId: "1:1094045089044:web:397e0fd73412a07c3ad601",
        measurementId: "G-V3K3QB1715"
    };

    // Initialize Firebase
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const auth = firebase.auth();
    const db = firebase.firestore();

    // --- APP STATE & ROUTING ---
    const app = document.getElementById('app');
    let currentUser = null;
    let bizProfile = null;
    let bizOrders = [];
    
    // TABS DEFINITION
    const TABS = [
        'Dashboard', 'Profile', 'Open/Close', 'Add Foods', 'My Webpage',
        'New Orders', 'Confirmed Orders', 'Active Orders', 'Ready Orders', 
        'Completed Orders', 'Unpaid Bills', 'Reports', 'Admin Messages'
    ];

    // --- INIT ---
    window.addEventListener('load', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const bizId = urlParams.get('biz');
        const orderId = urlParams.get('orderId');

        if (bizId && orderId) {
            loadCustomerConfirmPage(bizId, orderId);
        } else if (bizId) {
            loadPublicPage(bizId);
        } else {
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    loadDashboard();
                } else {
                    render('tpl-landing');
                }
            });
        }
    });

    // --- RENDER HELPERS ---
    function render(tplId) {
        app.innerHTML = '';
        app.appendChild(document.getElementById(tplId).content.cloneNode(true));
    }

    // --- AUTHENTICATION ---
    function authLogin() {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider).catch(alert);
    }
    function authLogout() { auth.signOut().then(() => window.location.reload()); }

    // --- DASHBOARD LOGIC ---
    async function loadDashboard() {
        render('tpl-dashboard');
        
        // Load Profile
        const doc = await db.collection('users').doc(currentUser.uid).get();
        bizProfile = doc.exists ? doc.data() : { locked: false, verified: false, foods: [], schedule: {} };
        
        // Listen to Orders
        db.collection('users').doc(currentUser.uid).collection('orders').orderBy('time', 'desc')
            .onSnapshot(snap => {
                bizOrders = snap.docs.map(d => ({id: d.id, ...d.data()}));
                // Check for new orders notification
                const newOrders = bizOrders.filter(o => o.status === 'new' && !o.seen);
                if(newOrders.length > 0) showModal(`<h3>üîî New Order!</h3><p>You have ${newOrders.length} new orders.</p>`);
                refreshCurrentTab();
            });

        renderTabs();
        switchTab('Dashboard');
    }

    function renderTabs() {
        const container = document.getElementById('dash-tabs');
        container.innerHTML = TABS.map(t => `<span class="tab-btn" onclick="switchTab('${t}')">${t}</span>`).join('');
    }

    function switchTab(tabName) {
        // Validation: Profile must be complete to access other tabs
        if (tabName !== 'Dashboard' && tabName !== 'Profile' && (!bizProfile.locked)) {
            alert("Please complete and LOCK your profile first.");
            switchTab('Profile');
            return;
        }

        document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.innerText === tabName));
        const content = document.getElementById('dash-content');
        content.innerHTML = '<div class="text-center p-2">Loading...</div>';
        
        window.currentTab = tabName; // store for refreshing
        renderTabContent(tabName, content);
    }

    function refreshCurrentTab() {
        if(window.currentTab) renderTabContent(window.currentTab, document.getElementById('dash-content'));
    }

    // --- TAB CONTENTS ---
    function renderTabContent(tab, container) {
        container.innerHTML = '';

        if(tab === 'Dashboard') {
            container.innerHTML = `
                <div class="card center flex-col">
                    <img src="${bizProfile.logo || 'https://via.placeholder.com/100'}" style="width:80px;height:80px;border-radius:50%">
                    <h3>${bizProfile.businessName || 'Welcome'}</h3>
                    ${bizProfile.verified ? '<div class="verified-badge">‚úî Verified</div>' : '<div class="not-verified">‚ùå Not Verified</div>'}
                </div>
                <div class="input-group">
                    <label>üîç Search Order (ID)</label>
                    <input type="text" placeholder="Enter Order Number" onkeyup="searchOrder(this.value)">
                    <div id="search-res-order"></div>
                </div>
                <div class="input-group">
                    <label>üîç Search Unpaid Customer (WhatsApp)</label>
                    <input type="text" placeholder="Enter 947..." onkeyup="searchCustomer(this.value)">
                    <div id="search-res-cust"></div>
                </div>
            `;
        }

        else if (tab === 'Profile') {
            const isLocked = bizProfile.locked;
            container.innerHTML = `
                <div class="card">
                    <div class="input-group"><label>Logo URL</label><input id="p-logo" value="${bizProfile.logo||''}" ${isLocked?'disabled':''}></div>
                    <div class="input-group"><label>Business Name</label><input id="p-bizname" value="${bizProfile.businessName||''}" ${isLocked?'disabled':''}></div>
                    <div class="input-group"><label>Owner Name</label><input id="p-owner" value="${bizProfile.ownerName||''}" ${isLocked?'disabled':''}></div>
                    <div class="input-group"><label>Address</label><input id="p-addr" value="${bizProfile.address||''}" ${isLocked?'disabled':''}></div>
                    <div class="input-group"><label>Reg/NIC No</label><input id="p-nic" value="${bizProfile.nic||''}" ${isLocked?'disabled':''}></div>
                    <div class="input-group"><label>Hotline</label><input id="p-hot" value="${bizProfile.hotline||''}" ${isLocked?'disabled':''}></div>
                    <div class="input-group"><label>WhatsApp</label><input id="p-wa" value="${bizProfile.whatsapp||''}" ${isLocked?'disabled':''}></div>
                    
                    ${isLocked 
                        ? `<button class="btn btn-yellow" onclick="toggleProfileLock(false)">Unlock & Edit</button>` 
                        : `<button class="btn btn-primary" onclick="saveProfile()">Save & Lock Profile</button>`}
                </div>

                <div class="card">
                    <h3>Get Verified (Rs 2500)</h3>
                    ${bizProfile.verified ? '<p class="text-green bold">You are Verified!</p>' : `
                        <p>Bank: Commercial Bank, Homagama<br>Acc: 8750053306 (Colombage SD)</p>
                        <div class="input-group"><label>Upload Grama Niladhari Letter & Slip (Mock)</label><input type="file" disabled></div>
                        <button class="btn btn-primary" onclick="requestVerification()">Submit to Admin</button>
                    `}
                </div>
            `;
        }

        else if (tab === 'Open/Close') {
            const today = new Date().toLocaleDateString('en-US', {weekday:'long'});
            container.innerHTML = `
                <div class="card">
                    <h3>üìÖ Schedule for ${today} (Today)</h3>
                    <div class="input-group">
                        <label>Are you Open Today?</label>
                        <select id="oc-status" onchange="saveSchedule('${today}')">
                            <option value="yes" ${bizProfile.schedule?.[today]?.open ? 'selected':''}>Yes</option>
                            <option value="no" ${!bizProfile.schedule?.[today]?.open ? 'selected':''}>No</option>
                        </select>
                    </div>
                    <div class="flex justify-between">
                        <div class="input-group w-100" style="margin-right:5px">
                            <label>Open Time</label>
                            <input type="time" id="oc-open" value="${bizProfile.schedule?.[today]?.start || '08:00'}" onchange="saveSchedule('${today}')">
                        </div>
                        <div class="input-group w-100">
                            <label>Close Time</label>
                            <input type="time" id="oc-close" value="${bizProfile.schedule?.[today]?.end || '20:00'}" onchange="saveSchedule('${today}')">
                        </div>
                    </div>
                    <p class="text-green text-center">Settings autosaved for ${today}</p>
                </div>
            `;
        }

        else if (tab === 'Add Foods') {
            container.innerHTML = `
                <div class="card">
                    <h3>Add Item</h3>
                    <input id="f-cat" class="w-100 mb-1 p-1" placeholder="Category (e.g. Rice)">
                    <input id="f-name" class="w-100 mb-1 p-1" placeholder="Food Name *">
                    <input id="f-img" class="w-100 mb-1 p-1" placeholder="Image URL *">
                    <div class="flex">
                        <input id="f-half" type="number" class="w-100 p-1" placeholder="Half Price" style="margin-right:5px">
                        <input id="f-full" type="number" class="w-100 p-1" placeholder="Full Price">
                    </div>
                    <button class="btn btn-green mt-2" onclick="addFood()">Add to Menu</button>
                </div>
                <div id="food-list">
                    ${(bizProfile.foods || []).map((f, i) => `
                        <div class="card flex justify-between center">
                            <div class="flex center">
                                <img src="${f.img}" style="width:50px;height:50px;border-radius:5px;margin-right:10px;">
                                <div><b>${f.name}</b><br><small>${f.cat}</small></div>
                            </div>
                            <button class="btn btn-secondary" style="width:auto" onclick="deleteFood(${i})">X</button>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        else if (tab === 'My Webpage') {
            const link = `${window.location.origin}${window.location.pathname}?biz=${currentUser.uid}`;
            container.innerHTML = `
                <div class="card">
                    <h3>Your Public Link</h3>
                    <input value="${link}" readonly style="width:100%; padding:10px; background:#eee; border:none; border-radius:5px;">
                    <a href="${link}" target="_blank" class="btn btn-primary mt-2" style="display:block;text-decoration:none">Open Webpage</a>
                    <div class="input-group mt-2">
                        <label>Custom Hero Text</label>
                        <input id="hero-txt" value="${bizProfile.heroText || 'Welcome to ' + bizProfile.businessName}" onchange="updateHero(this.value)">
                    </div>
                </div>
            `;
        }

        // --- ORDER TABS ---
        else if (['New Orders', 'Confirmed Orders', 'Active Orders', 'Ready Orders', 'Completed Orders', 'Unpaid Bills'].includes(tab)) {
            const statusMap = {
                'New Orders': 'new',
                'Confirmed Orders': 'confirmed',
                'Active Orders': 'active',
                'Ready Orders': 'ready',
                'Completed Orders': 'completed',
                'Unpaid Bills': 'unpaid'
            };
            const status = statusMap[tab];
            const filtered = bizOrders.filter(o => o.status === status);

            if(filtered.length === 0) {
                container.innerHTML = '<div class="text-center p-2">No orders in this section.</div>';
                return;
            }

            container.innerHTML = filtered.map(o => {
                let btns = '';
                if(status === 'new') btns = `
                    <button class="btn btn-yellow" onclick="reqConfirm('${o.id}', '${o.custWa}')">Request Confirmation via WhatsApp</button>
                    <button class="btn btn-secondary" onclick="updateOrderStatus('${o.id}', 'canceled')">Decline</button>`;
                if(status === 'confirmed') btns = `<button class="btn btn-primary" onclick="printBill('${o.id}')">üñ® Print Bill & Cook</button>`;
                if(status === 'active') btns = `
                    <div class="bill-wrapper mt-1">
                        <div class="watermark">NOT PAID</div>
                        <h4>${bizProfile.businessName} - Bill</h4>
                        <p>Order #${o.orderNum}</p>
                        <hr>
                        ${o.items.map(i => `<div class="flex justify-between"><span>${i.name} (${i.variant})</span><span>${i.price}</span></div>`).join('')}
                        <hr><h3>Total: ${o.total}</h3>
                    </div>
                    <button class="btn btn-green mt-1" onclick="markReady('${o.id}', '${o.custWa}')">Order Ready (Notify Customer)</button>`;
                if(status === 'ready') btns = `
                    <button class="btn btn-secondary" onclick="updateOrderStatus('${o.id}', 'completed')">üí∞ Paid & Completed</button>
                    <button class="btn btn-outline" style="color:red; border-color:red" onclick="updateOrderStatus('${o.id}', 'unpaid')">‚ö† Not Paid</button>`;
                
                return `
                <div class="card status-${status}">
                    <div class="flex justify-between">
                        <h4>#${o.orderNum}</h4>
                        <small>${new Date(o.time).toLocaleTimeString()}</small>
                    </div>
                    <p><b>${o.custName}</b> <a href="https://wa.me/${o.custWa}">${o.custWa}</a></p>
                    <div style="background:#f1f2f6; padding:10px; border-radius:5px; margin:10px 0;">
                        ${o.items.map(i => `<div>${i.name} (${i.variant}) - ${i.price}</div>`).join('')}
                    </div>
                    <h4 class="text-right">Total: ${o.total}</h4>
                    <div class="mt-1">${btns}</div>
                </div>`;
            }).join('');
        }

        else if (tab === 'Reports') {
            const completed = bizOrders.filter(o => o.status === 'completed');
            const revenue = completed.reduce((sum, o) => sum + parseInt(o.total), 0);
            const unpaid = bizOrders.filter(o => o.status === 'unpaid').length;
            
            container.innerHTML = `
                <div class="card">
                    <h3>Summary Report</h3>
                    <p>Total Revenue: <b>Rs. ${revenue}</b></p>
                    <p>Completed Orders: <b>${completed.length}</b></p>
                    <p class="text-red">Unpaid Bills: <b>${unpaid}</b></p>
                </div>
            `;
        }
        
        else if (tab === 'Admin Messages') {
            container.innerHTML = `<div class="card"><p>No new messages from Admin.</p></div>`;
        }
    }

    // --- ACTIONS ---
    function saveProfile() {
        const p = {
            logo: document.getElementById('p-logo').value,
            businessName: document.getElementById('p-bizname').value,
            ownerName: document.getElementById('p-owner').value,
            address: document.getElementById('p-addr').value,
            nic: document.getElementById('p-nic').value,
            hotline: document.getElementById('p-hot').value,
            whatsapp: document.getElementById('p-wa').value,
            locked: true,
            verified: bizProfile.verified || false,
            foods: bizProfile.foods || [],
            schedule: bizProfile.schedule || {}
        };
        // Validation
        if(!p.businessName || !p.whatsapp || !p.hotline) return alert("Fill all required fields");
        
        db.collection('users').doc(currentUser.uid).set(p, {merge:true})
            .then(() => { bizProfile = p; switchTab('Dashboard'); });
    }
    
    function toggleProfileLock(state) {
        db.collection('users').doc(currentUser.uid).update({locked: state})
        .then(() => { bizProfile.locked = state; renderTabContent('Profile', document.getElementById('dash-content')); });
    }

    function saveSchedule(day) {
        const isOpen = document.getElementById('oc-status').value === 'yes';
        const start = document.getElementById('oc-open').value;
        const end = document.getElementById('oc-close').value;
        
        if(!bizProfile.schedule) bizProfile.schedule = {};
        bizProfile.schedule[day] = { open: isOpen, start, end };
        
        db.collection('users').doc(currentUser.uid).update({schedule: bizProfile.schedule});
    }

    function addFood() {
        const name = document.getElementById('f-name').value;
        const img = document.getElementById('f-img').value;
        const half = document.getElementById('f-half').value;
        const full = document.getElementById('f-full').value;
        const cat = document.getElementById('f-cat').value;

        if(!name || !img || (!half && !full)) return alert("Name, Image and at least one price required.");
        
        const newFood = { name, img, half, full, cat };
        const updatedFoods = [...(bizProfile.foods || []), newFood];
        
        db.collection('users').doc(currentUser.uid).update({foods: updatedFoods})
            .then(() => { bizProfile.foods = updatedFoods; renderTabContent('Add Foods', document.getElementById('dash-content')); });
    }

    function deleteFood(idx) {
        const updatedFoods = bizProfile.foods.filter((_, i) => i !== idx);
        db.collection('users').doc(currentUser.uid).update({foods: updatedFoods})
            .then(() => { bizProfile.foods = updatedFoods; renderTabContent('Add Foods', document.getElementById('dash-content')); });
    }

    function updateHero(txt) {
        db.collection('users').doc(currentUser.uid).update({heroText: txt});
    }

    function requestVerification() {
        alert("Verification Request Sent to Admin!"); 
        // Logic to send msg to admin collection would go here
    }

    // --- ORDER HANDLING ---
    function reqConfirm(id, wa) {
        const link = `${window.location.origin}${window.location.pathname}?biz=${currentUser.uid}&orderId=${id}`;
        const msg = `Please confirm your order by clicking this link: ${link}`;
        window.open(`https://wa.me/${wa}?text=${encodeURIComponent(msg)}`);
    }

    function printBill(id) {
        // Send Bill Image via WA logic requires backend image generation. 
        // For Client-Side: Generate Text Bill
        const o = bizOrders.find(x => x.id === id);
        const billTxt = `*BILL - ${bizProfile.businessName}* %0A Order: ${o.orderNum} %0A Total: ${o.total} %0A Status: Cooking`;
        window.open(`https://wa.me/${o.custWa}?text=${billTxt}`);
        updateOrderStatus(id, 'active');
    }

    function markReady(id, wa) {
        window.open(`https://wa.me/${wa}?text=Your order is READY! Please come and pay.`);
        updateOrderStatus(id, 'ready');
    }

    function updateOrderStatus(id, status) {
        db.collection('users').doc(currentUser.uid).collection('orders').doc(id).update({status: status})
            .then(() => refreshCurrentTab());
    }

    function searchOrder(val) {
        const o = bizOrders.find(x => x.orderNum === val);
        document.getElementById('search-res-order').innerHTML = o 
            ? `<div class="p-1 border mt-1">Found: Status <b>${o.status}</b></div>` 
            : '';
    }

    function searchCustomer(val) {
        if(val.length < 5) return;
        const unpaid = bizOrders.filter(x => x.custWa.includes(val) && x.status === 'unpaid');
        document.getElementById('search-res-cust').innerHTML = unpaid.length > 0 
            ? `<div class="p-1 border mt-1 text-red">‚ö† Found ${unpaid.length} Unpaid Bills!</div>` 
            : '<div class="text-green mt-1">No unpaid records.</div>';
    }

    // --- PUBLIC PAGE LOGIC ---
    let cart = [];
    
    async function loadPublicPage(bizId) {
        render('tpl-public');
        const doc = await db.collection('users').doc(bizId).get();
        if(!doc.exists) return alert("Business not found");
        
        const data = doc.data();
        document.getElementById('pub-name').innerText = data.businessName;
        document.getElementById('pub-logo').src = data.logo;
        document.getElementById('pub-address').innerText = data.address;
        document.getElementById('pub-hero-text').innerText = data.heroText || `Welcome to ${data.businessName}`;
        document.getElementById('pub-hotline').href = `tel:${data.hotline}`;
        document.getElementById('pub-wa').href = `https://wa.me/${data.whatsapp}`;
        
        // Footer info
        document.getElementById('footer-biz-name').innerText = data.businessName;
        document.getElementById('footer-contact').innerText = `${data.address} | ${data.hotline}`;
        if(data.verified) {
             document.getElementById('pub-verified-badge').classList.remove('hidden');
             document.getElementById('footer-verified').classList.remove('hidden');
             document.getElementById('footer-verified').onclick = () => alert("User has submitted Grama Niladhari Letter to Admin.");
        }

        // Open/Close
        const today = new Date().toLocaleDateString('en-US', {weekday:'long'});
        const sched = data.schedule?.[today];
        const statusDiv = document.getElementById('public-status');
        
        if (sched && sched.open) {
            statusDiv.innerText = `WE ARE OPEN TODAY (${sched.start} - ${sched.end})`;
            statusDiv.style.background = 'var(--green)';
            // Check if currently within time - simplified logic
        } else {
            statusDiv.innerText = `WE ARE CLOSED TODAY`;
            statusDiv.style.background = 'var(--primary)';
        }

        // Menu
        const menuDiv = document.getElementById('pub-menu');
        const cats = [...new Set((data.foods || []).map(f => f.cat))];
        
        cats.forEach(c => {
            menuDiv.innerHTML += `<h3 class="mt-2" style="border-bottom:2px solid var(--primary)">${c || 'General'}</h3>`;
            data.foods.filter(f => f.cat === c).forEach(f => {
                menuDiv.innerHTML += `
                    <div class="card flex center justify-between">
                        <img src="${f.img}" style="width:80px;height:80px;border-radius:10px;object-fit:cover;">
                        <div style="flex:1; padding:0 10px;">
                            <b>${f.name}</b>
                            <div class="mt-1">
                                ${f.half ? `<button class="btn btn-outline" style="width:auto;padding:5px;font-size:12px" onclick="addToCart('${f.name}', 'Half', ${f.half})">Half: ${f.half}</button>` : ''}
                                ${f.full ? `<button class="btn btn-outline" style="width:auto;padding:5px;font-size:12px" onclick="addToCart('${f.name}', 'Full', ${f.full})">Full: ${f.full}</button>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
        });

        // Floating Cart
        const cartBtn = document.createElement('div');
        cartBtn.innerHTML = 'üõí';
        cartBtn.style = "position:fixed;bottom:20px;right:20px;background:var(--primary);color:white;padding:15px;border-radius:50%;font-size:24px;box-shadow:0 4px 10px rgba(0,0,0,0.3);cursor:pointer;z-index:900";
        cartBtn.onclick = () => showCart(bizId);
        document.body.appendChild(cartBtn);
    }

    function addToCart(name, variant, price) {
        cart.push({name, variant, price});
        alert(`Added ${name} (${variant})`);
    }

    function showCart(bizId) {
        if(cart.length === 0) return alert("Cart Empty");
        const total = cart.reduce((a,b)=>a+parseInt(b.price),0);
        
        showModal(`
            <h3>Your Cart</h3>
            <ul>${cart.map(i => `<li>${i.name} (${i.variant}) - ${i.price}</li>`).join('')}</ul>
            <h4>Total: ${total}</h4>
            <div class="input-group"><label>Your Name</label><input id="c-name"></div>
            <div class="input-group"><label>WhatsApp Number</label><input id="c-wa" placeholder="947..."></div>
            <button class="btn btn-green" onclick="sendOrder('${bizId}', ${total})">Confirm & Order via WhatsApp</button>
            <button class="btn btn-secondary" onclick="closeModal()">Close</button>
        `);
    }

    function sendOrder(bizId, total) {
        const name = document.getElementById('c-name').value;
        const wa = document.getElementById('c-wa').value;
        if(!name || !wa) return alert("Details Required");

        // Generate Order Number (Simple timestamp based for demo)
        // In production, transaction needed to increment counter
        const orderNum = Math.floor(10000 + Math.random() * 90000).toString(); 

        const orderData = {
            orderNum, custName: name, custWa: wa, items: cart, total, 
            time: new Date().toISOString(), status: 'new', seen: false
        };

        db.collection('users').doc(bizId).collection('orders').add(orderData).then(() => {
            // Send WA to Owner
            db.collection('users').doc(bizId).get().then(doc => {
                const ownerWa = doc.data().whatsapp;
                const msg = `New Order from ${name}! Order #${orderNum}. Items: ${cart.map(i=>i.name).join(', ')}. Total: ${total}`;
                window.open(`https://wa.me/${ownerWa}?text=${encodeURIComponent(msg)}`);
                cart = [];
                closeModal();
            });
        });
    }

    // --- CUSTOMER CONFIRMATION LINK ---
    async function loadCustomerConfirmPage(bizId, orderId) {
        const doc = await db.collection('users').doc(bizId).collection('orders').doc(orderId).get();
        if(!doc.exists) return alert("Order not found");
        const o = doc.data();

        app.innerHTML = `
            <div class="center flex-col p-2" style="height:100vh; background:white;">
                <h2 class="text-green">Confirm Your Order</h2>
                <h1>#${o.orderNum}</h1>
                <div class="card w-100" style="max-width:400px; text-align:left">
                    ${o.items.map(i => `<div>${i.name} - ${i.price}</div>`).join('')}
                    <hr><h3>Total: ${o.total}</h3>
                </div>
                <button class="btn btn-green" style="max-width:300px" onclick="custConfirmAction('${bizId}', '${orderId}', 'confirmed')">‚úÖ YES, CONFIRM ORDER</button>
                <button class="btn btn-secondary mt-1" style="max-width:300px" onclick="custConfirmAction('${bizId}', '${orderId}', 'canceled')">‚ùå CANCEL</button>
            </div>
        `;
    }

    function custConfirmAction(bizId, orderId, status) {
        db.collection('users').doc(bizId).collection('orders').doc(orderId).update({status: status})
        .then(() => {
            alert(status === 'confirmed' ? "Order Confirmed! Kitchen is preparing." : "Order Canceled.");
            window.location.href = window.location.pathname; // go to landing
        });
    }

    // --- UTILS ---
    function showModal(html) {
        const div = document.createElement('div');
        div.className = 'modal-overlay';
        div.innerHTML = `<div class="modal-box">${html}</div>`;
        document.body.appendChild(div);
    }
    function closeModal() { document.querySelector('.modal-overlay').remove(); }

</script>
</body>
</html>
