<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EatlyHub | Premium Food Platform</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#FF4757">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <!-- Firebase Storage SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>

    <!-- Leaflet Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root {
            /* --- COLOR PALETTE --- */
            --primary: #FF4757; 
            --primary-grad: linear-gradient(135deg, #FF4757, #FF6B81);
            --secondary: #2F3542;
            --bg-body: #F4F7FC;
            --surface: #FFFFFF;
            
            /* Status Colors */
            --green: #2ED573;
            --green-grad: linear-gradient(135deg, #2ED573, #7BED9F);
            --red: #FF4757;
            --yellow: #FFA502;
            --yellow-grad: linear-gradient(135deg, #FFA502, #ECCC68);
            --blue: #1E90FF;
            --blue-grad: linear-gradient(135deg, #1E90FF, #70A1FF);
            
            /* Design System */
            --shadow-sm: 0 4px 6px rgba(0,0,0,0.02);
            --shadow-card: 0 10px 25px rgba(149, 157, 165, 0.08);
            --shadow-float: 0 15px 30px rgba(255, 71, 87, 0.25);
            --glass: rgba(255, 255, 255, 0.9);
            --backdrop: blur(12px);
            --font: 'Poppins', sans-serif;
            --radius: 20px;
            --sidebar-width: 280px;
        }

        /* --- RESET & BASE --- */
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { 
            margin: 0; padding: 0; font-family: var(--font); 
            background: var(--bg-body); color: var(--secondary); 
            font-size: 14px; line-height: 1.6; overflow-x: hidden; 
            padding-bottom: 80px; /* Space for mobile bottom actions */
            min-height: 100vh;
        }
        
        /* Scrollbar Styling */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        /* --- UTILITY CLASSES --- */
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .center { align-items: center; justify-content: center; }
        .justify-between { justify-content: space-between; }
        .w-100 { width: 100%; }
        .hidden { display: none !important; }
        .mt-1 { margin-top: 0.75rem; }
        .mt-2 { margin-top: 1.5rem; }
        .mb-1 { margin-bottom: 0.75rem; }
        .p-1 { padding: 0.75rem; }
        .p-2 { padding: 1.5rem; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-red { color: var(--primary); }
        .text-green { color: var(--green); }
        .text-white { color: white !important; }
        .bold { font-weight: 700; }
        .relative { position: relative; }
        
        /* --- TYPOGRAPHY --- */
        h1, h2, h3, h4 { margin: 0 0 10px 0; color: var(--secondary); font-weight: 800; letter-spacing: -0.5px; }
        h1 { font-size: 2.2rem; }
        h3 { font-size: 1.3rem; }
        small { color: #747d8c; font-size: 0.85rem; font-weight: 500; }

        /* --- COMPONENTS --- */
        
        /* Buttons */
        .btn { 
            padding: 12px 20px; border: none; border-radius: 14px; cursor: pointer; 
            font-weight: 600; font-size: 0.95rem; transition: all 0.2s ease; 
            width: 100%; text-align: center; display: inline-flex; justify-content: center; align-items: center; gap: 8px;
            text-decoration: none; margin-bottom: 12px; 
            position: relative; overflow: hidden;
        }
        .btn:hover { transform: translateY(-2px); filter: brightness(1.05); }
        .btn:active { transform: scale(0.98); }
        
        .btn-primary { background: var(--primary-grad); color: white; box-shadow: 0 8px 15px rgba(255, 71, 87, 0.25); }
        .btn-secondary { background: var(--secondary); color: white; }
        .btn-green { background: var(--green-grad); color: white; box-shadow: 0 8px 15px rgba(46, 213, 115, 0.25); }
        .btn-yellow { background: var(--yellow-grad); color: white; }
        .btn-outline { border: 2px solid var(--primary); color: var(--primary); background: transparent; }
        .btn-outline:hover { background: var(--primary); color: white; }
        
        /* Cards */
        .card { 
            background: var(--surface); padding: 20px; border-radius: var(--radius); 
            box-shadow: var(--shadow-card); margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.8);
            animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            position: relative;
        }
        
        /* Inputs */
        .input-group { margin-bottom: 18px; position: relative; }
        .input-group label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.85rem; color: #57606f; }
        .input-group input, .input-group select, .input-group textarea { 
            width: 100%; padding: 14px; border: 2px solid #f1f2f6; border-radius: 14px; 
            font-size: 0.95rem; background: #fdfdfd; transition: all 0.3s; -webkit-appearance: none; font-family: var(--font);
            color: var(--secondary);
        }
        .input-group input:focus { border-color: var(--primary); background: #fff; box-shadow: 0 0 0 4px rgba(255, 71, 87, 0.1); }
        
        /* Image Upload */
        .file-upload-wrapper {
            border: 2px dashed #ced6e0; border-radius: 14px; padding: 25px;
            text-align: center; cursor: pointer; background: #f8f9fa; transition: 0.3s;
        }
        .file-upload-wrapper:hover { border-color: var(--primary); background: #fff5f6; }

        /* --- RESPONSIVE LAYOUT & NAVIGATION --- */
        
        /* Mobile Navbar */
        nav { 
            background: var(--glass); backdrop-filter: var(--backdrop);
            padding: 12px 20px; position: sticky; top: 10px; z-index: 1000; 
            box-shadow: var(--shadow-sm); display: flex; align-items: center; justify-content: space-between; 
            margin: 0 10px; border-radius: 50px; border: 1px solid rgba(255,255,255,0.5);
        }
        .nav-brand { display: flex; align-items: center; gap: 8px; font-size: 1.2rem; font-weight: 800; color: var(--primary); }

        /* Mobile Tabs Wrapper */
        .tabs-wrapper { 
            background: transparent; z-index: 900; 
            width: 100%; overflow: hidden; margin-top: 10px;
        }
        
        /* Mobile Horizontal Tabs */
        .tabs-container { 
            display: flex; flex-wrap: nowrap; overflow-x: auto; padding: 10px 15px; 
            -webkit-overflow-scrolling: touch; scrollbar-width: none; gap: 10px;
            width: 100%;
        }
        .tabs-container::-webkit-scrollbar { display: none; }
        
        .tab-btn { 
            padding: 8px 18px; white-space: nowrap; cursor: pointer; color: #747d8c; 
            font-weight: 600; border-radius: 50px; background: #fff; transition: all 0.3s; 
            font-size: 0.85rem; flex-shrink: 0; border: 1px solid #f1f2f6; 
            display: flex; align-items: center; gap: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }
        .tab-btn i { font-size: 1em; }
        .tab-btn.active { 
            background: var(--primary); color: white; 
            box-shadow: 0 4px 12px rgba(255, 71, 87, 0.3); border-color: transparent;
        }
        
        /* Hidden by default on mobile, shown on desktop */
        .sidebar-logout { display: none; }

        /* --- DESKTOP SIDEBAR UPGRADE (Complete Fix) --- */
        @media (min-width: 900px) {
            nav { display: none; /* Hide mobile nav */ }
            
            .tabs-wrapper {
                position: fixed; top: 0; left: 0; width: var(--sidebar-width); height: 100vh;
                background: white; border-right: 1px solid #f0f0f0; margin: 0;
                padding: 0; box-shadow: 2px 0 20px rgba(0,0,0,0.02);
                display: flex; flex-direction: column; /* Flex Column for layout */
                z-index: 1001;
            }
            
            /* Sidebar Header */
            .tabs-wrapper:before {
                content: 'EatlyHub'; display: block; font-size: 1.8rem; font-weight: 800; 
                color: var(--primary); padding: 30px 25px; text-align: left;
                letter-spacing: -1px; border-bottom: 1px solid #f8f9fa;
            }

            /* Scrollable Tabs Area */
            .tabs-container { 
                flex-direction: column; padding: 20px; gap: 8px; 
                overflow-y: auto; flex: 1; /* Takes remaining height */
            }
            
            .tab-btn {
                width: 100%; border-radius: 12px; justify-content: flex-start; 
                padding: 14px 18px; background: transparent; border: none; box-shadow: none;
                color: #57606f; font-size: 0.95rem; margin-bottom: 2px;
            }
            .tab-btn:hover { background: #f8f9fa; color: var(--primary); transform: translateX(5px); }
            .tab-btn.active { 
                background: #FFF0F0; color: var(--primary); box-shadow: none; 
                transform: none; border-right: 4px solid var(--primary); border-radius: 12px;
            }

            /* Main Content Adjustment */
            #dash-content { 
                margin-left: var(--sidebar-width); 
                padding: 40px; 
                max-width: 1200px !important; 
                min-height: 100vh;
            }

            /* Explicit Sidebar Logout Button at Bottom */
            .sidebar-logout {
                display: flex;
                align-items: center;
                gap: 10px;
                padding: 20px 25px;
                margin: 0;
                border-top: 1px solid #f0f0f0;
                background: white;
                color: var(--secondary);
                font-weight: 700;
                cursor: pointer;
                transition: 0.3s;
            }
            .sidebar-logout:hover { background: #f8f9fa; color: var(--primary); }
        }

        /* --- SMALL SCREEN RESPONSIVENESS (300px Support) --- */
        @media (max-width: 380px) {
            h1 { font-size: 1.6rem; }
            h2 { font-size: 1.4rem; }
            h3 { font-size: 1.2rem; }
            .card { padding: 15px; }
            .stat-grid { grid-template-columns: 1fr !important; gap: 10px; } /* Stack stats */
            .flex { flex-wrap: wrap; }
            .btn { font-size: 0.9rem; padding: 10px 15px; }
            .input-group label { font-size: 0.8rem; }
            /* Prevent overflow on tiny screens */
            .tabs-container { padding: 10px 5px; } 
            .tab-btn { font-size: 0.8rem; padding: 6px 12px; }
            /* Adjust map height */
            .map-container { height: 250px; }
        }

        /* Hero Section */
        .hero { 
            background: var(--primary-grad); 
            color: white; padding: 80px 20px 60px; text-align: center; 
            border-radius: 0 0 40px 40px; box-shadow: var(--shadow-float); 
            margin-bottom: 30px; position: relative; overflow: hidden;
        }
        
        /* Status Badges */
        .status-badge { 
            padding: 5px 12px; border-radius: 30px; font-size: 0.75rem; 
            font-weight: 700; text-transform: uppercase; display: inline-flex; align-items: center; gap: 5px;
            cursor: pointer; letter-spacing: 0.5px;
        }
        .st-new { background: #E7FFF0; color: #20BF6B; border: 1px solid #20BF6B; }
        .st-unverified { background: #FFF0F0; color: var(--primary); border: 1px solid var(--primary); }
        .st-must-delivery { background: var(--primary); color: white; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* Order Card Strips */
        .card.status-new { border-left: 5px solid var(--green); }
        .card.status-confirm { border-left: 5px solid var(--yellow); }
        .card.status-active { border-left: 5px solid var(--blue); } 
        .card.status-ready { border-left: 5px solid var(--primary); }
        .card.status-completed { border-left: 5px solid #2f3542; opacity: 0.8; }
        .card.status-unpaid { border-left: 5px solid #ffa502; background: #fffdf9; }

        /* Bill Styles */
        .bill-wrapper { 
            background: #fff; padding: 20px; border-radius: 12px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-top: 15px; 
            font-family: 'Courier New', monospace; position: relative; 
            border: 1px solid #eee;
        }
        .bill-header { text-align: center; border-bottom: 2px dashed #bbb; padding-bottom: 10px; margin-bottom: 10px; }
        .bill-item { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; }
        .bill-total { border-top: 2px dashed #bbb; padding-top: 10px; margin-top: 10px; display: flex; justify-content: space-between; font-weight: 900; font-size: 1.1rem; }
        
        .watermark { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-30deg); 
            font-size: 2.5rem; font-weight: 900; color: rgba(255, 71, 87, 0.08); 
            border: 4px solid rgba(255, 71, 87, 0.08); padding: 5px 20px; 
            white-space: nowrap; pointer-events: none; z-index: 0;
        }

        /* Modals */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(47, 53, 66, 0.6); z-index: 2000; 
            display: flex; justify-content: center; align-items: flex-end; 
            backdrop-filter: blur(5px); 
        }
        @media(min-width: 600px) { .modal-overlay { align-items: center; } }
        .modal-box { 
            background: white; width: 100%; max-width: 500px; padding: 25px; 
            border-radius: 25px 25px 0 0; max-height: 85vh; overflow-y: auto; 
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: 0 -10px 40px rgba(0,0,0,0.2);
        }
        @media(min-width: 600px) { .modal-box { border-radius: 20px; } }
        
        /* Animations */
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 0.8s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Toast */
        @keyframes slideIn { from{opacity:0; transform:translateX(50px);} to{opacity:1; transform:translateX(0);} } 
        @keyframes fadeOut { from{opacity:1; transform:translateY(0);} to{opacity:0; transform:translateY(-20px);} } 

        /* Floating Cart */
        .floating-cart {
            position: fixed; bottom: 25px; right: 25px; background: var(--secondary); 
            color: white; width: 60px; height: 60px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 24px; box-shadow: 0 10px 30px rgba(47, 53, 66, 0.3); 
            cursor: pointer; z-index: 900; transition: transform 0.2s;
        }
        .floating-cart:hover { transform: scale(1.1); background: var(--primary); }
        .cart-badge { 
            position: absolute; top: -5px; right: -5px; background: var(--primary); 
            color: white; width: 24px; height: 24px; border-radius: 50%; font-size: 11px; 
            font-weight: bold; display: flex; align-items: center; justify-content: center; border: 2px solid white; 
        }

        /* Stat Grid */
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: white; padding: 15px; border-radius: 16px;
            text-align: center; box-shadow: var(--shadow-sm);
            cursor: pointer; transition: all 0.2s; border: 1px solid transparent;
        }
        .stat-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-card); border-color: #eee; }
        .stat-card h2 { margin: 0; font-size: 1.8rem; font-weight: 800; color: var(--secondary); }
        .stat-card small { font-weight: 600; display: block; margin-top: 4px; text-transform: uppercase; letter-spacing: 0.5px; font-size: 0.7rem; }

        /* Maps */
        .map-container {
            width: 100%; height: 300px; border-radius: 16px;
            margin-top: 15px; border: 3px solid white; box-shadow: var(--shadow-sm);
            z-index: 1; overflow: hidden;
        }
        .leaflet-control-attribution { font-size: 8px !important; }
        
        /* Report Table */
        .report-table { width: 100%; border-collapse: separate; border-spacing: 0; }
        .report-table th { background-color: #f8f9fa; padding: 12px; text-align: left; color: #a4b0be; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 1px; }
        .report-table td { padding: 12px; background: white; border-bottom: 1px solid #f1f1f1; font-size: 0.9rem; }
        
        @media (max-width: 500px) {
            .report-table thead { display: none; }
            .report-table tr { display: block; margin-bottom: 12px; border: 1px solid #eee; border-radius: 12px; padding: 0; box-shadow: var(--shadow-sm); overflow: hidden; }
            .report-table td { display: flex; justify-content: space-between; padding: 10px 15px; text-align: right; border-bottom: 1px solid #f9f9f9; }
            .report-table td:before { content: attr(data-label); font-weight: 600; color: #747d8c; text-align: left; }
        }

    </style>
</head>
<body>

<div id="app">
    <div style="height:100vh; display:flex; align-items:center; justify-content:center; flex-direction:column; background: white;">
        <div class="loader"></div>
        <p class="mt-2 bold text-red" style="font-size: 1.2rem; letter-spacing: 1px;">EatlyHub</p>
    </div>
</div>

<!-- ================= TEMPLATES ================= -->

<!-- 1. LANDING PAGE (REMASTERED LIKE HOME.HTML) -->
<template id="tpl-landing">
    
    <style>
        /* --- SHARED & LAYOUT STYLES --- */
        .landing-container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        
        /* Navbar (Glass Effect like Home.html) */
        .landing-nav {
            position: fixed; top: 0; width: 100%; z-index: 1000;
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
            padding: 15px 5%; display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05); transition: 0.3s;
        }
        .nav-logo { font-size: 1.5rem; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 8px; }
        
        /* Language Button */
        .lang-btn {
            background: white; border: 2px solid #f1f2f6; padding: 8px 16px;
            border-radius: 50px; font-weight: 700; color: var(--secondary);
            cursor: pointer; display: flex; align-items: center; gap: 8px;
            transition: 0.3s; font-size: 0.9rem;
        }
        .lang-btn:hover { border-color: var(--primary); color: var(--primary); }

        /* --- HERO SECTION --- */
        .hero-section {
            padding-top: 120px; padding-bottom: 60px;
            background: radial-gradient(circle at top right, #fff0f0 0%, #ffffff 60%);
            overflow: hidden; min-height: 85vh; display: flex; align-items: center;
        }
        
        .hero-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 50px; align-items: center;
        }

        .hero-text h1 { font-size: 3.5rem; line-height: 1.1; margin-bottom: 20px; color: var(--secondary); }
        .hero-text h1 span { color: var(--primary); }
        .hero-text p { font-size: 1.1rem; color: #747d8c; line-height: 1.6; margin-bottom: 30px; }
        
        .hero-img { position: relative; animation: float 6s ease-in-out infinite; text-align: center; }
        .hero-img img { width: 100%; max-width: 500px; drop-shadow: 0 20px 40px rgba(0,0,0,0.1); }

        /* --- SECTIONS --- */
        .section-title { text-align: center; margin-bottom: 40px; }
        .section-title h2 { font-size: 2.5rem; margin-bottom: 10px; color: var(--secondary); }
        .section-title p { color: #747d8c; }

        /* Comparison Cards */
        .comparison-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 40px; }
        .comp-card { padding: 30px; border-radius: 24px; position: relative; text-align: center; border: 2px solid transparent; transition: 0.3s; }
        .comp-card:hover { transform: translateY(-5px); }
        
        .comp-bad { background: #fff0f0; border-color: #ff4757; }
        .comp-good { background: #eafff3; border-color: #2ed573; box-shadow: 0 10px 30px rgba(46, 213, 115, 0.15); }
        
        .percent-box { font-size: 3rem; font-weight: 800; margin: 10px 0; display: block; }

        /* Feature Grid */
        .feature-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px; }
        .feature-card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); border: 1px solid #f1f2f6; transition: 0.3s; }
        .feature-card:hover { transform: translateY(-5px); border-color: var(--primary); }
        .f-icon { width: 60px; height: 60px; border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; margin-bottom: 20px; }

        /* Pricing Banner */
        .pricing-banner {
            background: var(--secondary); color: white; border-radius: 30px; padding: 60px 40px;
            text-align: center; margin-top: 60px; position: relative; overflow: hidden;
            box-shadow: 0 20px 50px rgba(47, 53, 66, 0.3);
        }
        .pricing-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 40px 0; text-align: left; }
        .p-item { background: rgba(255,255,255,0.1); padding: 15px 20px; border-radius: 12px; display: flex; align-items: center; gap: 10px; font-weight: 600; }

        /* Animation Keyframes */
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
        @keyframes pulse-ring { 0% { box-shadow: 0 0 0 0 rgba(46, 213, 115, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(46, 213, 115, 0); } 100% { box-shadow: 0 0 0 0 rgba(46, 213, 115, 0); } }
        
        /* Scrolling Text */
        .scroll-wrapper { background: #2ed573; padding: 15px 0; transform: rotate(-1deg); width: 105%; margin-left: -2.5%; margin-top: 40px; margin-bottom: 40px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .scroll-inner { white-space: nowrap; animation: scrollText 20s linear infinite; font-weight: 800; color: white; font-size: 1.2rem; letter-spacing: 1px; }
        @keyframes scrollText { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }

        /* Mobile Adjustments */
        @media (max-width: 900px) {
            .hero-grid, .comparison-grid { grid-template-columns: 1fr; text-align: center; }
            .hero-img { margin-top: 40px; }
            .hero-text h1 { font-size: 2.5rem; }
            .pricing-banner { padding: 40px 20px; }
        }

        /* --- PROFIT MODAL --- */
        .profit-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 9999;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
            backdrop-filter: blur(5px); padding: 15px;
        }
        .profit-modal-overlay.show { opacity: 1; pointer-events: all; }
        .profit-modal {
            background: white; width: 100%; max-width: 420px; border-radius: 24px;
            overflow: hidden; box-shadow: 0 25px 50px rgba(0,0,0,0.5);
            transform: scale(0.9); transition: transform 0.3s;
        }
        .profit-modal-overlay.show .profit-modal { transform: scale(1); }
        .nav-logo {
    display: flex;
    align-items: center; /* Ensures text and logo are aligned vertically */
    gap: 10px; /* Adds space between the logo and the text */
}

.logo-img {
    height: 40px; /* Adjust this to fit your navbar height */
    width: auto;
}
    </style>

    <!-- NAVBAR -->
    <nav class="landing-nav">
      <div class="nav-logo">
    <img src="logo.png" class="logo-img" alt="EatlyHub Logo"> EatlyHub
</div>
        <div style="display: flex; gap: 15px; align-items: center;">
            <button onclick="toggleLanguage()" class="lang-btn">
                <i class="fa-solid fa-language"></i> <span id="lang-btn-txt">‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω</span>
            </button>
            <button onclick="authLogin()" class="btn btn-primary" style="padding: 10px 20px; border-radius: 50px; margin: 0;">Login</button>
        </div>
    </nav>

    <!-- 1. HERO SECTION -->
    <section class="hero-section">
        <div class="landing-container">
            <div class="hero-grid">
                
                <!-- TEXT SIDE -->
                <div class="hero-text">
                    <!-- English -->
                    <div class="lang-en">
                        <div style="display:inline-block; background:#FFE3E3; color:var(--primary); padding:5px 15px; border-radius:50px; font-weight:700; font-size:0.8rem; margin-bottom:15px;">
                            üöÄ For Restaurants & Home Cooks
                        </div>
                        <h1>Stop Paying Huge <br><span>Commissions.</span></h1>
                        <p>The only food platform where you keep 100% of your profit. No hidden fees. Just pure business growth.</p>
                    </div>

                    <!-- Sinhala -->
                    <div class="lang-si hidden">
                        <div style="display:inline-block; background:#FFE3E3; color:var(--primary); padding:5px 15px; border-radius:50px; font-weight:700; font-size:0.8rem; margin-bottom:15px;">
                            üöÄ ‡∂Ö‡∑Ä‡∂±‡∑ä‡∑Ñ‡∂Ω‡∑ä ‡∑É‡∑Ñ ‡∂ú‡∑ò‡∑Ñ‡∑É‡∑ä‡∂Æ ‡∑Ä‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∑è‡∂ª ‡∑É‡∂≥‡∑Ñ‡∑è
                        </div>
                        <h1>‡∑Ä‡∑í‡∑Å‡∑è‡∂Ω ‡∂ö‡∑ú‡∂∏‡∑í‡∑É‡∑ä ‡∂∏‡∑î‡∂Ø‡∂Ω‡∑ä <br><span>‡∂ú‡∑ô‡∑Ä‡∑ì‡∂∏ ‡∂±‡∑Ä‡∂≠‡∑ä‡∑Ä‡∂±‡∑ä‡∂±.</span></h1>
                        <p>‡∂î‡∂∂‡∑ö ‡∂Ω‡∑è‡∂∑‡∂∫‡∑ô‡∂±‡∑ä 100%‡∂ö‡∑ä‡∂∏ ‡∂î‡∂∂‡∂ß ‡∑Ñ‡∑í‡∂∏‡∑í‡∑Ä‡∂± ‡∂ë‡∂ö‡∂∏ ‡∂¥‡∂Ø‡∑ä‡∂∞‡∂≠‡∑í‡∂∫. ‡∑É‡∑ê‡∂ü‡∑Ä‡∑î‡∂´‡∑î ‡∂ú‡∑è‡∑É‡∑ä‡∂≠‡∑î ‡∂ö‡∑í‡∑É‡∑í‡∑Ä‡∂ö‡∑ä ‡∂±‡∑ê‡∂≠.</p>
                    </div>

                    <button onclick="authLogin()" class="btn btn-primary" style="padding: 18px 30px; font-size: 1.1rem; border-radius: 50px; animation: pulse-ring 2s infinite;">
                        <i class="fa-brands fa-google"></i>
                        <span class="lang-en">Start 3-Day Free Trial</span>
                        <span class="lang-si hidden">‡∂Ø‡∑í‡∂± 3‡∂ö‡∑ä ‡∂±‡∑ú‡∂∏‡∑í‡∂Ω‡∑ö ‡∂Ö‡∂≠‡∑ä‡∑Ñ‡∂Ø‡∑è ‡∂∂‡∂Ω‡∂±‡∑ä‡∂±</span>
                    </button>
                    <div class="mt-1" style="color: #a4b0be; font-size: 0.85rem;">No credit card required. Cancel anytime.</div>
                </div>

                <!-- IMAGE SIDE -->
                <div class="hero-img">
                    <img src="profit.png" alt="Happy Chef">
                </div>
            </div>
        </div>
    </section>

    <!-- 2. SCROLLING BAR -->
    <div class="scroll-wrapper">
        <div class="scroll-inner">
            NO COMMISSIONS ‚Ä¢ KEEP 100% PROFIT ‚Ä¢ UNLIMITED ORDERS ‚Ä¢ RS 1500/Month ONLY ‚Ä¢ NO HIDDEN FEES ‚Ä¢ 
            NO COMMISSIONS ‚Ä¢ KEEP 100% PROFIT ‚Ä¢ UNLIMITED ORDERS ‚Ä¢ RS 1500/Month ONLY ‚Ä¢ NO HIDDEN FEES ‚Ä¢
            NO COMMISSIONS ‚Ä¢ KEEP 100% PROFIT ‚Ä¢ UNLIMITED ORDERS ‚Ä¢ RS 1500/Month ONLY ‚Ä¢ NO HIDDEN FEES ‚Ä¢
        </div>
    </div>

    <!-- 3. COMPARISON (THE HOOK) -->
    <div class="landing-container" style="padding-top: 40px;">
        <div class="section-title">
            <h2 class="lang-en">Why Lose Money?</h2>
            <h2 class="lang-si hidden">‡∂á‡∂∫‡∑í ‡∂¥‡∑è‡∂©‡∑î ‡∂Ω‡∂∂‡∂±‡∑ä‡∂±‡∑ö?</h2>
            <p class="lang-en">Compare EatlyHub with other delivery apps.</p>
            <p class="lang-si hidden">‡∑Ä‡∑ô‡∂±‡∂≠‡∑ä ‡∂á‡∂¥‡∑ä ‡∑É‡∂∏‡∂ü ‡∑É‡∑É‡∂≥‡∑è ‡∂∂‡∂Ω‡∂±‡∑ä‡∂±.</p>
        </div>

        <div class="comparison-grid">
            <!-- THEM -->
            <div class="comp-card comp-bad">
                <div style="position: absolute; top: -15px; left: 50%; transform: translateX(-50%); background: #ff4757; color: white; padding: 5px 15px; border-radius: 20px; font-weight: 700; font-size: 0.8rem;">OTHER APPS</div>
                <h3 style="color: #57606f;">They Take</h3>
                <span class="percent-box" style="color: #ff4757;">30%</span>
                <p class="lang-en text-gray">Commission on EVERY order.</p>
                <p class="lang-si text-gray hidden">‡∑É‡∑ë‡∂∏ ‡∂á‡∂´‡∑Ä‡∑î‡∂∏‡∂ö‡∑í‡∂±‡∑ä‡∂∏ 30% ‡∂î‡∂∂‡∂ß ‡∂Ö‡∑Ñ‡∑í‡∂∏‡∑í ‡∑Ä‡∑ö.</p>
            </div>

            <!-- US -->
            <div class="comp-card comp-good">
                <div style="position: absolute; top: -15px; left: 50%; transform: translateX(-50%); background: #2ed573; color: white; padding: 5px 15px; border-radius: 20px; font-weight: 700; font-size: 0.8rem;">EatlyHub</div>
                <h3 style="color: var(--secondary);">You Keep</h3>
                <span class="percent-box" style="color: #2ed573;">100%</span>
                <p class="lang-en text-green bold">NO COMMISSIONS. EVER.</p>
                <p class="lang-si text-green bold hidden">‡∂ö‡∑ú‡∂∏‡∑í‡∑É‡∑ä ‡∂∏‡∑î‡∂Ø‡∂Ω‡∑ä ‡∂±‡∑ê‡∂≠. ‡∑É‡∂∏‡∑ä‡∂¥‡∑ñ‡∂ª‡∑ä‡∂´ ‡∂Ω‡∑è‡∂∑‡∂∫ ‡∂î‡∂∂‡∂ß.</p>
            </div>
        </div>
    </div>

    <!-- 4. FEATURES GRID -->
    <div class="landing-container" style="padding-top: 40px;">
        <div class="section-title">
            <h2 class="lang-en">Everything You Need</h2>
            <h2 class="lang-si hidden">‡∂î‡∂∂‡∂ß ‡∂Ö‡∑Ä‡∑Å‡∑ä‚Äç‡∂∫ ‡∑É‡∑í‡∂∫‡∂Ω‡∑ä‡∂Ω</h2>
        </div>

        <div class="feature-grid">
            <!-- Feature 1 -->
            <div class="feature-card">
                <div class="f-icon" style="background: #e7f1ff; color: #1E90FF;">
                    <i class="fa-solid fa-globe"></i>
                </div>
                <h3 class="lang-en">Free Webpage</h3>
                <h3 class="lang-si hidden">‡∑Ä‡∑ô‡∂∂‡∑ä ‡∂¥‡∑í‡∂ß‡∑î‡∑Ä‡∂ö‡∑ä</h3>
                <p class="lang-en text-gray">Your own online store link. Share on WhatsApp & Facebook.</p>
                <p class="lang-si hidden text-gray">Facebook ‡∑É‡∑Ñ WhatsApp ‡∑Ñ‡∑í ‡∂∂‡∑ô‡∂Ø‡∑è‡∂ú‡∂≠ ‡∑Ñ‡∑ê‡∂ö‡∑í ‡∑Ä‡∑ô‡∂∂‡∑ä ‡∂¥‡∑í‡∂ß‡∑î‡∑Ä‡∂ö‡∑ä.</p>
            </div>

            <!-- Feature 2 -->
            <div class="feature-card">
                <div class="f-icon" style="background: #fff9e6; color: #FFA502;">
                    <i class="fa-solid fa-calculator"></i>
                </div>
                <h3 class="lang-en">Smart Billing</h3>
                <h3 class="lang-si hidden">‡∂∂‡∑í‡∂Ω‡∑ä‡∂¥‡∂≠‡∑ä ‡∂¥‡∂Ø‡∑ä‡∂∞‡∂≠‡∑í‡∂∫</h3>
                <p class="lang-en text-gray">Issue digital receipts and track your daily profit/loss easily.</p>
                <p class="lang-si hidden text-gray">‡∂©‡∑í‡∂¢‡∑í‡∂ß‡∂Ω‡∑ä ‡∂∂‡∑í‡∂Ω‡∑ä‡∂¥‡∂≠‡∑ä ‡∂±‡∑í‡∂ö‡∑î‡∂≠‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏ ‡∑É‡∑Ñ ‡∂Ω‡∑è‡∂∑ ‡∂Ö‡∂Ω‡∑è‡∂∑ ‡∂ú‡∂´‡∂±‡∂∫.</p>
            </div>

            <!-- Feature 3 -->
            <div class="feature-card">
                <div class="f-icon" style="background: #fff0f0; color: #ff4757;">
                    <i class="fa-solid fa-users"></i>
                </div>
                <h3 class="lang-en">More Customers</h3>
                <h3 class="lang-si hidden">‡∂±‡∑Ä ‡∂¥‡∑è‡∂ª‡∑í‡∂∑‡∑ù‡∂ú‡∑í‡∂ö‡∂∫‡∑í‡∂±‡∑ä</h3>
                <p class="lang-en text-gray">Get listed on our main food app and reach thousands of locals.</p>
                <p class="lang-si hidden text-gray">‡∂Ö‡∂¥‡∂ú‡∑ö ‡∂¥‡∑ä‚Äç‡∂ª‡∂∞‡∑è‡∂± ‡∂á‡∂¥‡∑ä ‡∂ë‡∂ö ‡∑Ñ‡∂ª‡∑Ñ‡∑è ‡∂±‡∑Ä ‡∂¥‡∑è‡∂ª‡∑í‡∂∑‡∑ù‡∂ú‡∑í‡∂ö‡∂∫‡∑í‡∂±‡∑ä ‡∑É‡∑ú‡∂∫‡∑è‡∂ú‡∂±‡∑ä‡∂±.</p>
            </div>
        </div>
    </div>

    <!-- 5. PRICING BANNER -->
    <div class="landing-container">
        <div class="pricing-banner">
            <i class="fa-solid fa-crown text-yellow fa-3x mb-1"></i>
            <h2 class="lang-en" style="color: white; font-size: 2.2rem;">Complete Suite for <span style="color:#2ed573">Rs. 1500</span></h2>
            <h2 class="lang-si hidden" style="color: white; font-size: 2.2rem;">‡∑É‡∑í‡∂∫‡∂Ω‡∑ä‡∂Ω‡∂∏ ‡∂∏‡∑è‡∑É‡∂∫‡∂ö‡∂ß <span style="color:#2ed573">‡∂ª‡∑î. 1500</span> ‡∂¥‡∂∏‡∂´‡∂∫‡∑í</h2>
            
            <div class="pricing-grid">
                <div class="p-item"><i class="fa-solid fa-check text-green"></i> <span class="lang-en">Unlimited Orders</span><span class="lang-si hidden">‡∂á‡∂´‡∑Ä‡∑î‡∂∏‡∑ä ‡∂Ö‡∑É‡∑ì‡∂∏‡∑í‡∂≠‡∂∫‡∑í</span></div>
                <div class="p-item"><i class="fa-solid fa-check text-green"></i> <span class="lang-en">0% Commissions</span><span class="lang-si hidden">‡∂ö‡∑ú‡∂∏‡∑í‡∑É‡∑ä ‡∂ª‡∑Ñ‡∑í‡∂≠‡∂∫‡∑í</span></div>
                <div class="p-item"><i class="fa-solid fa-check text-green"></i> <span class="lang-en">Unlimited Menu Items</span><span class="lang-si hidden">‡∂ö‡∑ë‡∂∏ ‡∑Ä‡∂ª‡∑ä‡∂ú ‡∂Ö‡∑É‡∑ì‡∂∏‡∑í‡∂≠‡∂∫‡∑í</span></div>
                <div class="p-item"><i class="fa-solid fa-check text-green"></i> <span class="lang-en">Monthly Reports</span><span class="lang-si hidden">‡∂Ω‡∑è‡∂∑ ‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è</span></div>
            </div>

            <button onclick="authLogin()" class="btn btn-primary" style="background: #2ed573; padding: 15px 40px; font-size: 1.1rem; border-radius: 50px; box-shadow: 0 10px 30px rgba(46, 213, 115, 0.4);">
                <span class="lang-en">Start Free Trial Now</span>
                <span class="lang-si hidden">‡∂Ø‡∑ê‡∂±‡∑ä‡∂∏ ‡∂¥‡∂ß‡∂±‡∑ä ‡∂ú‡∂±‡∑ä‡∂±</span>
            </button>
        </div>
    </div>

    <!-- 6. FOOTER -->
      <!-- FOOTER -->
    <footer>
        <div class="footer-grid">
            <div class="footer-col">
                <h3>EatlyHub</h3>
                <p style="color: #a4b0be; font-size: 0.9rem;">Connecting food lovers with the best local flavors. The fairest platform for merchants.</p>
                <div class="social-links mt-2">
                    <a href="#"><i class="fa-brands fa-facebook-f"></i></a>
                    <a href="#"><i class="fa-brands fa-instagram"></i></a>
                    <a href="#"><i class="fa-brands fa-tiktok"></i></a>
                </div>
            </div>
            <div class="footer-col">
                <h3>Accounts</h3>
                <ul>
                    <li><a href="#" onclick="loginCustomer()">Customer Login</a></li>
                    <li><a href="index.html">Merchant Login</a></li>
                    <li><a href="riders.html">Rider Login</a></li>
                </ul>
            </div>
            <div class="footer-col">
                <h3>Company</h3>
                <ul>
                    <li><a href="#">About Us</a></li>
                    <li><a href="#">Privacy Policy</a></li>
                    <li><a href="#">Terms of Service</a></li>
                    <li><a href="#">Contact Support</a></li>
                </ul>
            </div>
            <div class="footer-col">
                <h3>Newsletter</h3>
                <p style="font-size:0.85rem; color:#a4b0be;">Get discounts and updates.</p>
                <div style="display:flex; margin-top:10px;">
                    <input type="email" placeholder="Email" style="padding:10px; border-radius:8px 0 0 8px; border:none; width:100%;">
                    <button style="background:var(--primary); color:white; border:none; padding:0 15px; border-radius:0 8px 8px 0;"><i class="fa-solid fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
        <div class="copyright">
            &copy; 2025 EatlyHub Technologies. All Rights Reserved.
        </div>
    </footer>


    <!-- 7. PROFIT LOSS MODAL (UNCHANGED LOGIC) -->
    <div id="profit-modal" class="profit-modal-overlay">
        <div class="profit-modal">
            <div style="background: #FF4757; color: white; padding: 20px; text-align: center;">
                <div class="flex justify-between center">
                    <h3 style="color:white; margin:0; font-size: 1.2rem;"><i class="fa-solid fa-triangle-exclamation"></i> Are You Losing Money?</h3>
                    <button onclick="closeProfitModal()" style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;">&times;</button>
                </div>
            </div>
            
            <div style="padding: 25px;">
                <div class="text-center mb-1">
                    <p class="lang-en text-gray" style="font-size: 0.9rem;">If you sell a Rice Packet for <b>Rs. 1,000</b> on other apps:</p>
                    <p class="lang-si hidden text-gray" style="font-size: 0.9rem;">‡∑Ä‡∑ô‡∂±‡∂≠‡∑ä ‡∂á‡∂¥‡∑ä ‡∑Ä‡∂Ω ‡∂ª‡∑î. 1,000 ‡∂ö ‡∂ö‡∑ë‡∂∏‡∂ö‡∑ä ‡∑Ä‡∑í‡∂ö‡∑î‡∂´‡∑î‡∑Ä‡∑ú‡∂≠‡∑ä:</p>
                </div>

                <div style="background: #FFF0F0; border: 1px solid #ff4757; color: #ff4757; padding: 15px; border-radius: 16px; margin-bottom: 15px; display:flex; justify-content:space-between; align-items:center;">
                    <div class="text-left"><small class="bold">COMMISSION (30%)</small></div>
                    <h3 style="margin:0; font-size:1.4rem;">- Rs. 300</h3>
                </div>

                <div style="background: #2f3542; color: white; padding: 20px; border-radius: 20px; text-align: center; margin-bottom: 20px;">
                    <small style="text-transform: uppercase; color: #a4b0be; font-size:0.75rem; letter-spacing:1px;">10 Orders/Day = Monthly Loss</small>
                    <h1 class="loss-text" style="color: #ff4757; font-size: 2.5rem; margin: 10px 0;">Rs. 90,000</h1>
                    <small class="lang-en" style="color:#dfe4ea;">Don't let them eat your profit!</small>
                    <small class="lang-si hidden" style="color:#dfe4ea;">‡∂î‡∂∂‡∑ö ‡∂Ω‡∑è‡∂∑‡∂∫ ‡∂î‡∑Ä‡∑î‡∂±‡∑ä‡∂ß ‡∂ö‡∂±‡∑ä‡∂± ‡∂Ø‡∑ô‡∂±‡∑ä‡∂± ‡∂ë‡∂¥‡∑è!</small>
                </div>

                <div style="background: #E7FFF0; border: 1px solid #2ed573; color: #2ed573; padding: 15px; border-radius: 16px; text-align:center; margin-bottom:20px;">
                    <span class="lang-en">With <b>EatlyHub</b>, pay only <br><span style="font-size:1.3rem; font-weight:800;">Rs. 1,500 / Month</span></span>
                    <span class="lang-si hidden"><b>EatlyHub</b> ‡∑É‡∂∏‡∂ü ‡∂∏‡∑è‡∑É‡∂∫‡∂ß‡∂∏ <br><span style="font-size:1.3rem; font-weight:800;">‡∂ª‡∑î. 1,500 ‡∂ö‡∑ä ‡∂¥‡∂∏‡∂´‡∂∫‡∑í</span></span>
                </div>

                <button class="btn btn-primary w-100" onclick="authLogin()" style="border-radius: 12px; padding: 15px; font-size: 1.1rem; margin:0;">
                    <span class="lang-en">Start Saving Today</span>
                    <span class="lang-si hidden">‡∂Ö‡∂Ø‡∂∏ ‡∂Ω‡∑è‡∂∑ ‡∂Ω‡∂∂‡∂±‡∑ä‡∂±</span>
                </button>
            </div>
        </div>
    </div>
</template>
    
<!-- 2. DASHBOARD SHELL (User & Admin) -->
<template id="tpl-dashboard">
    <nav>
        <div class="nav-brand">
            <i class="fa-solid fa-utensils"></i> EatlyHub 
            <span id="admin-tag" class="hidden" style="font-size:0.6rem; background:var(--secondary); color:white; padding:2px 8px; border-radius:6px; margin-left:5px;">ADMIN</span>
        </div>
        <!-- Mobile Logout -->
        <button class="btn btn-secondary" style="width:auto; padding:6px 12px; font-size:0.8rem; margin:0; border-radius:50px;" onclick="authLogout()">
            <i class="fa-solid fa-right-from-bracket"></i>
        </button>
    </nav>

    <div class="tabs-wrapper">
        <div class="tabs-container" id="dash-tabs">
            <!-- Injected by JS -->
        </div>
        <!-- Desktop Sidebar Logout -->
        <div class="sidebar-logout" onclick="authLogout()">
            <i class="fa-solid fa-right-from-bracket"></i> Logout
        </div>
    </div>

    <div id="dash-content" style="padding: 20px;">
        <!-- Content Injected by JS -->
    </div>
</template>

<!-- ================= JAVASCRIPT LOGIC ================= -->

<script>
    // ============================================
    // IMPORTANT: REPLACE WITH YOUR ADMIN EMAIL
    // ============================================
    const ADMIN_EMAIL = "admin@eatlyhub.com"; 

    // --- 1. CONFIGURATION ---
    const firebaseConfig = {
      apiKey: "AIzaSyA4mlpgLA8l1N8VHqwpVLbPXvDvPxGPcSI",
      authDomain: "eatlyhub.firebaseapp.com",
      projectId: "eatlyhub",
      storageBucket: "eatlyhub.firebasestorage.app",
      messagingSenderId: "1094045089044",
      appId: "1:1094045089044:web:397e0fd73412a07c3ad601",
      measurementId: "G-V3K3QB1715"
    };

    // --- 2. INIT FIREBASE ---
    try {
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    } catch(e) { 
        console.error("Firebase Init Error", e); 
    }
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    // --- 3. STATE MANAGEMENT ---
    const app = document.getElementById('app');
    let currentUser = null;
    let bizProfile = {};
    let bizOrders = [];
    let bizReviews = [];
    let adminRequests = [];
    let currentTab = 'Dashboard';
    let profileMap = null;
    let profileMarker = null;
    let profileCircle = null;
    let publicMap = null;
    
    // Customer Map Variables
    let customerMap = null;
    let customerMarker = null;
    let customerLocation = null;

    // Tabs List (User)
    const TABS_CONFIG = [
        { name: 'Dashboard', icon: 'fa-chart-pie' },
        { name: 'Profile', icon: 'fa-user-gear' },
        { name: 'Open/Close', icon: 'fa-store' },
        { name: 'Add Foods', icon: 'fa-burger' },
        { name: 'My Webpage', icon: 'fa-globe' },
        { name: 'Reviews', icon: 'fa-star' },
        { name: 'New Orders', icon: 'fa-bell' },
        { name: 'Confirmed Orders', icon: 'fa-circle-check' },
        { name: 'Active Orders', icon: 'fa-fire-burner' },
        { name: 'Ready Orders', icon: 'fa-bag-shopping' },
        { name: 'Completed Orders', icon: 'fa-list-check' },
        { name: 'Unpaid Bills', icon: 'fa-file-invoice-dollar' },
        { name: 'Reports', icon: 'fa-chart-line' },
        { name: 'Admin Messages', icon: 'fa-headset' }
    ];

    // Tabs List (Admin)
    const ADMIN_TABS = ['Verification Requests', 'Admin Messages'];

    // --- 4. IMAGE UTILITIES ---
    
    function compressImage(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 800;
                    const scaleSize = MAX_WIDTH / img.width;
                    canvas.width = MAX_WIDTH;
                    canvas.height = img.height * scaleSize;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    resolve(canvas.toDataURL('image/jpeg', 0.7)); 
                };
                img.onerror = (err) => reject(err);
            };
            reader.onerror = (err) => reject(err);
        });
    }

    function uploadImageToStorage(base64DataUrl, path) {
        return new Promise((resolve, reject) => {
            const ref = storage.ref(path);
            const task = ref.putString(base64DataUrl, 'data_url');
            task.on('state_changed', null, (error) => reject(error), 
                () => { task.snapshot.ref.getDownloadURL().then(resolve); }
            );
        });
    }

    // --- 5. ROUTING ---
    window.addEventListener('load', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const bizId = urlParams.get('biz');
        const orderId = urlParams.get('orderId');

        if (bizId && orderId) {
            loadCustomerConfirmPage(bizId, orderId);
        } else if (bizId) {
            loadPublicPage(bizId);
        } else {
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    if(user.email === ADMIN_EMAIL) {
                        loadAdminDashboard();
                    } else {
                        loadDashboard();
                    }
                } else {
                    render('tpl-landing');
                }
            });
        }
    });

    function render(tplId) {
        app.innerHTML = '';
        const tpl = document.getElementById(tplId);
        if(tpl) app.appendChild(tpl.content.cloneNode(true));
    }

    // --- 6. AUTHENTICATION ---
    function authLogin() {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider).catch(e => showToast("Login Error: " + e.message, 'error'));
    }
    
    function authLogout() { 
        auth.signOut().then(() => window.location.reload()); 
    }

    // --- 7. ADMIN DASHBOARD LOGIC ---
    function loadAdminDashboard() {
        render('tpl-dashboard');
        document.getElementById('admin-tag').classList.remove('hidden');
        
        const tabsContainer = document.getElementById('dash-tabs');
        tabsContainer.innerHTML = ADMIN_TABS.map(t => 
            `<div class="tab-btn" onclick="switchAdminTab('${t}')"><i class="fa-solid fa-shield-halved"></i> ${t}</div>`
        ).join('');

        db.collection('admin_requests').onSnapshot(snap => {
            adminRequests = snap.docs.map(d => ({id: d.id, ...d.data()}));
            refreshAdminContent();
        });

        switchAdminTab('Verification Requests');
    }

    function switchAdminTab(name) {
        currentTab = name;
        document.querySelectorAll('.tab-btn').forEach(b => {
            b.classList.toggle('active', b.innerText.includes(name));
        });
        refreshAdminContent();
    }

    function refreshAdminContent() {
        const container = document.getElementById('dash-content');
        container.innerHTML = '';

        if(currentTab === 'Verification Requests') {
            if(adminRequests.length === 0) {
                container.innerHTML = '<div class="card text-center text-gray"><h3>No Pending Requests</h3><p>All verification requests have been processed.</p></div>';
                return;
            }
            container.innerHTML = adminRequests.map(r => `
                <div class="card">
                    <h4>${r.name}</h4>
                    <p>Request ID: ${r.id}</p>
                    <div class="flex flex-col mt-1" style="gap:10px;">
                        <div>
                            <small>Grama Niladhari Letter</small>
                            <img src="${r.letter}" style="width:100%; max-height:200px; object-fit:contain; border:1px solid #eee; border-radius:12px;">
                        </div>
                        <div>
                            <small>Payment Slip</small>
                            <img src="${r.slip}" style="width:100%; max-height:200px; object-fit:contain; border:1px solid #eee; border-radius:12px;">
                        </div>
                    </div>
                    <div class="flex mt-2" style="gap:10px;">
                        <button class="btn btn-green" onclick="approveUser('${r.uid}', '${r.id}')"><i class="fa-solid fa-check"></i> Approve</button>
                        <button class="btn btn-outline" style="border-color:red; color:red;" onclick="rejectRequest('${r.id}')"><i class="fa-solid fa-xmark"></i> Reject</button>
                    </div>
                </div>
            `).join('');
        } else {
            container.innerHTML = '<div class="card text-center"><h3>Admin Inbox</h3><p>Real-time chat with admin coming soon!</p></div>';
        }
    }

    function approveUser(uid, reqId) {
        if(confirm("Confirm Verification for this user?")) {
            db.collection('users').doc(uid).update({verified: true}).then(() => {
                db.collection('admin_requests').doc(reqId).delete();
                showToast("User Verified Successfully!", 'success');
            }).catch(e => showToast("Failed to approve user: " + e.message, 'error'));
        }
    }

    function rejectRequest(reqId) {
        if(confirm("Reject this request?")) {
            db.collection('admin_requests').doc(reqId).delete();
            showToast("Request Rejected", 'info');
        }
    }

    // --- 8. USER DASHBOARD LOGIC ---
    async function loadDashboard() {
        render('tpl-dashboard');
        
        // Generate Tabs
        const tabsContainer = document.getElementById('dash-tabs');
        tabsContainer.innerHTML = TABS_CONFIG.map(t => 
            `<div class="tab-btn" onclick="switchTab('${t.name}')">
                <i class="fa-solid ${t.icon}"></i> ${t.name}
             </div>`
        ).join('');

        // Real-time Listeners
        db.collection('users').doc(currentUser.uid).onSnapshot(doc => {
            if(doc.exists) {
                bizProfile = doc.data();
            } else {
                bizProfile = { 
                    locked: false, verified: false, foods: [], schedule: {}, 
                    heroText: 'Welcome to our Kitchen!', socialLinks: {},
                    serviceLocation: { lat: 6.9271, lng: 79.8612 },
                    serviceRadius: 5, canDeliver: false, deliveryCost: 0, nearbyTowns: ""
                };
                db.collection('users').doc(currentUser.uid).set(bizProfile);
            }
            if(currentTab === 'Profile') refreshTabContent();
        });

        db.collection('users').doc(currentUser.uid).collection('orders')
          .orderBy('time', 'desc').limit(50)
          .onSnapshot(snap => {
              bizOrders = snap.docs.map(d => ({id: d.id, ...d.data()}));
              const newOrders = bizOrders.filter(o => o.status === 'new' && !o.seen);
              if(newOrders.length > 0) showToast(`üîî ${newOrders.length} New Order(s) Received!`, 'success');
              if(currentTab !== 'Profile') refreshTabContent();
          });
          
        db.collection('users').doc(currentUser.uid).collection('reviews')
          .orderBy('time', 'desc').limit(20)
          .onSnapshot(snap => {
              bizReviews = snap.docs.map(d => ({id: d.id, ...d.data()}));
              if(currentTab !== 'Profile') refreshTabContent();
          });

        switchTab('Dashboard');
    }

    function switchTab(name) {
        if (name !== 'Dashboard' && name !== 'Profile' && name !== 'Admin Messages' && (!bizProfile.locked)) {
            showToast("‚ö† Please complete and LOCK your Profile first.", "error");
            name = 'Profile';
        }

        currentTab = name;
        document.querySelectorAll('.tab-btn').forEach(b => {
            b.classList.toggle('active', b.innerText.includes(name));
        });
        
        const activeBtn = document.querySelector('.tab-btn.active');
        if(activeBtn && window.innerWidth < 900) activeBtn.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });

        refreshTabContent();
    }

    function refreshTabContent() {
        const container = document.getElementById('dash-content');
        if (!container || !currentUser) return;

        container.innerHTML = ''; 

        if(currentTab === 'Dashboard') renderDashHome(container);
        else if(currentTab === 'Profile') { renderProfile(container); setTimeout(initProfileMap, 500); }
        else if(currentTab === 'Open/Close') renderSchedule(container);
        else if(currentTab === 'Add Foods') renderAddFoods(container);
        else if(currentTab === 'My Webpage') renderWebpageInfo(container);
        else if(currentTab === 'Reviews') renderReviews(container);
        else if(currentTab === 'Reports') renderReports(container);
        else if(currentTab === 'Admin Messages') renderAdminChat(container);
        else renderOrdersList(container, currentTab);
    }

    // A) DASHBOARD HOME
    function renderDashHome(target) {
        const now = new Date();
        const todayStr = now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        const timeStr = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        const todayISO = now.toISOString().split('T')[0];
        const todayOrders = bizOrders.filter(o => {
            const orderDate = new Date(o.time).toISOString().split('T')[0];
            return orderDate === todayISO;
        });

        const newCount = todayOrders.filter(o => o.status === 'new').length;
        const confirmCount = todayOrders.filter(o => o.status === 'confirmed').length;
        const activeCount = todayOrders.filter(o => o.status === 'active').length;
        const readyCount = todayOrders.filter(o => o.status === 'ready').length;
        const completedCount = todayOrders.filter(o => o.status === 'completed').length;
        const unpaidCount = todayOrders.filter(o => o.status === 'unpaid').length;
        
        const dailyRev = todayOrders.filter(o => o.status === 'completed').reduce((a,b) => a + Number(b.total), 0);
        const verifyAction = `onclick="switchTab('Profile'); setTimeout(() => document.getElementById('verify-section').scrollIntoView({behavior:'smooth'}), 500)"`;

        target.innerHTML = `
            <div class="card center flex-col text-center" style="background: linear-gradient(180deg, #ffffff, #f7f9fc);">
                <img src="${bizProfile.logo || 'https://cdn-icons-png.flaticon.com/512/847/847969.png'}" style="width:100px;height:100px;border-radius:50%;object-fit:cover;margin-bottom:15px;border:4px solid var(--bg-body); box-shadow: var(--shadow-sm);">
                <h3>${bizProfile.businessName || 'Setup Your Business Profile'}</h3>
                ${bizProfile.verified 
                    ? '<div class="status-badge st-new"><i class="fa-solid fa-check-circle"></i> Verified Business</div>' 
                    : `<div class="status-badge st-unverified" ${verifyAction}><i class="fa-solid fa-circle-exclamation"></i> Not Verified (Click to Fix)</div>`}
            </div>

            <div class="mb-2">
                <div class="flex justify-between center mb-1">
                    <h4 style="margin:0"><i class="fa-regular fa-calendar"></i> Today's Stats</h4>
                    <div style="text-align:right;">
                        <div class="bold text-red" style="font-size: 1.1rem;">${timeStr}</div>
                        <small>${todayStr}</small>
                    </div>
                </div>

                <div class="stat-grid">
                    <div class="stat-card" style="border-bottom: 4px solid var(--primary);" onclick="switchTab('New Orders')">
                        <h2 class="text-red">${newCount}</h2>
                        <small>New Orders</small>
                    </div>
                    <div class="stat-card" style="border-bottom: 4px solid var(--yellow);" onclick="switchTab('Confirmed Orders')">
                        <h2 class="text-yellow">${confirmCount}</h2>
                        <small style="color:#ffa502">Confirmed</small>
                    </div>
                    <div class="stat-card" style="border-bottom: 4px solid var(--blue);" onclick="switchTab('Active Orders')">
                        <h2 style="color:var(--blue)">${activeCount}</h2>
                        <small style="color:#2f3542">Cooking</small>
                    </div>
                    <div class="stat-card" style="border-bottom: 4px solid var(--primary);" onclick="switchTab('Ready Orders')">
                        <h2 style="color:var(--primary)">${readyCount}</h2>
                        <small style="color:#ff6b81">Ready</small>
                    </div>
                    <div class="stat-card" style="border-bottom: 4px solid var(--green);" onclick="switchTab('Completed Orders')">
                        <h2 class="text-green">${completedCount}</h2>
                        <small class="text-green">Completed</small>
                    </div>
                     <div class="stat-card" style="border-bottom: 4px solid #ffa502;" onclick="switchTab('Unpaid Bills')">
                        <h2 style="color:#ffa502">${unpaidCount}</h2>
                        <small class="text-red">Unpaid</small>
                    </div>
                </div>

                <div class="card text-center" style="background:var(--secondary); color:white; border:none; box-shadow: var(--shadow-float);">
                    <h1 style="color:white; margin-bottom:5px;">Rs. ${dailyRev.toLocaleString()}</h1>
                    <small style="color:#a4b0be; text-transform: uppercase; letter-spacing: 1px;">Total Revenue Today</small>
                </div>
            </div>
            
            <div class="card">
                <h4><i class="fa-solid fa-magnifying-glass"></i> Quick Search</h4>
                <div class="input-group">
                    <label>Track Order Number</label>
                    <input type="text" placeholder="e.g. 12345" onkeyup="searchOrder(this.value)">
                    <div id="res-order" class="mt-1"></div>
                </div>
                <div class="input-group">
                    <label>Check Unpaid Customer (WhatsApp)</label>
                    <input type="text" placeholder="e.g. 9477..." onkeyup="searchUnpaid(this.value)">
                    <div id="res-unpaid" class="mt-1"></div>
                </div>
            </div>
        `;
    }

    // B) PROFILE
    function renderProfile(target) {
        const p = bizProfile;
        const disabled = p.locked ? 'disabled' : '';
        
        let logoHtml = '';
        if(p.logo && p.locked) {
            logoHtml = `<img src="${p.logo}" style="width:100px;height:100px;border-radius:50%;object-fit:cover; box-shadow: var(--shadow-sm);">`;
        } else if(p.logo || p.tempLogo) { 
             logoHtml = `
                <img src="${p.tempLogo || p.logo}" style="width:100px;height:100px;border-radius:50%;object-fit:cover; box-shadow: var(--shadow-sm);">
                <button class="btn btn-outline mt-1" style="padding:6px 12px; font-size:0.8rem; width:auto;" onclick="removeLogo()">Remove Logo</button>
             `;
        } else {
            logoHtml = `<label class="btn btn-secondary mt-1" style="width:auto;padding:8px 16px;font-size:0.8rem"><i class="fa-solid fa-camera"></i> Upload Logo <input type="file" hidden onchange="handleImageUpload(this, 'logo')"></label>`;
        }
        
        target.innerHTML = `
            <div class="card">
                <h3>Business Profile</h3>
                <p class="text-red" style="font-size:0.85rem; background:#FFF0F0; padding: 12px; border-radius: 12px; border: 1px solid var(--primary);">All fields required. Lock profile to enable other tabs.</p>
                
                <div class="center flex-col mb-1" id="logo-section">${logoHtml}</div>

                <div class="input-group"><label>Business Name</label><input id="p-name" value="${p.businessName||''}" ${disabled}></div>
                <div class="input-group"><label>Business Address / Home Address</label><textarea id="p-addr" ${disabled} rows="2">${p.address||''}</textarea></div>
                <div class="input-group"><label>Owner Name</label><input id="p-owner" value="${p.ownerName||''}" ${disabled}></div>
                <div class="input-group"><label>Reg No / NIC</label><input id="p-nic" value="${p.nic||''}" ${disabled}></div>
                <div class="input-group"><label>Hotline</label><input type="tel" id="p-hot" value="${p.hotline||''}" ${disabled}></div>
                <div class="input-group"><label>WhatsApp Number</label><input type="tel" id="p-wa" value="${p.whatsapp||''}" ${disabled}></div>
                
                <div class="input-group mt-2" style="border-top:1px solid #eee; padding-top:20px;">
                    <h3><i class="fa-solid fa-map-location-dot"></i> Service Area & Delivery</h3>
                    <p class="text-gray" style="font-size:0.85rem">Click on map to set your location. Use slider to set service radius.</p>
                    <div id="map" class="map-container"></div>
                    
                    <div class="input-group mt-1">
                        <label>Service Radius: <span id="rad-val" class="text-red bold">${p.serviceRadius || 5}</span> km</label>
                        <input type="range" id="p-radius" min="1" max="20" value="${p.serviceRadius || 5}" oninput="updateCircle(this.value)" ${disabled}>
                    </div>

                    <div class="input-group">
                        <label>Nearby Towns (Auto-Detected or Edit)</label>
                        <input id="p-towns" value="${p.nearbyTowns||''}" ${disabled}>
                    </div>

                    <div class="input-group flex center justify-between" style="background:#f8f9fa; padding:15px; border-radius:16px;">
                        <label style="margin:0">Are you delivering food?</label>
                        <select id="p-deliver" style="width:auto; padding:8px;" ${disabled} onchange="toggleDeliveryCost(this.value)">
                            <option value="yes" ${p.canDeliver ? 'selected':''}>Yes</option>
                            <option value="no" ${!p.canDeliver ? 'selected':''}>No</option>
                        </select>
                    </div>

                    <div class="input-group ${p.canDeliver ? '':'hidden'}" id="cost-group">
                        <label>Delivery Cost (Rs.)</label>
                        <input type="number" id="p-cost" value="${p.deliveryCost||0}" ${disabled}>
                    </div>
                </div>

                ${p.locked 
                    ? `<button class="btn btn-yellow" onclick="toggleLock(false)"><i class="fa-solid fa-lock-open"></i> Unlock to Edit</button>` 
                    : `<button class="btn btn-primary" onclick="saveProfile()"><i class="fa-solid fa-lock"></i> Save & Lock Profile</button>`}
            </div>

            <div class="card" id="verify-section">
                <h3>Verification Badge (Rs 2500)</h3>
                ${p.verified ? '<div class="text-green bold text-center" style="font-size:1.1rem; padding:15px; background:#eafff3; border-radius:12px;">‚úÖ You are Verified!</div>' : `
                    <p class="mb-1 text-gray">Get the Green Badge to build trust. One-time payment.</p>
                    <div style="background:#f8f9fa; padding:15px; border-radius:12px; font-size:0.9rem; margin-bottom:15px; border: 1px solid #eee;">
                        <b>Bank:</b> Commercial Bank, Homagama<br>
                        <b>Acc:</b> 8750053306 (Colombage SD)<br>
                        <b>Amount:</b> Rs. 2,500
                    </div>
                    <div class="input-group">
                        <label>1. Grama Niladhari Letter</label>
                        <input type="file" id="v-letter" onchange="handleImageUpload(this, 'letter')">
                        <div id="stat-letter" class="text-green hidden mt-1 bold">‚úî Uploaded</div>
                    </div>
                    <div class="input-group">
                        <label>2. Payment Slip</label>
                        <input type="file" id="v-slip" onchange="handleImageUpload(this, 'slip')">
                        <div id="stat-slip" class="text-green hidden mt-1 bold">‚úî Uploaded</div>
                    </div>
                    <button class="btn btn-green" onclick="requestVerification()">Submit for Verification</button>
                    <button class="btn btn-outline" onclick="switchTab('Admin Messages')">Message Admin</button>
                `}
            </div>
        `;

        if(p.temp_letter) document.getElementById('stat-letter').classList.remove('hidden');
        if(p.temp_slip) document.getElementById('stat-slip').classList.remove('hidden');
    }

    function initProfileMap() {
        if(profileMap) profileMap.remove();
        
        const center = bizProfile.serviceLocation || { lat: 6.9271, lng: 79.8612 };
        profileMap = L.map('map').setView([center.lat, center.lng], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(profileMap);

        profileMarker = L.marker([center.lat, center.lng], {draggable: !bizProfile.locked}).addTo(profileMap);
        profileCircle = L.circle([center.lat, center.lng], {
            color: 'red', fillColor: '#f03', fillOpacity: 0.2,
            radius: (bizProfile.serviceRadius || 5) * 1000
        }).addTo(profileMap);

        if(!bizProfile.locked) {
            profileMap.on('click', function(e) {
                const { lat, lng } = e.latlng;
                profileMarker.setLatLng([lat, lng]);
                profileCircle.setLatLng([lat, lng]);
                bizProfile.serviceLocation = { lat, lng };
                fetchLocationName(lat, lng);
            });
            profileMarker.on('dragend', function(e) {
               const { lat, lng } = e.target.getLatLng();
               profileCircle.setLatLng([lat, lng]);
               bizProfile.serviceLocation = { lat, lng };
               fetchLocationName(lat, lng);
            });
        }
        setTimeout(() => { profileMap.invalidateSize(); }, 100);
    }

    function updateCircle(val) {
        document.getElementById('rad-val').innerText = val;
        if(profileCircle) profileCircle.setRadius(val * 1000);
        bizProfile.serviceRadius = Number(val);
    }

    function toggleDeliveryCost(val) {
        const costGroup = document.getElementById('cost-group');
        if(val === 'yes') costGroup.classList.remove('hidden');
        else costGroup.classList.add('hidden');
    }

    function fetchLocationName(lat, lng) {
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
            .then(res => res.json())
            .then(data => {
                const town = data.address.city || data.address.town || data.address.village || "Unknown Area";
                document.getElementById('p-towns').value = town;
            })
            .catch(err => console.log("Geocoding failed", err));
    }

    async function handleImageUpload(input, type) {
        if (input.files && input.files[0]) {
            showToast("Compressing & Uploading...", "info");
            try {
                const base64 = await compressImage(input.files[0]);
                const timestamp = Date.now();
                const path = `images/${currentUser.uid}/${type}_${timestamp}.jpg`;
                const downloadUrl = await uploadImageToStorage(base64, path);

                if(type === 'logo') {
                    bizProfile.tempLogo = downloadUrl;
                    renderProfile(document.getElementById('dash-content')); 
                    setTimeout(initProfileMap, 500);
                } else {
                    bizProfile['temp_' + type] = downloadUrl;
                    document.getElementById('stat-' + type).classList.remove('hidden');
                }
                showToast("Image Uploaded Successfully", "success");
            } catch (e) {
                showToast("Upload Error: " + e.message, "error");
            }
        }
    }
    
    function removeLogo() {
        if(confirm("Remove current logo?")) {
            if(bizProfile.logo) db.collection('users').doc(currentUser.uid).update({ logo: firebase.firestore.FieldValue.delete() });
            delete bizProfile.logo;
            delete bizProfile.tempLogo;
            renderProfile(document.getElementById('dash-content'));
            setTimeout(initProfileMap, 500);
            showToast("Logo removed from preview.", "info");
        }
    }

    function saveProfile() {
        const logo = bizProfile.tempLogo || bizProfile.logo;
        const name = document.getElementById('p-name').value;
        const addr = document.getElementById('p-addr').value;
        const owner = document.getElementById('p-owner').value;
        const nic = document.getElementById('p-nic').value;
        const hot = document.getElementById('p-hot').value;
        const wa = document.getElementById('p-wa').value;
        const towns = document.getElementById('p-towns').value;
        const canDeliver = document.getElementById('p-deliver').value === 'yes';
        const deliveryCost = canDeliver ? document.getElementById('p-cost').value : 0;
        const radius = document.getElementById('p-radius').value;

        if(!logo || !name || !addr || !owner || !nic || !hot || !wa) {
            return showToast("All profile fields and a Logo are REQUIRED!", "error");
        }

        const updatedProfile = {
            ...bizProfile,
            logo, businessName: name, address: addr, ownerName: owner, 
            nic, hotline: hot, whatsapp: wa, locked: true,
            serviceRadius: Number(radius), nearbyTowns: towns,
            canDeliver: canDeliver, deliveryCost: Number(deliveryCost)
        };
        delete updatedProfile.tempLogo;

        db.collection('users').doc(currentUser.uid).set(updatedProfile, {merge:true})
            .then(() => { showToast("Profile Locked & Saved!", "success"); switchTab('Dashboard'); })
            .catch(e => showToast("Save Failed: " + e.message, "error"));
    }

    function toggleLock(state) {
        if (!state && !confirm("Unlock profile for editing?")) return;
        db.collection('users').doc(currentUser.uid).update({locked: state})
            .then(() => showToast(`Profile ${state ? 'Locked' : 'Unlocked'}`, 'success'))
            .catch(e => showToast("Error: " + e.message, 'error'));
    }

    function requestVerification() {
        if(!bizProfile.temp_letter || !bizProfile.temp_slip) return showToast("Please upload both documents.", "error");
        showToast("Documents Submitted!", "success");
        db.collection('admin_requests').add({
            uid: currentUser.uid, name: bizProfile.businessName, 
            letter: bizProfile.temp_letter, slip: bizProfile.temp_slip,
            timestamp: new Date().toISOString()
        });
    }

    // C) OPEN / CLOSE
    function renderSchedule(target) {
        const today = new Date().toLocaleDateString('en-US', {weekday:'long'});
        const s = bizProfile.schedule?.[today] || {open: false, start:'08:00', end:'20:00'};
        
        target.innerHTML = `
            <div class="card">
                <h3>üìÖ Schedule for ${today}</h3>
                <div class="input-group">
                    <label>Status</label>
                    <select id="oc-stat" onchange="saveSched('${today}')" style="background:${s.open?'#eafff3':'#fff0f0'}">
                        <option value="yes" ${s.open?'selected':''}>Yes, Open</option>
                        <option value="no" ${!s.open?'selected':''}>No, Closed</option>
                    </select>
                </div>
                <div class="flex" style="gap:10px;">
                    <div class="input-group w-100">
                        <label>Open Time</label>
                        <input type="time" id="oc-start" value="${s.start}" onchange="saveSched('${today}')">
                    </div>
                    <div class="input-group w-100">
                        <label>Close Time</label>
                        <input type="time" id="oc-end" value="${s.end}" onchange="saveSched('${today}')">
                    </div>
                </div>
            </div>
            
            <div class="card text-white" style="background:${s.open ? 'var(--green)' : 'var(--secondary)'}; border:none;">
                <h3 class="text-white" style="margin:0;">Preview:</h3>
                <p class="text-white" style="margin:0;">${s.open ? `WE ARE OPEN (${s.start} - ${s.end})` : 'WE ARE CLOSED TODAY'}</p>
            </div>
        `;
    }

    function saveSched(day) {
        const open = document.getElementById('oc-stat').value === 'yes';
        const start = document.getElementById('oc-start').value;
        const end = document.getElementById('oc-end').value;
        const schedule = bizProfile.schedule || {};
        schedule[day] = { open, start, end };
        
        db.collection('users').doc(currentUser.uid).update({ schedule })
            .then(() => showToast(`Schedule for ${day} saved!`, 'success'));
    }

    // D) ADD FOODS
    let tempFoodImg = null;
    function renderAddFoods(target) {
        target.innerHTML = `
            <div class="card">
                <h3>Add New Menu Item</h3>
                <div class="input-group">
                    <label>Food Image</label>
                    <div class="file-upload-wrapper" onclick="document.getElementById('f-file').click()">
                        <span id="f-file-txt">${tempFoodImg ? 'Image Selected' : 'Click to Upload Image'}</span>
                        <input type="file" id="f-file" hidden onchange="handleFoodImg(this)">
                    </div>
                    <img id="f-prev" class="${tempFoodImg ? '' : 'hidden'} mt-1" src="${tempFoodImg || ''}" style="width:100%; height:150px; object-fit:cover; border-radius:12px;">
                </div>
                <div class="input-group"><label>Category</label><input id="f-cat" placeholder="e.g. Fried Rice"></div>
                <div class="input-group"><label>Food Name</label><input id="f-name" placeholder="Delicious Chicken"></div>
                <div class="flex" style="gap:15px">
                    <div class="input-group w-100"><label>Half Price (Rs.)</label><input id="f-half" type="number" placeholder="Optional"></div>
                    <div class="input-group w-100"><label>Full Price (Rs.)</label><input id="f-full" type="number" placeholder="Required if no half"></div>
                </div>
                <button class="btn btn-green mt-1" onclick="addFood()"><i class="fa-solid fa-plus"></i> Add to Menu</button>
            </div>
            
            <h3>Current Menu</h3>
            <div id="menu-list">
                ${(bizProfile.foods && bizProfile.foods.length > 0) ? bizProfile.foods.map((f,i) => `
                    <div class="card flex justify-between center" style="padding:15px; flex-direction:row;">
                        <div class="flex center">
                            <img src="${f.img}" style="width:60px;height:60px;border-radius:12px;margin-right:15px;object-fit:cover; box-shadow: var(--shadow-sm);">
                            <div>
                                <div class="bold" style="font-size:1rem;">${f.name}</div>
                                <small style="display:block;">${f.cat}</small>
                                <div style="font-size:0.85rem; font-weight:600; color:var(--primary);">
                                    ${f.half ? `H: ${f.half} ` : ''} ${f.full ? `F: ${f.full}` : ''}
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-secondary" style="width:auto;padding:6px 12px; border-radius:50px;" onclick="deleteFood(${i})"><i class="fa-solid fa-trash"></i></button>
                    </div>
                `).join('') : '<div class="card text-center text-gray"><h3>Menu is empty!</h3></div>'}
            </div>
        `;
    }

    async function handleFoodImg(input) {
        if(input.files[0]) {
            showToast("Compressing & Uploading...", "info");
            try {
                const base64 = await compressImage(input.files[0]);
                const timestamp = Date.now();
                const path = `food_images/${currentUser.uid}/${timestamp}.jpg`;
                const downloadUrl = await uploadImageToStorage(base64, path);
                tempFoodImg = downloadUrl;
                
                const img = document.getElementById('f-prev');
                img.src = tempFoodImg;
                img.classList.remove('hidden');
                document.getElementById('f-file-txt').innerText = "Image Ready";
                showToast("Food Image Ready", "success");
            } catch (e) { showToast("Upload Failed", "error"); }
        }
    }

    function addFood() {
        const cat = document.getElementById('f-cat').value.trim();
        const name = document.getElementById('f-name').value.trim();
        const half = document.getElementById('f-half').value.trim();
        const full = document.getElementById('f-full').value.trim();

        if(!tempFoodImg || !name || (!half && !full)) return showToast("Image, Name and at least one Price required.", "error");

        const foods = [...(bizProfile.foods||[]), {cat, name, img: tempFoodImg, half: half || null, full: full || null}];
        
        db.collection('users').doc(currentUser.uid).update({foods})
        .then(() => {
            showToast("Added to Menu!", "success");
            tempFoodImg = null;
            renderAddFoods(document.getElementById('dash-content'));
        });
    }

    function deleteFood(idx) {
        if(!confirm("Delete this item?")) return;
        const foods = bizProfile.foods.filter((_, i) => i !== idx);
        db.collection('users').doc(currentUser.uid).update({foods})
        .then(() => {
            showToast("Item Deleted", "info");
            renderAddFoods(document.getElementById('dash-content'));
        });
    }

    // E) MY WEBPAGE
    function renderWebpageInfo(target) {
        const url = `${window.location.origin}${window.location.pathname}?biz=${currentUser.uid}`;
        const links = bizProfile.socialLinks || {};
        
        target.innerHTML = `
            <div class="card text-center">
                <img src="${bizProfile.logo || 'https://via.placeholder.com/100'}" style="width:80px;height:80px;border-radius:50%;margin:0 auto 10px; border:3px solid var(--primary);">
                <h3>${bizProfile.businessName || 'Your Business Name'}</h3>
                <p>Share this link with customers:</p>
                <input class="w-100 p-2 mb-1 text-center" value="${url}" readonly style="background:#f1f2f6;border:none;border-radius:12px; color: #57606f;">
                <div class="flex" style="gap:15px; justify-content:center; margin-top:10px;">
                    <a href="${url}" target="_blank" class="btn btn-primary" style="width:auto;">Open Webpage</a>
                    <button class="btn btn-secondary" style="width:auto;" onclick="navigator.clipboard.writeText('${url}');showToast('Link copied!', 'info')">Copy</button>
                </div>
            </div>
            
            <div class="card">
                <h3>Social & Hero</h3>
                <div class="input-group">
                    <label>Welcome Message</label>
                    <input id="hero-txt" value="${bizProfile.heroText || 'Welcome!'}" onchange="updateWebSettings()">
                </div>
                <div class="input-group"><label>Facebook Link</label><input id="s-fb" value="${links.fb||''}" onchange="updateWebSettings()"></div>
                <div class="input-group"><label>Instagram Link</label><input id="s-ig" value="${links.ig||''}" onchange="updateWebSettings()"></div>
                <div class="input-group">
                    <label>YouTube Video URLs (Comma separated)</label>
                    <textarea id="s-yt" rows="3" onchange="updateWebSettings()">${links.yt||''}</textarea>
                </div>
            </div>
        `;
    }
    
    function updateWebSettings() {
        const heroText = document.getElementById('hero-txt').value.trim();
        const fb = document.getElementById('s-fb').value.trim();
        const ig = document.getElementById('s-ig').value.trim();
        const yt = document.getElementById('s-yt').value.trim();
        
        db.collection('users').doc(currentUser.uid).update({
            heroText, socialLinks: { fb, ig, yt }
        }).then(() => showToast("Webpage Settings Saved", 'success'));
    }

    // REVIEWS TAB
    function renderReviews(target) {
        if(bizReviews.length === 0) {
            target.innerHTML = `<div class="card text-center text-gray"><h3>No reviews yet.</h3></div>`;
            return;
        }

        target.innerHTML = bizReviews.map(r => `
            <div class="card">
                <div class="flex justify-between">
                    <b>${r.name || 'Anonymous'}</b>
                    <span class="text-yellow">${'‚òÖ'.repeat(r.stars)}</span>
                </div>
                <p class="mt-1">${r.text}</p>
                <small>${new Date(r.time).toLocaleDateString()}</small>
                <div class="mt-1 flex" style="gap:10px;">
                    ${r.status === 'pending' ? `<button class="btn btn-green" style="width:auto; padding:5px 12px;" onclick="updateReview('${r.id}', 'published')">Publish</button>` : '<span class="status-badge st-new">Published</span>'}
                    <button class="btn btn-outline" style="width:auto; padding:5px 12px; border-color:red; color:red;" onclick="deleteReview('${r.id}')">Delete</button>
                </div>
            </div>
        `).join('');
    }

    function updateReview(id, status) {
        db.collection('users').doc(currentUser.uid).collection('reviews').doc(id).update({status})
            .then(() => showToast(`Review ${status}.`, 'success'));
    }

    function deleteReview(id) {
        if(confirm("Delete this review?")) {
            db.collection('users').doc(currentUser.uid).collection('reviews').doc(id).delete()
                .then(() => showToast("Review deleted.", 'info'));
        }
    }

    // F) ORDERS WORKFLOW
    function renderOrdersList(target, tabName) {
        const map = {
            'New Orders': 'new', 'Confirmed Orders': 'confirmed', 
            'Active Orders': 'active', 'Ready Orders': 'ready', 
            'Completed Orders': 'completed', 'Unpaid Bills': 'unpaid'
        };
        const status = map[tabName];
        if(!status) return;

        const list = bizOrders.filter(o => o.status === status);
        if(list.length === 0) {
            target.innerHTML = `<div class="text-center p-2 text-gray mt-2"><h3 style="color:#ccc">No ${tabName}</h3></div>`;
            return;
        }

        target.innerHTML = list.map(o => {
            let actions = '';
            
            if(status === 'new') {
                actions = `
                    <div class="flex" style="gap:10px;">
                        <button class="btn btn-yellow" onclick="reqConfirm('${o.id}', '${o.custWa}')">Request Confirm</button>
                        <button class="btn btn-outline" style="border-color:var(--primary); color:var(--primary);" onclick="setStatus('${o.id}', 'canceled')">Decline</button>
                    </div>`;
            } else if(status === 'confirmed') {
                actions = `<button class="btn btn-primary" onclick="generateBill('${o.id}')">üñ® Bill & Cook</button>`;
            } else if(status === 'active') {
                actions = `
                    <div class="bill-wrapper">
                        <div class="watermark">NOT PAID</div>
                        <div class="bill-header">
                            <div class="bold" style="font-size:1.1em">${bizProfile.businessName}</div>
                            <small>#${o.orderNum}</small><br><small>${new Date(o.time).toLocaleString()}</small>
                        </div>
                        ${o.items.map(i => `<div class="bill-item"><span>${i.name} (${i.variant})</span><span>${i.price}</span></div>`).join('')}
                        ${o.deliveryType === 'delivery' ? `<div class="bill-item text-red"><span>Delivery</span><span>${o.deliveryFee}</span></div>` : ''}
                        <div class="bill-total"><span>Total</span><span>${o.total}</span></div>
                    </div>
                    <button class="btn btn-green mt-1" onclick="markReady('${o.id}', '${o.custWa}')">‚úÖ Mark Ready</button>
                `;
            } else if(status === 'ready') {
                actions = `
                    <div class="flex" style="gap:10px;">
                        <button class="btn btn-secondary" onclick="setStatus('${o.id}', 'completed')">üí∞ Paid</button>
                        <button class="btn btn-outline" style="border-color:var(--yellow); color:var(--yellow);" onclick="setStatus('${o.id}', 'unpaid')">‚ö† Unpaid</button>
                    </div>`;
            }

            const badge = o.deliveryType === 'delivery' ? `<div class="status-badge st-must-delivery mb-1" style="width:100%; text-align:center; justify-content:center;">üõµ MUST DELIVERY</div>` : '';
            const address = o.deliveryType === 'delivery' ? `<div class="mt-1 p-2" style="background:#fff0f0; border-radius:12px; font-size:0.85rem;"><b>Delivery To:</b><br>${o.deliveryAddress}</div>` : '';

            return `
                <div class="card status-${status}">
                    ${badge}
                    <div class="flex justify-between center">
                        <h4 class="text-red">Order #${o.orderNum}</h4>
                        <small class="bold">${new Date(o.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</small>
                    </div>
                    <div class="mb-1">
                        <b>${o.custName}</b> <a href="https://wa.me/${o.custWa}" target="_blank" class="btn btn-green" style="display:inline-block; width:auto; padding:2px 10px; font-size:12px; margin-left:10px; border-radius:20px;">‚úÜ WhatsApp</a>
                    </div>
                    ${address}
                    <div style="background:#f9f9f9; padding:15px; border-radius:12px; margin-top:10px;">
                        ${o.items.map(i => `<div>‚Ä¢ ${i.name} (${i.variant}) - Rs. ${i.price}</div>`).join('')}
                    </div>
                    <div class="text-right mt-1 bold" style="font-size:1.2rem; color:var(--secondary);">Total: Rs. ${o.total}</div>
                    <div class="mt-1">${actions}</div>
                </div>
            `;
        }).join('');
    }

    function reqConfirm(id, wa) {
        const link = `${window.location.origin}${window.location.pathname}?biz=${currentUser.uid}&orderId=${id}`;
        const msg = `Hello! Please confirm your *${bizProfile.businessName}* order here: ${link}`;
        window.open(`https://wa.me/${wa}?text=${encodeURIComponent(msg)}`, '_blank');
        showToast("Confirmation link sent.", "info");
    }

    function generateBill(id) {
        const o = bizOrders.find(x => x.id === id);
        setStatus(id, 'active'); 

        let txt = `üßæ *BILL - ${bizProfile.businessName}*\nOrder #${o.orderNum}\n\n`;
        o.items.forEach(i => txt += `${i.name} (${i.variant}): Rs. ${i.price}\n`);
        if(o.deliveryType === 'delivery') txt += `Delivery Fee: Rs. ${o.deliveryFee}\n`;
        txt += `\n*Total: Rs. ${o.total}*\nStatus: Preparing...`;
        
        window.open(`https://wa.me/${o.custWa}?text=${encodeURIComponent(txt)}`, '_blank');
    }

    function markReady(id, wa) {
        const o = bizOrders.find(x => x.id === id);
        const typeMsg = o.deliveryType === 'delivery' ? "is *READY for DELIVERY*!" : "is *READY*! Please pick up.";
        window.open(`https://wa.me/${wa}?text=${encodeURIComponent(`üçΩ Your order from *${bizProfile.businessName}* ${typeMsg}`)}`, '_blank');
        setStatus(id, 'ready');
    }

    function setStatus(id, status) {
        db.collection('users').doc(currentUser.uid).collection('orders').doc(id).update({status, seen: true})
            .then(() => showToast(`Status updated to '${status.toUpperCase()}'.`, 'success'));
    }

    // G) REPORTS
    function renderReports(target) {
        const sortedOrders = [...bizOrders].sort((a,b) => new Date(b.time) - new Date(a.time));
        const grouped = {};
        sortedOrders.forEach(o => {
            const dateStr = new Date(o.time).toLocaleDateString();
            if(!grouped[dateStr]) grouped[dateStr] = [];
            grouped[dateStr].push(o);
        });

        let tableHtml = '';
        if(sortedOrders.length === 0) {
            tableHtml = '<p class="text-center text-gray p-2">No order history available.</p>';
        } else {
            Object.keys(grouped).forEach(date => {
                tableHtml += `<h4 class="mt-2" style="background:#e1e4e8; padding:8px 12px; border-radius:8px; font-size:0.9rem;">${date}</h4>`;
                tableHtml += `
                <table class="report-table">
                    <thead><tr><th>Order #</th><th>Customer</th><th>Details</th><th>Status</th></tr></thead>
                    <tbody>
                        ${grouped[date].map(o => `
                            <tr>
                                <td data-label="Order #"><b>${o.orderNum}</b></td>
                                <td data-label="Customer">
                                    <b>${o.custName}</b><br>üìû ${o.custPhone || 'N/A'}
                                </td>
                                <td data-label="Details">
                                    ${o.items.map(i => `${i.name}`).join(', ')}<br>
                                    <b class="text-red">Rs. ${o.total}</b>
                                </td>
                                <td data-label="Status">${o.status.toUpperCase()}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>`;
            });
        }
        target.innerHTML = `<div class="card"><h3>üìú Sales Report</h3>${tableHtml}</div>`;
    }

    // H) ADMIN CHAT
    function renderAdminChat(target) {
        target.innerHTML = `
            <div class="card" style="height:60vh; display:flex; flex-direction:column;">
                <h3>Admin Support</h3>
                <div style="flex:1; display:flex; align-items:center; justify-content:center; color:#ccc;">
                    <p>üí¨ Chat coming soon!</p>
                </div>
            </div>
        `;
    }

    function searchOrder(val) {
        const resDiv = document.getElementById('res-order');
        if(!val || val.length < 2) { resDiv.innerHTML = ''; return; }
        const o = bizOrders.find(x => x.orderNum === val);
        resDiv.innerHTML = o ? `<div class="p-2 text-green" style="background:#eafff3; border-radius:12px; margin-top:10px;">Found: <b>${o.status.toUpperCase()}</b></div>` : '<small class="text-red">Not found.</small>';
    }

    function searchUnpaid(val) {
        const resDiv = document.getElementById('res-unpaid');
        if(val.length < 5) { resDiv.innerHTML = ''; return; }
        const found = bizOrders.filter(x => x.custWa.includes(val) && x.status === 'unpaid');
        resDiv.innerHTML = found.length ? `<div class="p-2 text-red" style="background:#fff0f0; border-radius:12px; margin-top:10px;">‚ö† <b>${found.length} Unpaid Bill(s)!</b></div>` : '<div class="text-green p-1">No unpaid records.</div>';
    }


    // ================= PUBLIC PAGE LOGIC =================
    let cart = [];
    let bizIdForCart = null;
    let bizOwnerWa = null;
    let publicBizData = null;

    async function loadPublicPage(bizId) {
        bizIdForCart = bizId;
        app.innerHTML = `<div style="height:100vh;display:flex;align-items:center;justify-content:center;flex-direction:column;background:#f9f9f9;"><div class="loader"></div><p class="mt-2 bold text-red">Loading Store...</p></div>`;
        
        const getYoutubeId = (url) => {
            const match = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/);
            return (match && match[2].length === 11) ? match[2] : null;
        };

        try {
            const doc = await db.collection('users').doc(bizId).get();
            if(!doc.exists || !doc.data().locked) {
                return app.innerHTML = "<div class='text-center p-2'><h2>Store Not Found</h2></div>";
            }
            const data = doc.data();
            publicBizData = data;
            bizOwnerWa = data.whatsapp;

            const reviewSnap = await db.collection('users').doc(bizId).collection('reviews').where('status', '==', 'published').limit(10).get();
            const reviews = reviewSnap.docs.map(d => d.data());

            const social = data.socialLinks || {};
            let ytGalleryHtml = '';
            if(social.yt) {
                const urls = social.yt.split(',').filter(u => u.trim() !== '');
                ytGalleryHtml = urls.map(u => {
                    const id = getYoutubeId(u.trim());
                    return id ? `<iframe src="https://www.youtube.com/embed/${id}" frameborder="0" allowfullscreen style="width:100%; height:200px; border-radius:12px; margin-bottom:10px;"></iframe>` : '';
                }).join('');
            }

            const deliveryBanner = data.canDeliver 
                ? `<div class="status-badge st-new mt-1">üõµ WE DELIVER</div>`
                : `<div class="status-badge st-unverified mt-1">üö∂ PICKUP ONLY</div>`;

            app.innerHTML = `
                <div id="public-view" style="background:#f9f9f9; min-height:100vh;">
                    <div id="public-status" class="p-1 text-center bold text-white" style="position:sticky; top:0; z-index:900; font-size:0.9rem;"></div>
                    
                    <div class="container p-2" style="background:white; border-radius:0 0 30px 30px; box-shadow:0 10px 30px rgba(0,0,0,0.05); text-align:center;">
                        <div class="center flex-col">
                            <img id="pub-logo" src="${data.logo || 'https://via.placeholder.com/100'}" style="width:120px; height:120px; border-radius:50%; object-fit:cover; border:5px solid var(--primary); margin-bottom:10px; margin-top:-10px;">
                            <h2 id="pub-name" style="margin:0; font-size:1.6rem;">${data.businessName}</h2>
                            ${data.verified ? `<div class="mt-1"><span class="status-badge st-new">Verified</span></div>` : ''}
                            ${deliveryBanner}
                            <p style="color:#888; margin-top:10px; font-size:0.9rem;">${data.address}</p>
                            
                            <div class="flex center mt-1" style="gap:15px;">
                                ${social.fb ? `<a href="${social.fb}" target="_blank" style="font-size:1.8rem; color:#3b5998;"><i class="fa-brands fa-facebook"></i></a>` : ''}
                                ${social.ig ? `<a href="${social.ig}" target="_blank" style="font-size:1.8rem; color:#d6249f;"><i class="fa-brands fa-instagram"></i></a>` : ''}
                            </div>
                            <div class="flex center mt-1" style="gap:10px; width:100%;">
                                <a href="tel:${data.hotline}" class="btn btn-green" style="flex:1; border-radius:50px;">Call</a>
                                <a href="https://wa.me/${data.whatsapp}" target="_blank" class="btn btn-green" style="flex:1; border-radius:50px;">Chat</a>
                            </div>
                        </div>
                    </div>

                    <div class="hero mt-2" style="border-radius:30px; padding:40px 20px; margin: 20px;">
                        <h2>${data.heroText || "Welcome!"}</h2>
                        <button class="btn btn-secondary mt-1" style="background:white; color:var(--primary); width:auto; border-radius:50px;" onclick="document.getElementById('pub-menu').scrollIntoView({behavior:'smooth'})">ORDER NOW</button>
                    </div>

                    <div class="p-2 container">
                        <h3>Our Location</h3>
                        <p class="text-gray" style="font-size:0.9rem">${data.nearbyTowns ? `Serving: ${data.nearbyTowns}` : ''}</p>
                        <div id="public-map" class="map-container" style="pointer-events:none;"></div>
                    </div>

                    ${ytGalleryHtml ? `<div class="p-2 container"><h3>Gallery</h3>${ytGalleryHtml}</div>` : ''}

                    <div id="pub-menu" class="p-2 container"></div>
                    
                    <div class="p-2 container mt-2" style="background:#fff; border-radius:20px; margin:20px; box-shadow: var(--shadow-card);">
                        <h3>Reviews</h3>
                        <div style="max-height:300px; overflow-y:auto; margin-bottom:15px;">
                            ${reviews.length ? reviews.map(r => `<div style="border-bottom:1px solid #eee; padding:15px 0;"><b>${r.name}</b> <span class="text-yellow">${'‚òÖ'.repeat(r.stars)}</span><p style="margin:5px 0;">${r.text}</p></div>`).join('') : '<p>No reviews yet.</p>'}
                        </div>
                        <input id="rev-name" class="w-100 p-1 mb-1" placeholder="Name">
                        <select id="rev-star" class="w-100 p-1 mb-1"><option value="5">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</option><option value="4">‚òÖ‚òÖ‚òÖ‚òÖ</option></select>
                        <textarea id="rev-text" class="w-100 p-1 mb-1" placeholder="Review..."></textarea>
                        <button class="btn btn-primary" onclick="submitReview('${bizId}')">Submit</button>
                    </div>
                    
                    <footer class="text-center p-2 mt-2" style="background:var(--secondary); color:white; border-radius:30px 30px 0 0; padding: 40px 20px;">
                        <h2 style="color:white;">${data.businessName}</h2>
                        <small>Powered by EatlyHub</small>
                    </footer>

                    <div class="floating-cart" onclick="showCartModal()">
                        <i class="fa-solid fa-cart-shopping"></i> <div class="cart-badge" id="cart-count">${cart.length}</div>
                    </div>
                </div>
            `;

            initPublicMap(data);

            const menuDiv = document.getElementById('pub-menu');
            menuDiv.innerHTML = '';
            const cats = [...new Set((data.foods||[]).map(f => f.cat))];
            
            if (data.foods && data.foods.length > 0) {
                cats.forEach(c => {
                    menuDiv.innerHTML += `<h3 class="mt-2 text-red" style="border-bottom:2px solid #eee; padding-bottom:5px;">${c||'Menu'}</h3>`;
                    data.foods.filter(f => f.cat === c).forEach(f => {
                        menuDiv.innerHTML += `
                            <div class="card flex justify-between center" style="padding:15px; margin-bottom:15px; flex-direction: row;">
                                <img src="${f.img}" style="width:80px;height:80px;border-radius:12px;object-fit:cover;margin-right:15px;">
                                <div style="flex:1;">
                                    <div class="bold" style="font-size:1rem; margin-bottom:5px;">${f.name}</div>
                                    <div class="mt-1 flex" style="gap:5px; flex-wrap:wrap;">
                                        ${f.half ? `<button class="btn btn-outline" style="width:auto;padding:5px 10px;font-size:11px;margin:0; border-radius:20px;" onclick="addToCart('${f.name}', 'Half', ${f.half})">Half: ${f.half}</button>` : ''}
                                        ${f.full ? `<button class="btn btn-outline" style="width:auto;padding:5px 10px;font-size:11px;margin:0; border-radius:20px;" onclick="addToCart('${f.name}', 'Full', ${f.full})">Full: ${f.full}</button>` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                });
            } else {
                menuDiv.innerHTML = `<div class="card text-center text-gray mt-4"><h3>Menu Empty!</h3></div>`;
            }

            const today = new Date().toLocaleDateString('en-US', {weekday:'long'});
            const sched = data.schedule?.[today];
            const statusDiv = document.getElementById('public-status');
            let isOpenNow = false;
            let statusText = "CLOSED NOW";
            let statusBg = 'var(--secondary)';

            if(sched && sched.open) {
                const now = new Date();
                const curMins = now.getHours() * 60 + now.getMinutes();
                const [sh, sm] = sched.start.split(':').map(Number);
                const [eh, em] = sched.end.split(':').map(Number);
                const startMins = sh * 60 + sm;
                const endMins = eh * 60 + em;
                
                if (endMins < startMins) { 
                    if (curMins >= startMins || curMins <= endMins) isOpenNow = true;
                } else {
                    if (curMins >= startMins && curMins <= endMins) isOpenNow = true;
                }
            }

            if(isOpenNow) {
                statusText = `OPEN NOW (${sched.start} - ${sched.end})`;
                statusBg = 'var(--green)';
            }

            statusDiv.innerText = statusText;
            statusDiv.style.background = statusBg;

        } catch (e) {
            console.error(e);
            app.innerHTML = "<div class='text-center p-2'><h2>Error Loading Page</h2></div>";
        }
    }

    function initPublicMap(data) {
        if(publicMap) publicMap.remove();
        const loc = data.serviceLocation || { lat: 6.9271, lng: 79.8612 };
        publicMap = L.map('public-map', {zoomControl: false, dragging: false, scrollWheelZoom: false}).setView([loc.lat, loc.lng], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(publicMap);
        
        L.marker([loc.lat, loc.lng]).addTo(publicMap);
        L.circle([loc.lat, loc.lng], {
            color: 'red', fillColor: '#f03', fillOpacity: 0.2,
            radius: (data.serviceRadius || 5) * 1000
        }).addTo(publicMap);
        
        setTimeout(() => { publicMap.invalidateSize(); }, 500);
    }

    function addToCart(name, variant, price) {
        cart.push({name, variant, price: Number(price)});
        document.getElementById('cart-count').innerText = cart.length;
        showToast("Added to cart!", 'info');
    }
    
    function submitReview(bizId) {
        const name = document.getElementById('rev-name').value.trim();
        const stars = document.getElementById('rev-star').value;
        const text = document.getElementById('rev-text').value.trim();
        if(!name || !text) return showToast("Required fields missing.", "error");
        
        db.collection('users').doc(bizId).collection('reviews').add({
            name, stars: Number(stars), text, status: 'pending', time: new Date().toISOString()
        }).then(() => {
            showToast("Review submitted!", 'success');
            document.getElementById('rev-text').value = '';
        });
    }

    function showCartModal() {
        if(cart.length === 0) return showToast("Cart is empty.", "error");
        const total = cart.reduce((a,b)=>a+b.price,0);
        
        showModal(`
            <h2 class="text-center">Order Summary</h2>
            <div style="background:#f8f9fa; padding:15px; border-radius:12px; max-height:200px; overflow-y:auto; margin-bottom:15px; border:1px solid #eee;">
                ${cart.map((i,idx) => `<div class="flex justify-between" style="padding:8px 0; border-bottom:1px solid #eee;"><span>${i.name} (${i.variant})</span><b>${i.price}</b> <button onclick="removeFromCart(${idx})" style="background:none; border:none; color:red;">&times;</button></div>`).join('')}
            </div>
            
            <h3 class="text-right text-red">Total: Rs. ${total} <span id="cart-del-fee" class="text-gray small hidden"></span></h3>
            
            <div class="flex center" style="gap:15px; margin:15px 0;">
                <label class="btn btn-outline" style="flex:1;">
                    <input type="radio" name="del-opt" value="pickup" checked onchange="toggleDeliveryUI('pickup')"> Pick Up
                </label>
                <label class="btn btn-outline" style="flex:1;">
                    <input type="radio" name="del-opt" value="delivery" onchange="toggleDeliveryUI('delivery')"> Deliver
                </label>
            </div>
            
            <div id="del-alert" class="hidden p-1 mb-1 text-center" style="border-radius:8px;"></div>

            <div id="del-fields" class="hidden">
                 <div class="input-group"><label>Address</label><textarea id="c-address" rows="2"></textarea></div>
                <div class="input-group">
                    <label>Pin Location *</label>
                    <button class="btn btn-secondary" onclick="getLocationForCheck()">üìç Get GPS</button>
                    <div id="cust-map" class="map-container hidden" style="height:200px;"></div>
                    <div id="loc-status" class="mt-1 small bold"></div>
                </div>
            </div>

            <div class="input-group"><label>Name *</label><input id="c-name"></div>
            <div class="input-group"><label>Phone *</label><input id="c-phone" type="tel"></div>
            <div class="input-group"><label>WhatsApp *</label><input id="c-wa" type="tel"></div>
            
            <button id="btn-order" class="btn btn-green" onclick="placeOrder('${bizIdForCart}', ${total})">Confirm & Order via WhatsApp</button>
            <button class="btn btn-secondary mt-1" onclick="closeModal()">Close</button>
        `);
    }

    function toggleDeliveryUI(type) {
        const delFields = document.getElementById('del-fields');
        const alertBox = document.getElementById('del-alert');
        const orderBtn = document.getElementById('btn-order');
        const feeSpan = document.getElementById('cart-del-fee');

        alertBox.className = 'hidden p-1 mb-1 text-center'; 
        alertBox.innerHTML = '';
        feeSpan.innerText = '';
        orderBtn.disabled = false;

        if (type === 'delivery') {
            if (!publicBizData.canDeliver) {
                alertBox.classList.remove('hidden');
                alertBox.style.background = '#fff0f0';
                alertBox.style.color = 'var(--primary)';
                alertBox.innerHTML = '<b>We do not deliver.</b>';
                orderBtn.disabled = true;
            } else {
                delFields.classList.remove('hidden');
                if(publicBizData.deliveryCost > 0) {
                     alertBox.classList.remove('hidden');
                     alertBox.style.background = '#e7f1ff';
                     alertBox.style.color = '#2f3542';
                     alertBox.innerHTML = `Delivery Cost: <b>Rs. ${publicBizData.deliveryCost}</b>`;
                     feeSpan.classList.remove('hidden');
                     feeSpan.innerHTML = `+ ${publicBizData.deliveryCost}`;
                }
            }
        } else {
            delFields.classList.add('hidden');
        }
    }

    function getLocationForCheck() {
        const status = document.getElementById('loc-status');
        const mapDiv = document.getElementById('cust-map');
        status.innerHTML = "‚è≥ Detecting...";
        
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    customerLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    mapDiv.classList.remove('hidden');
                    if(customerMap) customerMap.remove();
                    
                    customerMap = L.map('cust-map').setView([customerLocation.lat, customerLocation.lng], 13);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(customerMap);
                    
                    L.circle([publicBizData.serviceLocation.lat, publicBizData.serviceLocation.lng], {
                        color: 'red', fillColor: '#f03', fillOpacity: 0.1, radius: publicBizData.serviceRadius*1000
                    }).addTo(customerMap);

                    customerMarker = L.marker([customerLocation.lat, customerLocation.lng], {draggable: true}).addTo(customerMap);
                    
                    customerMarker.on('dragend', function(e) {
                        const ll = e.target.getLatLng();
                        customerLocation = { lat: ll.lat, lng: ll.lng };
                        checkDeliveryZone();
                    });

                    checkDeliveryZone();
                },
                () => { status.innerHTML = "‚ùå GPS Error."; status.style.color = "red"; }
            );
        } else { status.innerHTML = "‚ùå Not supported."; }
    }

    function checkDeliveryZone() {
        const bizLoc = publicBizData.serviceLocation;
        const dist = getDist(bizLoc.lat, bizLoc.lng, customerLocation.lat, customerLocation.lng);
        const status = document.getElementById('loc-status');
        const btn = document.getElementById('btn-order');
        
        if (dist <= publicBizData.serviceRadius) {
            status.innerHTML = `‚úî Valid Location (${dist.toFixed(1)}km).`;
            status.style.color = "var(--green)";
            btn.disabled = false;
        } else {
            status.innerHTML = `‚ùå Too far (${dist.toFixed(1)}km). Limit: ${publicBizData.serviceRadius}km.`;
            status.style.color = "red";
            btn.disabled = true;
        }
    }
    
    function getDist(lat1,lon1,lat2,lon2) {
      const R = 6371, dLat = (lat2-lat1)*(Math.PI/180), dLon = (lon2-lon1)*(Math.PI/180);
      const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1*(Math.PI/180))*Math.cos(lat2*(Math.PI/180)) * Math.sin(dLon/2)*Math.sin(dLon/2);
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function removeFromCart(index) {
        cart.splice(index, 1);
        document.getElementById('cart-count').innerText = cart.length;
        closeModal(); showCartModal();
    }

    async function placeOrder(bizId, total) {
        const name = document.getElementById('c-name').value.trim();
        const phone = document.getElementById('c-phone').value.trim();
        const wa = document.getElementById('c-wa').value.trim();
        const delOpt = document.querySelector('input[name="del-opt"]:checked').value;
        
        if(!name || !phone || !wa) return showToast("All fields required!", "error");
        if (cart.length === 0) return showToast("Cart is empty!", "error");

        let deliveryFee = 0;
        let deliveryAddress = "";
        let finalTotal = total;

        if (delOpt === 'delivery') {
            if (!publicBizData.canDeliver) return showToast("No delivery available.", "error");
            deliveryAddress = document.getElementById('c-address').value.trim();
            if (!deliveryAddress) return showToast("Address required.", "error");
            if (!customerLocation) return showToast("Confirm location on map.", "error");
            
            const bizLoc = publicBizData.serviceLocation;
            const dist = getDist(bizLoc.lat, bizLoc.lng, customerLocation.lat, customerLocation.lng);
            if(dist > publicBizData.serviceRadius) return showToast("Location too far.", "error");

            deliveryFee = publicBizData.deliveryCost || 0;
            finalTotal += deliveryFee;
        }

        document.getElementById('btn-order').disabled = true;
        document.getElementById('btn-order').innerText = "Processing...";

        try {
            const todayStr = new Date().toISOString().split('T')[0];
            const snapshot = await db.collection('users').doc(bizId).collection('orders')
                .where('dateString', '==', todayStr).get();

            let nextSeq = 1;
            if (!snapshot.empty) {
                let maxSeq = 0;
                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    if (data.dailySeq && data.dailySeq > maxSeq) maxSeq = data.dailySeq;
                });
                nextSeq = maxSeq + 1;
            }

            const orderNum = '#' + String(nextSeq).padStart(6, '0');

            await db.collection('users').doc(bizId).collection('orders').add({
                orderNum, dailySeq: nextSeq, dateString: todayStr,
                custName: name, custPhone: phone, custWa: wa, items: cart, 
                total: finalTotal, deliveryType: delOpt, deliveryAddress, deliveryFee,
                deliveryLocation: (delOpt === 'delivery' && customerLocation) ? { lat: Number(customerLocation.lat), lng: Number(customerLocation.lng) } : null,
                time: new Date().toISOString(), status: 'new', seen: false
            });

            let msg = `üîî *New Order!* \nCustomer: ${name}\nOrder #: ${orderNum}\nType: *${delOpt.toUpperCase()}*\n`;
            if(delOpt === 'delivery') msg += `Address: ${deliveryAddress}\n`;
            msg += `\n*Items:*\n${cart.map(i=>`- ${i.name} (${i.variant})`).join('\n')}\n`;
            msg += `\n*Total: Rs. ${finalTotal}*`;
            
            window.open(`https://wa.me/${bizOwnerWa}?text=${encodeURIComponent(msg)}`, '_blank');
            cart = [];
            closeModal();
            showToast("Order Placed!", "success");

        } catch(e) {
            console.error(e);
            showToast("Failed: " + e.message, 'error');
            document.getElementById('btn-order').disabled = false;
        }
    }

    // CUSTOMER CONFIRMATION
    async function loadCustomerConfirmPage(bizId, orderId) {
        const docRef = db.collection('users').doc(bizId).collection('orders').doc(orderId);
        const doc = await docRef.get();
        if(!doc.exists) return app.innerHTML = "<div class='text-center p-2'><h2>Order not found</h2></div>";
        const o = doc.data();

        let statusMessage = '';
        let buttonHtml = '';
        if (o.status === 'new') {
            statusMessage = `<h2 class="text-green mb-1">Confirm Order?</h2>`;
            buttonHtml = `
                <button class="btn btn-green" onclick="confirmAction('${bizId}', '${orderId}', 'confirmed')">‚úÖ YES, CONFIRM</button>
                <button class="btn btn-secondary mt-1" style="background:#ff6b81" onclick="confirmAction('${bizId}', '${orderId}', 'canceled')">‚ùå CANCEL</button>
            `;
        } else {
            statusMessage = `<h2 class="text-yellow mb-1">Status: ${o.status.toUpperCase()}</h2>`;
            buttonHtml = `<button class="btn btn-secondary mt-1" onclick="window.close()">Close</button>`;
        }

        app.innerHTML = `
            <div class="flex-col center p-2" style="min-height:100vh; background:white;">
                <h1 style="font-size:3rem; margin:0;">${o.orderNum}</h1>
                ${statusMessage}
                <div class="card w-100" style="max-width:400px; text-align:left;">
                    ${o.items.map(i => `<div class="flex justify-between p-1" style="border-bottom:1px solid #eee"><span>${i.name}</span><span>${i.price}</span></div>`).join('')}
                    <div class="flex justify-between bold p-1" style="font-size:1.2rem"><span>Total</span><span>Rs. ${o.total}</span></div>
                </div>
                <div class="w-100 mt-2" style="max-width:400px">${buttonHtml}</div>
            </div>
        `;
    }

    function confirmAction(bizId, orderId, status) {
        db.collection('users').doc(bizId).collection('orders').doc(orderId).update({status, seen: true})
        .then(() => {
            document.body.innerHTML = `<div style="height:100vh;display:flex;align-items:center;justify-content:center;"><h1 style="color:${status==='confirmed'?'green':'red'}">${status.toUpperCase()}!</h1></div>`;
        });
    }

    // UTILS
    function showModal(content) {
        const el = document.createElement('div');
        el.className = 'modal-overlay';
        el.innerHTML = `<div class="modal-box">${content}</div>`;
        document.body.appendChild(el);
    }
    
    function closeModal() {
        const el = document.querySelector('.modal-overlay');
        if(el) el.remove();
    }

    function showToast(msg, type='success') {
        const t = document.createElement('div');
        t.innerText = msg;
        t.style = `
            position: fixed; top: 20px; right: 20px; z-index: 3000;
            background: ${type==='error'?'#ff4757':(type==='info'?'#2f3542':'#2ed573')}; 
            color: white; padding: 12px 20px; border-radius: 50px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); font-weight:600; font-size:0.85rem;
            animation: slideIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        `;
        document.body.appendChild(t);
        setTimeout(() => {
            t.style.animation = 'fadeOut 0.3s forwards';
            setTimeout(() => t.remove(), 300);
        }, 3000);
    }

  // ============================================
    // FINAL LANDING PAGE LOGIC (Language + Scroll + Modal)
    // ============================================

    let currentLang = 'en';
    let modalShown = false;

    // 1. SCROLL LISTENER (Triggers the Modal)
    window.addEventListener('scroll', () => {
        // Only run if user is NOT logged in (Landing page only)
        if (currentUser) return; 

        const scrollPosition = window.scrollY;
        const fullHeight = document.body.scrollHeight;
        
        // Trigger when scrolled down 15% of the page
        if (!modalShown && scrollPosition > (fullHeight * 0.15)) { 
            openProfitModal();
            modalShown = true; // Ensures it only opens once
        }
    });

    // 2. MODAL FUNCTIONS
    function openProfitModal() {
        const m = document.getElementById('profit-modal');
        if(m) m.classList.add('show');
    }

    function closeProfitModal() {
        const m = document.getElementById('profit-modal');
        if(m) m.classList.remove('show');
    }

    // 3. LANGUAGE TOGGLE FUNCTION
    function toggleLanguage() {
        // Toggle State
        currentLang = (currentLang === 'en') ? 'si' : 'en';
        
        // Update Button Text
        const btnTxt = document.getElementById('lang-btn-txt');
        if(btnTxt) btnTxt.innerText = (currentLang === 'en') ? '‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω' : 'English';

        // Toggle Visibility of ALL English/Sinhala Elements
        const enElements = document.querySelectorAll('.lang-en');
        const siElements = document.querySelectorAll('.lang-si');

        if(currentLang === 'si') {
            enElements.forEach(el => el.classList.add('hidden'));
            siElements.forEach(el => el.classList.remove('hidden'));
        } else {
            siElements.forEach(el => el.classList.add('hidden'));
            enElements.forEach(el => el.classList.remove('hidden'));
        }
    }
</script>

</body>
</html>
