<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EatlyHub | Food Ordering System</title>
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/3075/3075977.png">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <style>
        :root {
            --primary: #ff4757;
            --primary-dark: #e84118;
            --bg: #f4f5f7;
            --surface: #ffffff;
            --text: #2f3542;
            --green: #2ecc71;
            --red: #e74c3c;
            --yellow: #f1c40f;
            --shadow: 0 4px 6px rgba(0,0,0,0.05);
            --radius: 12px;
        }

        /* --- BASE STYLES --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { margin: 0; padding: 0; font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); font-size: 14px; padding-bottom: 20px; }
        
        /* --- UTILITIES --- */
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .center { align-items: center; justify-content: center; }
        .justify-between { justify-content: space-between; }
        .w-100 { width: 100%; }
        .hidden { display: none !important; }
        .mt-1 { margin-top: 10px; }
        .mb-1 { margin-bottom: 10px; }
        .p-2 { padding: 15px; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-green { color: var(--green); }
        .text-red { color: var(--red); }
        .bold { font-weight: 700; }

        /* --- RESPONSIVE 300px SUPPORT --- */
        @media (max-width: 320px) {
            body { font-size: 12px; }
            h1 { font-size: 1.5rem; }
            .btn { padding: 8px !important; font-size: 0.8rem !important; }
        }

        /* --- COMPONENTS --- */
        .btn { border: none; padding: 12px; border-radius: 8px; font-weight: 600; width: 100%; cursor: pointer; transition: 0.2s; margin-bottom: 5px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: #dfe4ea; color: var(--text); }
        .btn-green { background: var(--green); color: white; }
        .btn-outline { border: 1px solid var(--primary); background: transparent; color: var(--primary); }

        .card { background: var(--surface); padding: 15px; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 15px; border-left: 4px solid transparent; overflow: hidden; }
        
        /* Input Fields */
        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9rem; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ced6e0; border-radius: 8px; font-size: 1rem; }
        .form-group input:disabled { background: #f1f2f6; color: #a4b0be; }

        /* Image Upload Box */
        .img-upload-box { border: 2px dashed #ccc; padding: 20px; text-align: center; border-radius: 8px; cursor: pointer; margin-bottom: 10px; position: relative; }
        .img-preview { max-width: 100%; height: 100px; object-fit: cover; display: none; margin: 10px auto; border-radius: 5px; }

        /* --- DASHBOARD NAVIGATION (Fixed Visibility) --- */
        nav { background: var(--surface); padding: 10px; position: sticky; top: 0; z-index: 100; box-shadow: var(--shadow); }
        .nav-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        
        .tab-scroll-container { 
            display: flex; 
            overflow-x: auto; 
            gap: 10px; 
            padding-bottom: 5px; 
            scrollbar-width: none; /* Firefox */
        }
        .tab-scroll-container::-webkit-scrollbar { display: none; } /* Chrome */
        
        .tab-btn { 
            white-space: nowrap; 
            padding: 8px 15px; 
            background: #f1f2f6; 
            border-radius: 20px; 
            font-size: 0.9rem; 
            color: #747d8c; 
            cursor: pointer; 
            flex-shrink: 0; /* Prevents shrinking */
        }
        .tab-btn.active { background: var(--primary); color: white; font-weight: bold; }

        /* --- ORDER STATUS COLORS --- */
        .status-new { border-left-color: var(--green); }
        .status-confirmed { border-left-color: var(--yellow); }
        .status-active { border-left-color: #3498db; }
        .status-ready { border-left-color: #9b59b6; }
        .status-completed { border-left-color: #2f3542; }
        .status-unpaid { border-left-color: var(--red); }

        /* --- THERMAL BILL STYLE --- */
        .bill-paper { background: #fffbe7; padding: 15px; border: 1px dashed #ccc; font-family: 'Courier New', monospace; position: relative; margin-top: 10px; }
        .watermark { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-45deg); font-size: 2rem; border: 3px solid rgba(231, 76, 60, 0.2); color: rgba(231, 76, 60, 0.2); font-weight: 900; padding: 5px; pointer-events: none; }

        /* --- MODAL --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: flex; justify-content: center; align-items: flex-end; }
        .modal-content { background: white; width: 100%; max-width: 500px; padding: 20px; border-radius: 15px 15px 0 0; max-height: 85vh; overflow-y: auto; animation: slideUp 0.3s; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* --- VERIFICATION BADGE --- */
        .verified-badge { display: inline-flex; align-items: center; gap: 4px; background: #dff9fb; color: #2ecc71; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; border: 1px solid #2ecc71; margin-top: 5px; }

    </style>
</head>
<body>

<div id="app">
    <!-- Loading Screen -->
    <div style="height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:center;">
        <img src="https://cdn-icons-png.flaticon.com/512/3075/3075977.png" width="80">
        <h2 style="color:var(--primary)">EatlyHub</h2>
        <p>Loading...</p>
    </div>
</div>

<!-- ================= TEMPLATES ================= -->

<!-- 1. LANDING PAGE -->
<template id="tpl-landing">
    <div style="background: linear-gradient(135deg, var(--primary), #e84118); color: white; padding: 50px 20px; text-align: center; border-radius: 0 0 30px 30px;">
        <img src="https://cdn-icons-png.flaticon.com/512/3075/3075977.png" width="80" style="background:white; border-radius:50%; padding:5px;">
        <h1>EatlyHub</h1>
        <p>All-in-One Food Platform for Hotels, Restaurants & Home Kitchens</p>
        <button class="btn" style="background:white; color:var(--primary); font-weight:bold; margin-top:20px;" onclick="handleLogin()">Login with Gmail</button>
    </div>
    
    <div class="p-2">
        <h3 class="text-center">Start Your Business</h3>
        <div class="card">
            <h4>üè® Hotels & Restaurants</h4>
            <p>Digitalize your room service and table ordering.</p>
        </div>
        <div class="card">
            <h4>üè† Home Based Kitchens</h4>
            <p>Start selling homemade food today! Create menu, share link, get WhatsApp orders.</p>
        </div>
    </div>
</template>

<!-- 2. DASHBOARD SHELL -->
<template id="tpl-dashboard">
    <nav>
        <div class="nav-top">
            <div class="bold" style="font-size:1.2rem; color:var(--primary)">EatlyHub</div>
            <button onclick="authLogout()" style="background:none; border:none; color:#747d8c;">Logout</button>
        </div>
        <!-- Scrollable Tabs -->
        <div class="tab-scroll-container" id="dash-tabs">
            <!-- Tabs injected here -->
        </div>
    </nav>
    <div id="dash-content" class="p-2" style="padding-bottom: 80px;"></div>
</template>

<!-- 3. PUBLIC WEBPAGE -->
<template id="tpl-public">
    <div id="pub-status-bar" class="text-center p-2 bold" style="color:white; font-size:0.9rem;"></div>
    
    <div class="text-center p-2" style="background:white; border-bottom:1px solid #eee;">
        <img id="pub-logo" src="" style="width:100px; height:100px; border-radius:50%; object-fit:cover; border:3px solid var(--primary);">
        <h2 id="pub-name" class="mt-1 mb-1"></h2>
        <div id="pub-verified" class="hidden center" style="justify-content:center"><span class="verified-badge">‚úî Verified Business</span></div>
        <p id="pub-address" style="color:#7f8c8d; font-size:0.9rem;"></p>
        <div class="flex mt-1" style="gap:10px;">
            <a id="pub-call" class="btn btn-green">Call</a>
            <a id="pub-wa" class="btn btn-green">WhatsApp</a>
        </div>
    </div>

    <div style="background:var(--primary); color:white; padding:30px 20px; text-align:center;">
        <h2 id="pub-hero"></h2>
        <button class="btn" style="background:white; color:var(--primary); width:auto; padding:10px 30px;" onclick="document.getElementById('pub-menu').scrollIntoView({behavior:'smooth'})">ORDER NOW</button>
    </div>

    <div id="pub-menu" class="p-2"></div>

    <footer class="text-center p-2 mt-1" style="background:#2f3542; color:white;">
        <h4 id="foot-name"></h4>
        <p id="foot-details" style="font-size:0.8rem; opacity:0.7;"></p>
        <div id="foot-ver" class="hidden verified-badge" style="background:transparent; border:1px solid white; color:white; width:fit-content; margin:10px auto; cursor:pointer;">‚úî Verified (View Proof)</div>
        <small>Powered by EatlyHub</small>
    </footer>
</template>

<!-- ================= LOGIC ================= -->
<script>
    // --- 1. FIREBASE CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyA4mlpgLA8l1N8VHqwpVLbPXvDvPxGPcSI",
        authDomain: "eatlyhub.firebaseapp.com",
        projectId: "eatlyhub",
        storageBucket: "eatlyhub.firebasestorage.app",
        messagingSenderId: "1094045089044",
        appId: "1:1094045089044:web:397e0fd73412a07c3ad601"
    };

    try {
        firebase.initializeApp(firebaseConfig);
    } catch(e) { console.error("Firebase Init Error", e); }
    const auth = firebase.auth();
    const db = firebase.firestore();

    // --- 2. STATE ---
    const app = document.getElementById('app');
    let currentUser = null;
    let bizProfile = {};
    let bizOrders = [];
    let currentTab = 'Dashboard';

    const TABS = [
        'Dashboard', 'Profile', 'Open/Close', 'Add Foods', 'My Webpage',
        'New Orders', 'Confirmed Orders', 'Active Orders', 'Ready Orders', 
        'Completed Orders', 'Unpaid Bills', 'Reports', 'Admin Messages'
    ];

    // --- 3. INIT ---
    window.addEventListener('load', () => {
        // Router Logic
        const params = new URLSearchParams(window.location.search);
        if (params.get('biz') && params.get('orderId')) {
            loadCustomerConfirm(params.get('biz'), params.get('orderId'));
        } else if (params.get('biz')) {
            loadPublicPage(params.get('biz'));
        } else {
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    loadDashboard();
                } else {
                    render('tpl-landing');
                }
            });
        }
    });

    // --- 4. RENDERER ---
    function render(tplId) {
        app.innerHTML = '';
        const tpl = document.getElementById(tplId);
        if(tpl) app.appendChild(tpl.content.cloneNode(true));
    }

    // --- 5. AUTH ---
    function handleLogin() {
        auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(alert);
    }
    function authLogout() { auth.signOut().then(() => location.reload()); }

    // --- 6. DASHBOARD LOGIC ---
    function loadDashboard() {
        render('tpl-dashboard');
        
        // Render Tabs
        const tabContainer = document.getElementById('dash-tabs');
        tabContainer.innerHTML = TABS.map(t => `<div class="tab-btn" onclick="switchTab('${t}')">${t}</div>`).join('');

        // Realtime Profile Listener
        db.collection('users').doc(currentUser.uid).onSnapshot(doc => {
            bizProfile = doc.exists ? doc.data() : { locked: false, verified: false, foods: [], schedule: {} };
            refreshTab();
        });

        // Realtime Orders Listener
        db.collection('users').doc(currentUser.uid).collection('orders').orderBy('time', 'desc').limit(50)
            .onSnapshot(snap => {
                bizOrders = snap.docs.map(d => ({id: d.id, ...d.data()}));
                refreshTab();
            });

        switchTab('Dashboard');
    }

    function switchTab(name) {
        // Guard: Profile must be complete & locked to access other tabs
        if (name !== 'Dashboard' && name !== 'Profile' && !bizProfile.locked) {
            alert("Please complete and LOCK your profile first!");
            name = 'Profile';
        }
        currentTab = name;
        document.querySelectorAll('.tab-btn').forEach(b => {
            b.classList.toggle('active', b.innerText === name);
        });
        refreshTab();
    }

    function refreshTab() {
        const content = document.getElementById('dash-content');
        if(!content) return;
        content.innerHTML = '';

        if(currentTab === 'Dashboard') renderDashHome(content);
        else if(currentTab === 'Profile') renderProfile(content);
        else if(currentTab === 'Open/Close') renderSchedule(content);
        else if(currentTab === 'Add Foods') renderAddFoods(content);
        else if(currentTab === 'My Webpage') renderWebpageInfo(content);
        else if(currentTab === 'Reports') renderReports(content);
        else if(currentTab === 'Admin Messages') content.innerHTML = '<div class="card text-center">No New Messages</div>';
        else renderOrders(content, currentTab);
    }

    // --- 7. IMAGE COMPRESSOR (CLIENT SIDE) ---
    function compressImage(file, callback) {
        if(!file) return;
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (e) => {
            const img = new Image();
            img.src = e.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const MAX_WIDTH = 400; // Resize to 400px width
                const scale = MAX_WIDTH / img.width;
                canvas.width = MAX_WIDTH;
                canvas.height = img.height * scale;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                callback(canvas.toDataURL('image/jpeg', 0.7)); // 0.7 quality
            }
        }
    }

    // --- 8. TAB CONTENTS ---

    // A) DASHBOARD
    function renderDashHome(div) {
        div.innerHTML = `
            <div class="card text-center">
                <img src="${bizProfile.logo || 'https://via.placeholder.com/100'}" style="width:80px;height:80px;border-radius:50%;object-fit:cover;">
                <h3>${bizProfile.businessName || 'Welcome'}</h3>
                ${bizProfile.verified ? '<div class="verified-badge">‚úî Verified</div>' : '<div class="text-red bold">‚ùå Not Verified</div>'}
            </div>
            <div class="card">
                <h4>Search</h4>
                <div class="form-group"><input placeholder="Order ID" onkeyup="searchOrder(this.value)"></div>
                <div id="s-res-ord"></div>
                <div class="form-group"><input placeholder="Customer WhatsApp (e.g. 9477...)" onkeyup="searchUnpaid(this.value)"></div>
                <div id="s-res-unp"></div>
            </div>
        `;
    }

    // B) PROFILE
    function renderProfile(div) {
        const p = bizProfile;
        const lock = p.locked;
        div.innerHTML = `
            <div class="card">
                <h3>Business Profile</h3>
                <div class="img-upload-box" onclick="document.getElementById('upl-logo').click()">
                    ${p.logo ? `<img src="${p.logo}" class="img-preview" style="display:block">` : '<span>Click to Upload Logo</span>'}
                </div>
                <input type="file" id="upl-logo" class="hidden" ${lock?'disabled':''} onchange="handleImg(this, 'p-logo')">
                
                <div class="form-group"><label>Business Name</label><input id="p-name" value="${p.businessName||''}" ${lock?'disabled':''}></div>
                <div class="form-group"><label>Owner Name</label><input id="p-owner" value="${p.ownerName||''}" ${lock?'disabled':''}></div>
                <div class="form-group"><label>Address</label><input id="p-addr" value="${p.address||''}" ${lock?'disabled':''}></div>
                <div class="form-group"><label>Reg/NIC</label><input id="p-nic" value="${p.nic||''}" ${lock?'disabled':''}></div>
                <div class="form-group"><label>Hotline</label><input id="p-hot" value="${p.hotline||''}" ${lock?'disabled':''}></div>
                <div class="form-group"><label>WhatsApp</label><input id="p-wa" value="${p.whatsapp||''}" ${lock?'disabled':''}></div>
                
                ${lock ? `<button class="btn btn-secondary" onclick="toggleLock(false)">Unlock & Edit</button>` : `<button class="btn btn-primary" onclick="saveProfile()">Save & Lock</button>`}
            </div>
            
            <div class="card">
                <h3>Get Verified (Rs 2500)</h3>
                ${p.verified ? '<p class="text-green bold">You are Verified!</p>' : `
                    <p>Bank: Commercial Bank | Acc: 8750053306</p>
                    <div class="form-group"><label>Grama Niladhari Letter</label><input type="file" id="v-letter"></div>
                    <div class="form-group"><label>Payment Slip</label><input type="file" id="v-slip"></div>
                    <button class="btn btn-green" onclick="alert('Submitted to Admin')">Submit Verification</button>
                `}
            </div>
        `;
    }

    function handleImg(input, key) {
        compressImage(input.files[0], (base64) => {
            if(key === 'p-logo') bizProfile.tempLogo = base64; // Temp store
            document.querySelector('.img-preview').src = base64;
            document.querySelector('.img-preview').style.display = 'block';
        });
    }

    function saveProfile() {
        const name = document.getElementById('p-name').value;
        const wa = document.getElementById('p-wa').value;
        const logo = bizProfile.tempLogo || bizProfile.logo;

        if(!name || !wa || !logo) return alert("All fields including Logo are REQUIRED!");

        db.collection('users').doc(currentUser.uid).set({
            logo: logo,
            businessName: name,
            ownerName: document.getElementById('p-owner').value,
            address: document.getElementById('p-addr').value,
            nic: document.getElementById('p-nic').value,
            hotline: document.getElementById('p-hot').value,
            whatsapp: wa,
            locked: true,
            verified: bizProfile.verified || false
        }, {merge:true}).then(() => alert("Profile Saved!"));
    }

    function toggleLock(state) {
        db.collection('users').doc(currentUser.uid).update({locked: state});
    }

    // C) SCHEDULE
    function renderSchedule(div) {
        const today = new Date().toLocaleDateString('en-US', {weekday:'long'});
        const s = bizProfile.schedule?.[today] || {};
        div.innerHTML = `
            <div class="card">
                <h3>${today} Schedule</h3>
                <div class="form-group">
                    <label>Open Today?</label>
                    <select id="oc-open">
                        <option value="yes" ${s.open?'selected':''}>Yes</option>
                        <option value="no" ${!s.open?'selected':''}>No</option>
                    </select>
                </div>
                <div class="flex" style="gap:10px">
                    <div class="form-group w-100"><label>Open Time</label><input type="time" id="oc-start" value="${s.start||'08:00'}"></div>
                    <div class="form-group w-100"><label>Close Time</label><input type="time" id="oc-end" value="${s.end||'20:00'}"></div>
                </div>
                <button class="btn btn-primary" onclick="saveSched('${today}')">Save Schedule</button>
            </div>
        `;
    }

    function saveSched(day) {
        const sched = bizProfile.schedule || {};
        sched[day] = {
            open: document.getElementById('oc-open').value === 'yes',
            start: document.getElementById('oc-start').value,
            end: document.getElementById('oc-end').value
        };
        db.collection('users').doc(currentUser.uid).update({schedule: sched});
    }

    // D) ADD FOODS
    function renderAddFoods(div) {
        div.innerHTML = `
            <div class="card">
                <h3>Add Item</h3>
                <div class="img-upload-box" onclick="document.getElementById('f-upl').click()">
                    <img id="f-prev" class="img-preview">
                    <span>Click to Upload Image</span>
                </div>
                <input type="file" id="f-upl" class="hidden" onchange="handleFoodImg(this)">
                
                <div class="form-group"><input id="f-cat" placeholder="Category (e.g. Rice)"></div>
                <div class="form-group"><input id="f-name" placeholder="Name *"></div>
                <div class="flex" style="gap:10px">
                    <div class="form-group w-100"><input id="f-half" type="number" placeholder="Half Price"></div>
                    <div class="form-group w-100"><input id="f-full" type="number" placeholder="Full Price"></div>
                </div>
                <button class="btn btn-green" onclick="addFood()">Add to Menu</button>
            </div>
            <div id="menu-list">
                ${(bizProfile.foods||[]).map((f,i) => `
                    <div class="card flex center justify-between">
                        <div class="flex center">
                            <img src="${f.img}" style="width:50px;height:50px;border-radius:5px;margin-right:10px;">
                            <div><b>${f.name}</b><br><small>${f.cat}</small></div>
                        </div>
                        <button class="btn btn-secondary" style="width:auto" onclick="delFood(${i})">X</button>
                    </div>
                `).join('')}
            </div>
        `;
    }

    let tempFoodImg = null;
    function handleFoodImg(input) {
        compressImage(input.files[0], (b64) => {
            tempFoodImg = b64;
            document.getElementById('f-prev').src = b64;
            document.getElementById('f-prev').style.display = 'block';
        });
    }

    function addFood() {
        const name = document.getElementById('f-name').value;
        const half = document.getElementById('f-half').value;
        const full = document.getElementById('f-full').value;
        if(!name || !tempFoodImg || (!half && !full)) return alert("Name, Image & One Price Required!");

        const foods = [...(bizProfile.foods||[]), {
            name, img: tempFoodImg, half, full, cat: document.getElementById('f-cat').value
        }];
        
        db.collection('users').doc(currentUser.uid).update({foods}).then(() => {
            tempFoodImg = null;
            renderAddFoods(document.getElementById('dash-content'));
        });
    }

    function delFood(i) {
        const foods = bizProfile.foods.filter((_, idx) => idx !== i);
        db.collection('users').doc(currentUser.uid).update({foods});
    }

    // E) WEBPAGE INFO
    function renderWebpageInfo(div) {
        const link = `${location.origin}${location.pathname}?biz=${currentUser.uid}`;
        div.innerHTML = `
            <div class="card">
                <h3>Your Link</h3>
                <input value="${link}" readonly style="background:#eee; padding:10px; width:100%; border:none; margin-bottom:10px;">
                <a href="${link}" target="_blank" class="btn btn-primary" style="display:block; text-decoration:none; text-align:center;">Open Webpage</a>
                <div class="form-group mt-1"><label>Hero Text</label><input id="hero-txt" value="${bizProfile.heroText||''}" onchange="updateHero(this.value)"></div>
            </div>
        `;
    }
    function updateHero(v) { db.collection('users').doc(currentUser.uid).update({heroText:v}); }

    // F) ORDERS LOGIC
    function renderOrders(div, tab) {
        const map = {'New Orders':'new', 'Confirmed Orders':'confirmed', 'Active Orders':'active', 'Ready Orders':'ready', 'Completed Orders':'completed', 'Unpaid Bills':'unpaid'};
        const status = map[tab];
        
        const list = bizOrders.filter(o => o.status === status);
        if(!list.length) return div.innerHTML = `<div class="p-2 text-center">No orders found.</div>`;

        div.innerHTML = list.map(o => {
            let btns = '';
            if(status === 'new') btns = `
                <button class="btn btn-yellow" onclick="reqConfirm('${o.id}', '${o.custWa}')">Request Confirmation</button>
                <button class="btn btn-outline" style="color:red;border-color:red" onclick="updStatus('${o.id}', 'canceled')">Decline</button>`;
            if(status === 'confirmed') btns = `<button class="btn btn-primary" onclick="genBill('${o.id}')">üñ® Print Bill & Cook</button>`;
            if(status === 'active') btns = `
                <div class="bill-paper">
                    <div class="watermark">NOT PAID</div>
                    <div class="text-center bold">${bizProfile.businessName}</div>
                    <div class="text-center"><small>Order #${o.orderNum}</small></div>
                    <hr>
                    ${o.items.map(i => `<div class="flex justify-between"><span>${i.name}</span><span>${i.price}</span></div>`).join('')}
                    <hr>
                    <div class="flex justify-between bold"><span>Total</span><span>${o.total}</span></div>
                </div>
                <button class="btn btn-green mt-1" onclick="markReady('${o.id}', '${o.custWa}')">Mark Ready & Notify</button>`;
            if(status === 'ready') btns = `
                <button class="btn btn-secondary" onclick="updStatus('${o.id}', 'completed')">üí∞ Paid & Complete</button>
                <button class="btn btn-outline" style="color:red;border-color:red" onclick="updStatus('${o.id}', 'unpaid')">‚ö† Not Paid</button>`;

            return `
                <div class="card status-${status}">
                    <div class="flex justify-between"><h4>#${o.orderNum}</h4><small>${new Date(o.time).toLocaleTimeString()}</small></div>
                    <p class="bold">${o.custName} (<a href="tel:${o.custWa}">${o.custWa}</a>)</p>
                    <ul>${o.items.map(i=>`<li>${i.name} (${i.variant})</li>`).join('')}</ul>
                    <div class="text-right bold">Total: ${o.total}</div>
                    <div class="mt-1">${btns}</div>
                </div>
            `;
        }).join('');
    }

    function updStatus(id, st) { db.collection('users').doc(currentUser.uid).collection('orders').doc(id).update({status:st}); }
    
    function reqConfirm(id, wa) {
        const url = `${location.origin}${location.pathname}?biz=${currentUser.uid}&orderId=${id}`;
        window.open(`https://wa.me/${wa}?text=${encodeURIComponent("Please confirm your order: " + url)}`);
    }
    
    function genBill(id) {
        const o = bizOrders.find(x => x.id === id);
        updStatus(id, 'active');
        let txt = `üßæ *BILL - ${bizProfile.businessName}*\nOrder #${o.orderNum}\n\n`;
        o.items.forEach(i => txt += `${i.name}: ${i.price}\n`);
        txt += `\n*Total: ${o.total}*`;
        window.open(`https://wa.me/${o.custWa}?text=${encodeURIComponent(txt)}`);
    }

    function markReady(id, wa) {
        updStatus(id, 'ready');
        window.open(`https://wa.me/${wa}?text=${encodeURIComponent("Your order is READY! Please come and pay.")}`);
    }

    // G) REPORTS
    function renderReports(div) {
        const done = bizOrders.filter(o => o.status === 'completed');
        const rev = done.reduce((a,b)=>a+parseInt(b.total), 0);
        const unpaid = bizOrders.filter(o => o.status === 'unpaid').length;
        div.innerHTML = `
            <div class="card text-center">
                <h3>Total Revenue</h3>
                <h1 class="text-green">Rs. ${rev}</h1>
                <div class="flex mt-1" style="gap:10px">
                    <div class="card w-100" style="background:#f1f2f6"><b>${done.length}</b><br>Completed</div>
                    <div class="card w-100" style="background:#fff0f0; color:red"><b>${unpaid}</b><br>Unpaid</div>
                </div>
            </div>
        `;
    }

    // --- SEARCH ---
    function searchOrder(v) {
        const o = bizOrders.find(x => x.orderNum === v);
        document.getElementById('s-res-ord').innerHTML = o ? `<div class="p-2 card status-${o.status}">Found: <b>${o.status.toUpperCase()}</b></div>` : '';
    }
    function searchUnpaid(v) {
        if(v.length < 5) return;
        const list = bizOrders.filter(x => x.custWa.includes(v) && x.status === 'unpaid');
        document.getElementById('s-res-unp').innerHTML = list.length ? `<div class="p-2 card text-red">‚ö† Found ${list.length} Unpaid Bills!</div>` : '<div class="text-green">Clean Record</div>';
    }


    // ================= PUBLIC PAGE =================
    let cart = [];

    async function loadPublicPage(bizId) {
        render('tpl-public');
        const doc = await db.collection('users').doc(bizId).get();
        if(!doc.exists) return document.body.innerHTML = "<h1>Business Not Found</h1>";
        const d = doc.data();

        // Bind Info
        document.getElementById('pub-name').innerText = d.businessName;
        document.getElementById('pub-logo').src = d.logo;
        document.getElementById('pub-address').innerText = d.address;
        document.getElementById('pub-hero').innerText = d.heroText || "Welcome!";
        document.getElementById('pub-call').href = `tel:${d.hotline}`;
        document.getElementById('pub-wa').href = `https://wa.me/${d.whatsapp}`;
        document.getElementById('foot-name').innerText = d.businessName;
        document.getElementById('foot-details').innerText = d.address + ' | ' + d.hotline;
        
        if(d.verified) {
            document.getElementById('pub-verified').classList.remove('hidden');
            document.getElementById('foot-ver').classList.remove('hidden');
            document.getElementById('foot-ver').onclick = () => alert("Verified via Grama Niladhari Letter");
        }

        // Open/Close
        const day = new Date().toLocaleDateString('en-US', {weekday:'long'});
        const s = d.schedule?.[day];
        const bar = document.getElementById('pub-status-bar');
        
        // Time logic
        let isOpen = false;
        if(s && s.open) {
            const now = new Date();
            const cur = now.getHours()*60 + now.getMinutes();
            const [sh, sm] = s.start.split(':').map(Number);
            const [eh, em] = s.end.split(':').map(Number);
            if(cur >= (sh*60+sm) && cur <= (eh*60+em)) isOpen = true;
        }
        
        bar.innerText = isOpen ? `OPEN NOW (${s.start} - ${s.end})` : "CLOSED NOW";
        bar.style.background = isOpen ? "var(--green)" : "var(--primary)";

        // Menu
        const menu = document.getElementById('pub-menu');
        const cats = [...new Set((d.foods||[]).map(f=>f.cat))];
        cats.forEach(c => {
            menu.innerHTML += `<h3 class="mt-1" style="border-bottom:1px solid #ccc">${c||'Items'}</h3>`;
            d.foods.filter(f=>f.cat===c).forEach(f => {
                menu.innerHTML += `
                    <div class="card flex justify-between center">
                        <img src="${f.img}" style="width:60px;height:60px;border-radius:8px;margin-right:10px;">
                        <div style="flex:1">
                            <div class="bold">${f.name}</div>
                            <div class="flex mt-1" style="gap:5px">
                                ${f.half ? `<button class="btn btn-outline" style="padding:5px;width:auto;font-size:0.8rem" onclick="addCart('${f.name}', 'Half', ${f.half})">Half: ${f.half}</button>`:''}
                                ${f.full ? `<button class="btn btn-outline" style="padding:5px;width:auto;font-size:0.8rem" onclick="addCart('${f.name}', 'Full', ${f.full})">Full: ${f.full}</button>`:''}
                            </div>
                        </div>
                    </div>
                `;
            });
        });

        // Cart Icon
        const fab = document.createElement('div');
        fab.innerHTML = "üõí";
        fab.style = "position:fixed;bottom:20px;right:20px;background:var(--primary);color:white;width:60px;height:60px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:24px;box-shadow:0 4px 10px rgba(0,0,0,0.3);cursor:pointer;z-index:900";
        fab.onclick = () => showCart(bizId, d.whatsapp);
        document.body.appendChild(fab);
    }

    function addCart(n, v, p) {
        cart.push({name:n, variant:v, price:p});
        alert("Added to Cart!");
    }

    function showCart(bizId, wa) {
        if(!cart.length) return alert("Cart is Empty");
        const tot = cart.reduce((a,b)=>a+parseInt(b.price),0);
        
        const html = `
            <h3>Your Cart</h3>
            <div style="background:#f1f2f6;padding:10px;border-radius:8px;max-height:200px;overflow-y:auto">
                ${cart.map(i=>`<div class="flex justify-between"><span>${i.name} (${i.variant})</span><span>${i.price}</span></div>`).join('')}
            </div>
            <h3 class="text-right">Total: ${tot}</h3>
            <div class="form-group"><label>Name</label><input id="c-name"></div>
            <div class="form-group"><label>WhatsApp</label><input id="c-wa" placeholder="947..."></div>
            <button class="btn btn-green" onclick="placeOrder('${bizId}', '${wa}', ${tot})">Confirm & Order via WhatsApp</button>
            <button class="btn btn-secondary" onclick="document.querySelector('.modal-overlay').remove()">Close</button>
        `;
        
        const m = document.createElement('div');
        m.className = 'modal-overlay';
        m.innerHTML = `<div class="modal-content">${html}</div>`;
        document.body.appendChild(m);
    }

    function placeOrder(bizId, ownerWa, total) {
        const name = document.getElementById('c-name').value;
        const custWa = document.getElementById('c-wa').value;
        if(!name || !custWa) return alert("Details Required");

        const orderNum = Math.floor(10000 + Math.random() * 90000).toString();
        
        db.collection('users').doc(bizId).collection('orders').add({
            orderNum, custName: name, custWa, items: cart, total, 
            time: new Date().toISOString(), status: 'new'
        }).then(() => {
            const msg = `New Order #${orderNum}\nName: ${name}\nItems: ${cart.map(i=>i.name).join(', ')}\nTotal: ${total}`;
            window.open(`https://wa.me/${ownerWa}?text=${encodeURIComponent(msg)}`);
            cart = [];
            document.querySelector('.modal-overlay').remove();
        });
    }

    // ================= CUSTOMER CONFIRM =================
    async function loadCustomerConfirm(bizId, orderId) {
        const doc = await db.collection('users').doc(bizId).collection('orders').doc(orderId).get();
        if(!doc.exists) return document.body.innerHTML = "<h1>Not Found</h1>";
        const o = doc.data();

        app.innerHTML = `
            <div class="flex-col center p-2" style="height:100vh; background:white">
                <h2 class="text-green">Confirm Order</h2>
                <h1>#${o.orderNum}</h1>
                <div class="card w-100" style="max-width:400px">
                    ${o.items.map(i => `<div class="flex justify-between"><span>${i.name}</span><span>${i.price}</span></div>`).join('')}
                    <hr>
                    <div class="flex justify-between bold"><span>Total</span><span>${o.total}</span></div>
                </div>
                <div class="w-100" style="max-width:400px">
                    <button class="btn btn-green" onclick="doConfirm('${bizId}', '${orderId}', 'confirmed')">‚úÖ CONFIRM</button>
                    <button class="btn btn-secondary" onclick="doConfirm('${bizId}', '${orderId}', 'canceled')">‚ùå CANCEL</button>
                </div>
            </div>
        `;
    }

    function doConfirm(bid, oid, st) {
        db.collection('users').doc(bid).collection('orders').doc(oid).update({status:st})
        .then(() => document.body.innerHTML = `<div class="text-center p-2"><h1>${st=='confirmed'?'Confirmed!':'Canceled'}</h1></div>`);
    }

</script>
</body>
</html>
