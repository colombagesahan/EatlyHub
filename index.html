<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EatlyHub | Professional Food Delivery Infrastructure</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#ff4757">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/3075/3075977.png">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --primary: #ff4757; 
            --primary-dark: #e84118;
            --secondary: #2f3542;
            --bg: #f7f8fa;
            --surface: #ffffff;
            --green: #2ed573;
            --red: #ff6b81;
            --yellow: #ffa502;
            --gray: #ced6e0;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            --font: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
            --radius: 18px;
        }

        /* --- RESET & BASE --- */
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { 
            margin: 0; padding: 0; font-family: var(--font); background: var(--bg); 
            color: var(--secondary); font-size: 14px; line-height: 1.6; 
            overflow-x: hidden; padding-bottom: 20px; 
        }
        
        /* --- UTILITY CLASSES --- */
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .center { align-items: center; justify-content: center; }
        .justify-between { justify-content: space-between; }
        .w-100 { width: 100%; }
        .hidden { display: none !important; }
        .mt-1 { margin-top: 0.5rem; }
        .mt-2 { margin-top: 1rem; }
        .mb-1 { margin-bottom: 0.5rem; }
        .p-1 { padding: 0.5rem; }
        .p-2 { padding: 1rem; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-red { color: var(--primary); }
        .text-green { color: var(--green); }
        .text-white { color: white !important; }
        .bold { font-weight: 700; }
        .relative { position: relative; }
        
        /* --- TYPOGRAPHY --- */
        h1, h2, h3, h4 { margin: 0 0 10px 0; color: var(--secondary); font-weight: 800; letter-spacing: -0.02em; }
        small { color: #747d8c; font-size: 0.8rem; }

        /* --- SCREEN OPTIMIZATION --- */
        @media (max-width: 340px) {
            body { font-size: 13px; }
            h1 { font-size: 1.5rem; }
            .btn { padding: 10px 12px !important; font-size: 0.85rem !important; }
            .nav-brand { font-size: 1.1rem !important; }
        }

        /* --- COMPONENTS --- */
        .btn { 
            padding: 16px 24px; border: none; border-radius: 14px; cursor: pointer; 
            font-weight: 700; font-size: 1rem; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); 
            width: 100%; text-align: center; display: block; text-decoration: none; 
            margin-bottom: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            position: relative; overflow: hidden;
        }
        .btn:active { transform: scale(0.96); opacity: 0.9; }
        .btn-primary { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; }
        .btn-secondary { background: var(--secondary); color: white; }
        .btn-green { background: var(--green); color: white; }
        .btn-yellow { background: var(--yellow); color: white; }
        .btn-outline { border: 2px solid var(--primary); color: var(--primary); background: transparent; box-shadow: none; }
        
        .card { 
            background: var(--surface); padding: 24px; border-radius: var(--radius); 
            box-shadow: var(--shadow); margin-bottom: 20px; border: 1px solid rgba(0,0,0,0.02);
            animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        
        .input-group { margin-bottom: 18px; position: relative; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.85rem; color: #4b5563; }
        .input-group input, .input-group select, .input-group textarea { 
            width: 100%; padding: 14px; border: 2px solid #e5e7eb; border-radius: 12px; 
            font-size: 1rem; background: #ffffff; transition: all 0.2s; -webkit-appearance: none;
        }
        .input-group input:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(255, 71, 87, 0.1); }
        
        nav { 
            background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); 
            padding: 12px 20px; position: sticky; top: 0; z-index: 1000; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.03); display: flex; align-items: center; justify-content: space-between; 
        }
        .nav-brand { display: flex; align-items: center; gap: 8px; font-size: 1.3rem; font-weight: 900; color: var(--primary); }

        .tabs-wrapper { 
            background: var(--surface); border-bottom: 1px solid #f3f4f6; position: sticky; top: 58px; z-index: 999; 
        }
        .tabs-container { 
            display: flex; flex-wrap: nowrap; overflow-x: auto; padding: 12px 15px; 
            -webkit-overflow-scrolling: touch; scrollbar-width: none; gap: 8px;
        }
        .tabs-container::-webkit-scrollbar { display: none; }
        .tab-btn { 
            padding: 8px 18px; white-space: nowrap; cursor: pointer; color: #6b7280; 
            font-weight: 600; border-radius: 30px; background: #f3f4f6; transition: all 0.2s; 
            font-size: 0.85rem; flex-shrink: 0; border: 1px solid transparent;
        }
        .tab-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(255, 71, 87, 0.25); }

        .hero { 
            background: linear-gradient(145deg, var(--primary), #d63031); 
            color: white; padding: 70px 25px 50px; text-align: center; 
            border-radius: 0 0 40px 40px; box-shadow: var(--shadow); 
            margin-bottom: 25px;
        }

        .status-badge { padding: 4px 14px; border-radius: 30px; font-size: 0.7rem; font-weight: 800; text-transform: uppercase; display: inline-block; }
        .st-new { background: #dcfce7; color: #166534; }
        .st-unverified { background: #fee2e2; color: #991b1b; }
        
        .bill-wrapper { 
            background: #fff; padding: 25px; border: 1px solid #e5e7eb; 
            border-radius: 12px; margin-top: 15px; font-family: 'Courier New', monospace; 
            position: relative; overflow: hidden;
        }
        .bill-header { text-align: center; border-bottom: 2px dashed #000; padding-bottom: 15px; margin-bottom: 15px; }
        .bill-item { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .bill-total { border-top: 2px dashed #000; padding-top: 15px; margin-top: 15px; display: flex; justify-content: space-between; font-weight: 900; font-size: 1.3rem; }
        
        .watermark { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-30deg); 
            font-size: 3rem; font-weight: 900; color: rgba(0,0,0,0.04); pointer-events: none; z-index: 0; text-transform: uppercase;
        }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; justify-content: center; align-items: flex-end; backdrop-filter: blur(8px); }
        .modal-box { 
            background: white; width: 100%; max-width: 500px; padding: 30px; 
            border-radius: 30px 30px 0 0; max-height: 90vh; overflow-y: auto; 
            box-shadow: 0 -10px 40px rgba(0,0,0,0.1);
        }

        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 45px; height: 45px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .floating-cart {
            position: fixed; bottom: 30px; right: 25px; background: var(--primary); 
            color: white; width: 70px; height: 70px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 30px; box-shadow: 0 15px 35px rgba(255,71,87,0.4); 
            cursor: pointer; z-index: 9000; transition: all 0.3s;
        }
        .cart-badge { 
            position: absolute; top: 0; right: 0; background: var(--secondary); 
            color: white; width: 26px; height: 26px; border-radius: 50%; font-size: 12px; 
            display: flex; align-items: center; justify-content: center; border: 3px solid var(--primary); 
        }

    </style>
</head>
<body>

<div id="app">
    <div style="height:100vh; display:flex; align-items:center; justify-content:center; flex-direction:column;">
        <div class="loader"></div>
        <p class="mt-2 bold" style="color:var(--primary); letter-spacing: 2px;">EATLYHUB</p>
    </div>
</div>

<!-- ================= TEMPLATES ================= -->

<template id="tpl-landing">
    <div class="hero">
        <svg class="nav-logo-svg" viewBox="0 0 24 24" fill="white" style="width:90px;height:90px;margin-bottom:20px; filter: drop-shadow(0 8px 15px rgba(0,0,0,0.2));">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/>
        </svg>
        <h1 style="color:white; font-size:2.8rem; margin-bottom:5px;">EatlyHub</h1>
        <p style="opacity:0.95; font-weight:500; margin-bottom:30px;">The Modern Standard for Food Entrepreneurs</p>
        <button class="btn" onclick="authLogin()" style="background:white; color:var(--primary); font-weight:800; border-radius:40px; max-width:320px; margin: 0 auto;">
            <svg style="width:20px;height:20px;vertical-align:middle;margin-right:12px;" viewBox="0 0 24 24"><path d="M12.545 10.239v3.821h5.445c-.712 2.315-2.647 3.972-5.445 3.972-3.332 0-6.033-2.531-6.033-5.97 0-3.438 2.701-5.97 6.033-5.97 1.414 0 2.675.525 3.636 1.35l2.802-2.818C17.396 2.922 15.115 1.761 12.545 1.761 6.615 1.761 1.76 6.345 1.76 12s4.855 10.239 10.785 10.239c6.234 0 10.39-4.313 10.39-10.239 0-.693-.061-1.373-.18-2.025l-10.21.264z"/></svg>
            Continue with Google
        </button>
    </div>

    <div class="container p-2">
        <div class="card">
            <h4>üè¢ For Establishments</h4>
            <p>Deploy digital menus for room service and table ordering instantly.</p>
        </div>

        <div class="card" style="border-left:6px solid var(--green);">
            <h4>üè° Home Kitchens</h4>
            <p>Turn your kitchen into a business. Accept professional orders via WhatsApp with a custom storefront link.</p>
        </div>
    </div>
    <div class="text-center p-2 text-red" style="font-size:0.8rem; opacity:0.6;">&copy; 2024 EatlyHub Technologies</div>
</template>

<template id="tpl-dashboard">
    <nav>
        <div class="nav-brand">
            <svg style="width:28px; height:28px; fill:var(--primary);" viewBox="0 0 24 24"><path d="M11 9H9V2H7v7H5V2H3v7c0 2.12 1.66 3.84 3.75 3.97V22h2.5v-9.03C11.34 12.84 13 11.12 13 9V2h-2v7zm5-3v8h2.5v8H21V2c-2.76 0-5 2.24-5 4z"/></svg>
            EatlyHub <span id="admin-tag" class="hidden" style="font-size:0.6rem; background:black; color:white; padding:2px 6px; border-radius:4px;">ADMIN</span>
        </div>
        <button class="btn btn-secondary" style="width:auto; padding:10px 18px; font-size:0.8rem; margin:0; border-radius:30px;" onclick="authLogout()">Logout</button>
    </nav>

    <div class="tabs-wrapper">
        <div class="tabs-container" id="dash-tabs"></div>
    </div>

    <div id="dash-content" class="p-2" style="padding-bottom: 100px; max-width:800px; margin:0 auto;"></div>
</template>

<!-- ================= JAVASCRIPT LOGIC ================= -->

<script>
    // --- 1. CONFIGURATION ---
    const ADMIN_EMAIL = "admin@eatlyhub.com"; 

    const firebaseConfig = {
      apiKey: "AIzaSyA4mlpgLA8l1N8VHqwpVLbPXvDvPxGPcSI",
      authDomain: "eatlyhub.firebaseapp.com",
      projectId: "eatlyhub",
      storageBucket: "eatlyhub.firebasestorage.app",
      messagingSenderId: "1094045089044",
      appId: "1:1094045089044:web:397e0fd73412a07c3ad601",
      measurementId: "G-V3K3QB1715"
    };

    // --- 2. INIT FIREBASE ---
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // --- 3. STATE ---
    const app = document.getElementById('app');
    let currentUser = null;
    let bizProfile = {};
    let bizOrders = [];
    let bizReviews = [];
    let adminRequests = [];
    let currentTab = 'Dashboard';

    const TABS = [
        'Dashboard', 'Profile', 'Open/Close', 'Add Foods', 'Storefront Link', 'Reviews',
        'New Orders', 'Confirmed', 'Active', 'Ready', 
        'Completed', 'Unpaid', 'Reports', 'Admin Support'
    ];

    const ADMIN_TABS = ['Verification Requests', 'Support Inbox'];

    // --- 4. IMAGE UTILITY ---
    function compressImage(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 600; 
                    const scale = MAX_WIDTH / img.width;
                    canvas.width = MAX_WIDTH;
                    canvas.height = img.height * scale;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    resolve(canvas.toDataURL('image/jpeg', 0.6)); 
                };
            };
        });
    }

    // --- 5. CORE ROUTING ---
    window.addEventListener('load', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const bizId = urlParams.get('biz');
        const orderId = urlParams.get('orderId');

        if (bizId && orderId) {
            loadCustomerConfirmPage(bizId, orderId);
        } else if (bizId) {
            loadPublicPage(bizId);
        } else {
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    user.email === ADMIN_EMAIL ? loadAdminDashboard() : loadDashboard();
                } else {
                    render('tpl-landing');
                }
            });
        }
    });

    function render(tplId) {
        app.innerHTML = '';
        const tpl = document.getElementById(tplId);
        if(tpl) app.appendChild(tpl.content.cloneNode(true));
    }

    // --- 6. AUTHENTICATION ---
    function authLogin() {
        auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(e => showToast(e.message, 'error'));
    }
    
    function authLogout() { auth.signOut().then(() => window.location.reload()); }

    // --- 7. ADMIN DASHBOARD ---
    function loadAdminDashboard() {
        render('tpl-dashboard');
        document.getElementById('admin-tag').classList.remove('hidden');
        const tabsContainer = document.getElementById('dash-tabs');
        tabsContainer.innerHTML = ADMIN_TABS.map(t => `<div class="tab-btn" onclick="switchAdminTab('${t}')">${t}</div>`).join('');
        db.collection('admin_requests').onSnapshot(snap => {
            adminRequests = snap.docs.map(d => ({id: d.id, ...d.data()}));
            refreshAdminContent();
        });
        switchAdminTab('Verification Requests');
    }

    function switchAdminTab(name) {
        currentTab = name;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.innerText === name));
        refreshAdminContent();
    }

    function refreshAdminContent() {
        const container = document.getElementById('dash-content');
        if(currentTab === 'Verification Requests') {
            container.innerHTML = adminRequests.length === 0 ? '<div class="card text-center">No pending requests</div>' : adminRequests.map(r => `
                <div class="card">
                    <h4>${r.name}</h4>
                    <div class="flex flex-col mt-1" style="gap:15px;">
                        <img src="${r.letter}" style="width:100%; border-radius:10px;">
                        <img src="${r.slip}" style="width:100%; border-radius:10px;">
                    </div>
                    <div class="flex mt-2" style="gap:10px;">
                        <button class="btn btn-green" onclick="approveUser('${r.uid}', '${r.id}')">Approve Verification</button>
                        <button class="btn btn-outline" style="color:red; border-color:red" onclick="rejectRequest('${r.id}')">Reject</button>
                    </div>
                </div>
            `).join('');
        }
    }

    function approveUser(uid, reqId) {
        db.collection('users').doc(uid).update({verified: true}).then(() => {
            db.collection('admin_requests').doc(reqId).delete();
            showToast("Verified Successfully");
        });
    }

    function rejectRequest(reqId) {
        if(confirm("Reject?")) db.collection('admin_requests').doc(reqId).delete();
    }

    // --- 8. USER DASHBOARD ---
    async function loadDashboard() {
        render('tpl-dashboard');
        const tabsContainer = document.getElementById('dash-tabs');
        tabsContainer.innerHTML = TABS.map(t => `<div class="tab-btn" onclick="switchTab('${t}')">${t}</div>`).join('');

        db.collection('users').doc(currentUser.uid).onSnapshot(doc => {
            if(doc.exists) {
                bizProfile = doc.data();
            } else {
                bizProfile = { locked: false, verified: false, foods: [], schedule: {} };
                db.collection('users').doc(currentUser.uid).set(bizProfile);
            }
            refreshTabContent(); 
        });

        db.collection('users').doc(currentUser.uid).collection('orders').orderBy('time', 'desc').onSnapshot(snap => {
            bizOrders = snap.docs.map(d => ({id: d.id, ...d.data()}));
            refreshTabContent();
        });
          
        db.collection('users').doc(currentUser.uid).collection('reviews').orderBy('time', 'desc').onSnapshot(snap => {
            bizReviews = snap.docs.map(d => ({id: d.id, ...d.data()}));
            refreshTabContent();
        });

        switchTab('Dashboard');
    }

    function switchTab(name) {
        if (name !== 'Dashboard' && name !== 'Profile' && name !== 'Admin Support' && (!bizProfile.locked)) {
            showToast("Please Lock your Profile first.", "error");
            name = 'Profile';
        }
        currentTab = name;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.innerText === name));
        const activeBtn = document.querySelector('.tab-btn.active');
        if(activeBtn) activeBtn.scrollIntoView({ behavior: 'smooth', inline: 'center' });
        refreshTabContent();
    }

    function refreshTabContent() {
        const container = document.getElementById('dash-content');
        if (!container) return;
        container.innerHTML = ''; 

        if(currentTab === 'Dashboard') renderDashHome(container);
        else if(currentTab === 'Profile') renderProfile(container);
        else if(currentTab === 'Open/Close') renderSchedule(container);
        else if(currentTab === 'Add Foods') renderAddFoods(container);
        else if(currentTab === 'Storefront Link') renderWebpageInfo(container);
        else if(currentTab === 'Reviews') renderReviews(container);
        else if(currentTab === 'Reports') renderReports(container);
        else if(currentTab === 'Admin Support') renderAdminChat(container);
        else renderOrdersList(container, currentTab);
    }

    // --- TAB RENDERERS ---

    function renderDashHome(target) {
        const newOrders = bizOrders.filter(o => o.status === 'new').length;
        const totalRev = bizOrders.filter(o => o.status === 'completed').reduce((a,b) => a + Number(b.total), 0);

        target.innerHTML = `
            <div class="card center flex-col">
                <img src="${bizProfile.logo || 'https://cdn-icons-png.flaticon.com/512/847/847969.png'}" style="width:110px;height:110px;border-radius:50%;object-fit:cover;margin-bottom:15px;border:4px solid var(--primary);">
                <h3>${bizProfile.businessName || 'Welcome to EatlyHub'}</h3>
                ${bizProfile.verified ? '<div class="status-badge st-new">‚úî Verified Partner</div>' : '<div class="status-badge st-unverified">Unverified</div>'}
            </div>

            <div class="flex" style="gap:15px; margin-bottom:20px;">
                <div class="card w-100 text-center" style="margin:0; background:var(--primary); color:white;" onclick="switchTab('New Orders')">
                    <h1 style="color:white; margin:0;">${newOrders}</h1>
                    <small style="color:white; opacity:0.8;">New Orders</small>
                </div>
                <div class="card w-100 text-center" style="margin:0;" onclick="switchTab('Reports')">
                    <h1 style="margin:0;">Rs. ${totalRev}</h1>
                    <small>Revenue</small>
                </div>
            </div>
            
            <div class="card">
                <h4>Order Search</h4>
                <div class="input-group">
                    <input type="text" placeholder="Enter Order Number" onkeyup="searchOrder(this.value)">
                    <div id="res-order" class="mt-1"></div>
                </div>
            </div>
        `;
    }

    function renderProfile(target) {
        const p = bizProfile;
        const locked = p.locked;
        target.innerHTML = `
            <div class="card">
                <h3>Business Identity</h3>
                <div class="center flex-col mb-1">
                    ${p.logo ? `<img src="${p.logo}" style="width:100px;height:100px;border-radius:50%;object-fit:cover;">` : ''}
                    ${!locked ? `<label class="btn btn-secondary mt-1" style="width:auto; padding:8px 15px;">Upload Logo <input type="file" hidden onchange="handleImageUpload(this, 'logo')"></label>` : ''}
                </div>
                <div class="input-group"><label>Business Name</label><input id="p-name" value="${p.businessName||''}" ${locked?'disabled':''}></div>
                <div class="input-group"><label>Physical Address</label><textarea id="p-addr" ${locked?'disabled':''}>${p.address||''}</textarea></div>
                <div class="input-group"><label>Owner's Legal Name</label><input id="p-owner" value="${p.ownerName||''}" ${locked?'disabled':''}></div>
                <div class="input-group"><label>NIC / Registration Number</label><input id="p-nic" value="${p.nic||''}" ${locked?'disabled':''}></div>
                <div class="input-group"><label>WhatsApp Number (Intl format e.g. 947...)</label><input type="tel" id="p-wa" value="${p.whatsapp||''}" ${locked?'disabled':''}></div>
                
                ${locked ? `<button class="btn btn-yellow" onclick="toggleLock(false)">Unlock to Edit</button>` : `<button class="btn btn-primary" onclick="saveProfile()">Save & Lock Identity</button>`}
            </div>

            <div class="card">
                <h3>Verification Badge</h3>
                ${p.verified ? '<p class="text-green bold">‚úÖ You are a Verified Seller</p>' : `
                    <p>Unlock consumer trust with the Green Badge (Rs. 2500 one-time).</p>
                    <div class="input-group"><label>Upload Grama Niladhari Letter</label><input type="file" onchange="handleImageUpload(this, 'letter')"></div>
                    <div class="input-group"><label>Upload Payment Slip (ComBank 8750053306)</label><input type="file" onchange="handleImageUpload(this, 'slip')"></div>
                    <button class="btn btn-green" onclick="requestVerification()">Submit for Review</button>
                `}
            </div>
        `;
    }

    async function handleImageUpload(input, type) {
        if (input.files[0]) {
            const base64 = await compressImage(input.files[0]);
            if(type === 'logo') {
                bizProfile.tempLogo = base64;
                renderProfile(document.getElementById('dash-content'));
            } else {
                bizProfile['temp_' + type] = base64;
                showToast("Image Uploaded locally");
            }
        }
    }

    function saveProfile() {
        const logo = bizProfile.tempLogo || bizProfile.logo;
        const name = document.getElementById('p-name').value;
        const wa = document.getElementById('p-wa').value;
        if(!logo || !name || !wa) return showToast("Logo, Name, and WhatsApp are required", "error");

        db.collection('users').doc(currentUser.uid).update({
            logo, businessName: name, address: document.getElementById('p-addr').value,
            ownerName: document.getElementById('p-owner').value, nic: document.getElementById('p-nic').value,
            whatsapp: wa, locked: true
        }).then(() => showToast("Identity Secured"));
    }

    function toggleLock(val) { db.collection('users').doc(currentUser.uid).update({locked: val}); }

    function requestVerification() {
        if(!bizProfile.temp_letter || !bizProfile.temp_slip) return showToast("Missing documents", "error");
        db.collection('admin_requests').add({
            uid: currentUser.uid, name: bizProfile.businessName,
            letter: bizProfile.temp_letter, slip: bizProfile.temp_slip, time: new Date()
        }).then(() => showToast("Request Sent"));
    }

    function renderSchedule(target) {
        const today = new Date().toLocaleDateString('en-US', {weekday:'long'});
        const s = bizProfile.schedule?.[today] || {open: true, start:'08:00', end:'21:00'};
        target.innerHTML = `
            <div class="card">
                <h3>Daily Schedule: ${today}</h3>
                <div class="input-group">
                    <label>Status</label>
                    <select id="oc-stat" onchange="saveSched('${today}')">
                        <option value="yes" ${s.open?'selected':''}>Accepting Orders</option>
                        <option value="no" ${!s.open?'selected':''}>Closed</option>
                    </select>
                </div>
                <div class="flex" style="gap:10px;">
                    <div class="input-group w-100"><label>Open</label><input type="time" id="oc-start" value="${s.start}" onchange="saveSched('${today}')"></div>
                    <div class="input-group w-100"><label>Close</label><input type="time" id="oc-end" value="${s.end}" onchange="saveSched('${today}')"></div>
                </div>
            </div>
        `;
    }

    function saveSched(day) {
        const schedule = bizProfile.schedule || {};
        schedule[day] = {
            open: document.getElementById('oc-stat').value === 'yes',
            start: document.getElementById('oc-start').value,
            end: document.getElementById('oc-end').value
        };
        db.collection('users').doc(currentUser.uid).update({schedule});
    }

    function renderAddFoods(target) {
        target.innerHTML = `
            <div class="card">
                <h3>Create Menu Item</h3>
                <div class="input-group"><label>Food Photo</label><input type="file" onchange="handleFoodImg(this)"></div>
                <div class="input-group"><label>Category</label><input id="f-cat" placeholder="e.g. Rice, Beverages"></div>
                <div class="input-group"><label>Name</label><input id="f-name"></div>
                <div class="flex" style="gap:10px;">
                    <div class="input-group w-100"><label>Half Price</label><input id="f-half" type="number"></div>
                    <div class="input-group w-100"><label>Full Price</label><input id="f-full" type="number"></div>
                </div>
                <button class="btn btn-primary" onclick="addFood()">Add to Storefront</button>
            </div>
            <h3>Menu Preview</h3>
            ${(bizProfile.foods||[]).map((f, i) => `
                <div class="card flex justify-between center p-1">
                    <img src="${f.img}" style="width:50px;height:50px;border-radius:8px;object-fit:cover;">
                    <div style="flex:1; margin-left:15px;"><b>${f.name}</b></div>
                    <button class="btn btn-secondary" style="width:auto; margin:0;" onclick="deleteFood(${i})">Delete</button>
                </div>
            `).join('')}
        `;
    }

    let tempFoodImg = null;
    async function handleFoodImg(input) { tempFoodImg = await compressImage(input.files[0]); }

    function addFood() {
        const name = document.getElementById('f-name').value;
        if(!name || !tempFoodImg) return showToast("Name and Photo required", "error");
        const foods = [...(bizProfile.foods||[]), {
            name, cat: document.getElementById('f-cat').value,
            half: document.getElementById('f-half').value,
            full: document.getElementById('f-full').value,
            img: tempFoodImg
        }];
        db.collection('users').doc(currentUser.uid).update({foods}).then(() => {
            tempFoodImg = null;
            showToast("Added");
        });
    }

    function deleteFood(idx) {
        const foods = bizProfile.foods.filter((_, i) => i !== idx);
        db.collection('users').doc(currentUser.uid).update({foods});
    }

    function renderWebpageInfo(target) {
        const url = `${window.location.origin}${window.location.pathname}?biz=${currentUser.uid}`;
        target.innerHTML = `
            <div class="card text-center">
                <h4>Your Digital Storefront</h4>
                <input class="w-100 p-2" value="${url}" readonly style="border:none; background:#eee; border-radius:10px;">
                <button class="btn btn-primary mt-1" onclick="window.open('${url}')">View Live Store</button>
            </div>
        `;
    }

    function renderReviews(target) {
        target.innerHTML = bizReviews.length === 0 ? '<p>No reviews yet.</p>' : bizReviews.map(r => `
            <div class="card">
                <div class="flex justify-between"><b>${r.name}</b><span>${'‚òÖ'.repeat(r.stars)}</span></div>
                <p>${r.text}</p>
                ${r.status === 'pending' ? `<button class="btn btn-green mt-1" onclick="approveReview('${r.id}')">Publish to Store</button>` : '<span class="text-green">Published</span>'}
            </div>
        `).join('');
    }

    function approveReview(id) {
        db.collection('users').doc(currentUser.uid).collection('reviews').doc(id).update({status: 'published'});
    }

    function renderOrdersList(target, tabName) {
        const statusMap = { 'New Orders': 'new', 'Confirmed': 'confirmed', 'Active': 'active', 'Ready': 'ready', 'Completed': 'completed', 'Unpaid': 'unpaid' };
        const s = statusMap[tabName];
        const list = bizOrders.filter(o => o.status === s);

        target.innerHTML = list.length === 0 ? '<p class="text-center mt-2">No orders in this category.</p>' : list.map(o => `
            <div class="card" style="border-left: 5px solid var(--primary);">
                <div class="flex justify-between"><h4>#${o.orderNum}</h4><small>${new Date(o.time).toLocaleTimeString()}</small></div>
                <p><b>${o.custName}</b> (${o.custWa})</p>
                <div style="background:#f9f9f9; padding:10px; border-radius:8px;">
                    ${o.items.map(i => `<div>${i.name} (${i.variant}) - Rs. ${i.price}</div>`).join('')}
                </div>
                <h3 class="text-right">Total: Rs. ${o.total}</h3>
                <div class="mt-1">
                    ${s === 'new' ? `<button class="btn btn-yellow" onclick="reqConfirm('${o.id}', '${o.custWa}')">Request Confirmation (WhatsApp)</button>` : ''}
                    ${s === 'confirmed' ? `<button class="btn btn-primary" onclick="setOrderStatus('${o.id}', 'active')">Move to Kitchen</button>` : ''}
                    ${s === 'active' ? `<button class="btn btn-green" onclick="setOrderStatus('${o.id}', 'ready')">Mark as Ready</button>` : ''}
                    ${s === 'ready' ? `<button class="btn btn-secondary" onclick="setOrderStatus('${o.id}', 'completed')">Complete Order</button>` : ''}
                </div>
            </div>
        `).join('');
    }

    function reqConfirm(id, wa) {
        const link = `${window.location.origin}${window.location.pathname}?biz=${currentUser.uid}&orderId=${id}`;
        window.open(`https://wa.me/${wa}?text=Please confirm your order here: ${link}`);
    }

    function setOrderStatus(id, status) {
        db.collection('users').doc(currentUser.uid).collection('orders').doc(id).update({status});
    }

    function renderReports(target) {
        const rev = bizOrders.filter(o => o.status === 'completed').reduce((a,b) => a + Number(b.total), 0);
        target.innerHTML = `
            <div class="card text-center">
                <small>Total Net Revenue</small>
                <h1 style="font-size:3rem;">Rs. ${rev}</h1>
            </div>
        `;
    }

    function renderAdminChat(target) {
        target.innerHTML = `<div class="card"><h3>Support</h3><p>Support is available 24/7 via WhatsApp: +94700000000</p></div>`;
    }

    function searchOrder(val) {
        const o = bizOrders.find(x => x.orderNum === val);
        document.getElementById('res-order').innerHTML = o ? `<p class="text-green">Status: ${o.status.toUpperCase()}</p>` : '<p>Not found</p>';
    }

    // --- 9. PUBLIC STOREFRONT ---
    let cart = [];
    async function loadPublicPage(bizId) {
        const doc = await db.collection('users').doc(bizId).get();
        if(!doc.exists) return app.innerHTML = "Store not found";
        const data = doc.data();
        
        const reviewSnap = await db.collection('users').doc(bizId).collection('reviews').where('status', '==', 'published').get();
        const reviews = reviewSnap.docs.map(d => d.data());

        app.innerHTML = `
            <div style="background:white; min-height:100vh;">
                <div class="hero" style="border-radius:0;">
                    <img src="${data.logo}" style="width:100px;height:100px;border-radius:50%;border:4px solid white; margin-bottom:15px; object-fit:cover;">
                    <h2>${data.businessName}</h2>
                    <p>${data.address}</p>
                </div>
                
                <div class="p-2 container" id="menu-items"></div>

                <div class="p-2" style="background:#f9f9f9;">
                    <h3>Guest Reviews</h3>
                    ${reviews.map(r => `<div class="card mb-1"><b>${r.name}</b><p>${r.text}</p></div>`).join('')}
                    <h4>Leave a Review</h4>
                    <input id="rv-name" class="w-100 p-1 mb-1" placeholder="Your Name">
                    <textarea id="rv-text" class="w-100 p-1 mb-1" placeholder="Experience"></textarea>
                    <button class="btn btn-primary" onclick="submitPubReview('${bizId}')">Submit Review</button>
                </div>

                <div class="floating-cart" onclick="showCartModal('${bizId}', '${data.whatsapp}')">üõí<div class="cart-badge" id="c-count">0</div></div>
            </div>
        `;

        const menu = document.getElementById('menu-items');
        data.foods.forEach(f => {
            menu.innerHTML += `
                <div class="card flex center">
                    <img src="${f.img}" style="width:70px;height:70px;border-radius:10px;object-fit:cover;">
                    <div style="flex:1; margin-left:15px;">
                        <b>${f.name}</b>
                        <div class="flex mt-1" style="gap:5px;">
                            ${f.half ? `<button class="btn btn-outline" style="padding:5px; margin:0; font-size:12px;" onclick="addToCart('${f.name}', 'Half', ${f.half})">Half: ${f.half}</button>` : ''}
                            ${f.full ? `<button class="btn btn-outline" style="padding:5px; margin:0; font-size:12px;" onclick="addToCart('${f.name}', 'Full', ${f.full})">Full: ${f.full}</button>` : ''}
                        </div>
                    </div>
                </div>
            `;
        });
    }

    function addToCart(name, variant, price) {
        cart.push({name, variant, price});
        document.getElementById('c-count').innerText = cart.length;
        showToast("Added to cart");
    }

    function showCartModal(bizId, bizWa) {
        if(cart.length === 0) return showToast("Cart empty", "error");
        const total = cart.reduce((a,b) => a + Number(b.price), 0);
        showModal(`
            <h3>Your Selection</h3>
            ${cart.map(i => `<div class="flex justify-between"><span>${i.name}</span><b>${i.price}</b></div>`).join('')}
            <hr>
            <div class="input-group"><label>Your Name</label><input id="cn"></div>
            <div class="input-group"><label>WhatsApp</label><input id="cw" type="tel"></div>
            <button class="btn btn-green" onclick="checkout('${bizId}', '${bizWa}', ${total})">Place Order via WhatsApp</button>
            <button class="btn btn-secondary" onclick="closeModal()">Back</button>
        `);
    }

    function checkout(bizId, bizWa, total) {
        const name = document.getElementById('cn').value;
        const wa = document.getElementById('cw').value;
        const orderNum = Math.floor(1000 + Math.random() * 9000);
        db.collection('users').doc(bizId).collection('orders').add({
            orderNum, custName: name, custWa: wa, items: cart, total, status: 'new', time: new Date().toISOString()
        }).then(() => {
            window.open(`https://wa.me/${bizWa}?text=New Order #${orderNum} from ${name}`);
            closeModal();
            cart = [];
            document.getElementById('c-count').innerText = '0';
        });
    }

    function submitPubReview(bizId) {
        const name = document.getElementById('rv-name').value;
        const text = document.getElementById('rv-text').value;
        db.collection('users').doc(bizId).collection('reviews').add({ name, text, stars: 5, status: 'pending', time: new Date().toISOString() });
        showToast("Review sent for approval");
    }

    // --- 10. CUSTOMER CONFIRMATION ---
    async function loadCustomerConfirmPage(bizId, orderId) {
        const doc = await db.collection('users').doc(bizId).collection('orders').doc(orderId).get();
        const o = doc.data();
        app.innerHTML = `
            <div class="center flex-col p-2" style="min-height:100vh;">
                <h1>Verify Order #${o.orderNum}</h1>
                <p>Total: Rs. ${o.total}</p>
                <button class="btn btn-green" onclick="finalConfirm('${bizId}', '${orderId}', 'confirmed')">Confirm Order</button>
                <button class="btn btn-secondary" onclick="finalConfirm('${bizId}', '${orderId}', 'canceled')">Cancel Order</button>
            </div>
        `;
    }

    function finalConfirm(bizId, orderId, status) {
        db.collection('users').doc(bizId).collection('orders').doc(orderId).update({status}).then(() => {
            app.innerHTML = `<div class="center flex-col" style="height:100vh;"><h1>Order ${status.toUpperCase()}</h1></div>`;
        });
    }

    // --- UTILS ---
    function showModal(content) {
        const div = document.createElement('div');
        div.className = 'modal-overlay';
        div.innerHTML = `<div class="modal-box">${content}</div>`;
        document.body.appendChild(div);
    }
    function closeModal() { document.querySelector('.modal-overlay').remove(); }
    function showToast(msg, type='success') {
        const t = document.createElement('div');
        t.innerText = msg;
        t.style = `position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:${type==='error'?'red':'#2ed573'}; color:white; padding:10px 20px; border-radius:20px; z-index:100000; font-weight:bold; box-shadow:0 5px 15px rgba(0,0,0,0.2);`;
        document.body.appendChild(t);
        setTimeout(() => t.remove(), 3000);
    }
</script>
</body>
</html>
